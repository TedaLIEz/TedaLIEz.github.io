<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>CanvasKit简介 | Aichi_B7A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="CanvasKit简介 编译原理 编译 编译产物浅析 编译脚本解析 小结   可应用场景 小结    CanvasKit简介CanvasKit是以WASM为编译目标的Web平台图形绘制接口，其目标是将Skia的图形API导出到Web平台。从代码提交记录来看，CanvasKit作为了一个Module放置在整个代码仓库中，最早的一次提交记录在2018年9月左右，是一个比较新的codebase 本文简">
<meta property="og:type" content="article">
<meta property="og:title" content="CanvasKit简介">
<meta property="og:url" content="https://tedaliez.github.io/2019/07/14/CanvasKit%E7%AE%80%E4%BB%8B/index.html">
<meta property="og:site_name" content="Aichi_B7A">
<meta property="og:description" content="CanvasKit简介 编译原理 编译 编译产物浅析 编译脚本解析 小结   可应用场景 小结    CanvasKit简介CanvasKit是以WASM为编译目标的Web平台图形绘制接口，其目标是将Skia的图形API导出到Web平台。从代码提交记录来看，CanvasKit作为了一个Module放置在整个代码仓库中，最早的一次提交记录在2018年9月左右，是一个比较新的codebase 本文简">
<meta property="og:locale">
<meta property="og:image" content="https://www.plantuml.com/plantuml/svg/xLJ1JeGm4BtlLpIST5SWgsSyUDU3nhCffK2nj4qxrRZ6VxU50ako6zYJ5pcGlk6zcVODKuKrC61I8DhkTkXxWznpjRr6SNoF8ivoyou164tm3UgGgS9IUINXr4oVQgoe3h36kipjuH0W8tRaCPpWg2laYsHPzh1thp4GnN7EH85QMLYNFYLOV62dWhIK0apw944-IY7ZPrfPZdK2K2P4gP3WZ7PSlNa24vLPren7l40J_5fK15vgWN6JllJerGElcDjpw-tf8WD2tgUnQFA9JJjAFETkC7GIzCugJUF6dDXt3ItlKRfD6XEIdQKhQG2tEQThk9gkfHOqjzKA7b5s1QjQnQefzx_jCf49eBh4PCr1Xh5fJ3HrRl_VY3zjnD4DusqxBN0U5Lzp-ZHeH-7Pc3diBitDpoy0">
<meta property="article:published_time" content="2019-07-14T02:08:57.000Z">
<meta property="article:modified_time" content="2019-07-14T02:12:25.989Z">
<meta property="article:author" content="Jian Guo">
<meta property="article:tag" content="WebAssembly">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.plantuml.com/plantuml/svg/xLJ1JeGm4BtlLpIST5SWgsSyUDU3nhCffK2nj4qxrRZ6VxU50ako6zYJ5pcGlk6zcVODKuKrC61I8DhkTkXxWznpjRr6SNoF8ivoyou164tm3UgGgS9IUINXr4oVQgoe3h36kipjuH0W8tRaCPpWg2laYsHPzh1thp4GnN7EH85QMLYNFYLOV62dWhIK0apw944-IY7ZPrfPZdK2K2P4gP3WZ7PSlNa24vLPren7l40J_5fK15vgWN6JllJerGElcDjpw-tf8WD2tgUnQFA9JJjAFETkC7GIzCugJUF6dDXt3ItlKRfD6XEIdQKhQG2tEQThk9gkfHOqjzKA7b5s1QjQnQefzx_jCf49eBh4PCr1Xh5fJ3HrRl_VY3zjnD4DusqxBN0U5Lzp-ZHeH-7Pc3diBitDpoy0">
  
    <link rel="alternate" href="/atom.xml" title="Aichi_B7A" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Aichi_B7A</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://tedaliez.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-CanvasKit简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/14/CanvasKit%E7%AE%80%E4%BB%8B/" class="article-date">
  <time datetime="2019-07-14T02:08:57.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      CanvasKit简介
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#CanvasKit%E7%AE%80%E4%BB%8B">CanvasKit简介</a><ul>
<li><a href="#%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86">编译原理</a><ul>
<li><a href="#%E7%BC%96%E8%AF%91">编译</a></li>
<li><a href="#%E7%BC%96%E8%AF%91%E4%BA%A7%E7%89%A9%E6%B5%85%E6%9E%90">编译产物浅析</a></li>
<li><a href="#%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90">编译脚本解析</a></li>
<li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
<li><a href="#%E5%8F%AF%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">可应用场景</a></li>
<li><a href="#%E5%B0%8F%E7%BB%93-1">小结</a></li>
</ul>
</li>
</ul>
<h1 id="CanvasKit简介"><a href="#CanvasKit简介" class="headerlink" title="CanvasKit简介"></a>CanvasKit简介</h1><p>CanvasKit是以WASM为编译目标的Web平台图形绘制接口，其目标是将Skia的图形API导出到Web平台。<br>从代码提交记录来看，CanvasKit作为了一个Module放置在整个代码仓库中，最早的一次提交记录在2018年9月左右，是一个比较新的codebase</p>
<p>本文简单介绍一下Skia是如何编译为Web平台的，其性能以及未来的可应用场景</p>
<h2 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h2><p>整个canvaskit模块的代码量非常少:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.gitignore</span><br><span class="line">CHANGELOG.md</span><br><span class="line">Makefile</span><br><span class="line">WasmAliases.h</span><br><span class="line">canvaskit/  发布代码，canvaskit介绍文档</span><br><span class="line">canvaskit_bindings.cpp</span><br><span class="line">compile.sh  编译脚本</span><br><span class="line">cpu.js</span><br><span class="line">debug.js</span><br><span class="line">externs.js</span><br><span class="line">fonts/  字体资源文件</span><br><span class="line">gpu.js</span><br><span class="line">helper.js</span><br><span class="line">htmlcanvas/</span><br><span class="line">interface.js</span><br><span class="line">karma.bench.conf.js</span><br><span class="line">karma.conf.js</span><br><span class="line">package.json</span><br><span class="line">particles_bindings.cpp</span><br><span class="line">perf/ 性能数据</span><br><span class="line">postamble.js</span><br><span class="line">preamble.js</span><br><span class="line">ready.js</span><br><span class="line">release.js</span><br><span class="line">serve.py</span><br><span class="line">skottie.js</span><br><span class="line">skottie_bindings.cpp</span><br><span class="line">tests/    测试代码</span><br></pre></td></tr></table></figure></p>
<p>整个模块我们可以看到其实没有修改包括任何skia的代码文件，只是在编译时指明了skia的源码依赖，同时写了一些胶水代码，从这里可以看出skia迁移至WASM并没有付出很多额外的改造工作。</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>设置好WASM工具链EmscriptenSDK的环境变量后运行compile.sh就会在<code>out</code>文件夹中得到<code>canvaskit.js</code>和<code>canvaskit.wasm</code>这两个编译产物，这里为了分析选择编译一个debug版本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./compile.sh debug</span><br></pre></td></tr></table></figure>
<p>debug版本会得到一个未混淆的canvaskit.js，方便我们分析其实现</p>
<h3 id="编译产物浅析"><a href="#编译产物浅析" class="headerlink" title="编译产物浅析"></a>编译产物浅析</h3><p>为了快速了解整个模块的情况，直接观察canvaskit.js和canvaskit.wasm文件，先来看下canvaskit.js<br>js代码量比较大，这里摘取一段最能展示其运行原理的代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeWebGLContext</span>(<span class="params">canvas, attrs</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// These defaults come from the emscripten _emscripten_webgl_create_context</span></span><br><span class="line">    <span class="keyword">var</span> contextAttributes = &#123;</span><br><span class="line">    alpha: <span class="keyword">get</span>(attrs, 'alpha', 1),</span><br><span class="line">    depth: <span class="keyword">get</span>(attrs, 'depth', 1),</span><br><span class="line">    stencil: <span class="keyword">get</span>(attrs, 'stencil', 0),</span><br><span class="line">    antialias: <span class="keyword">get</span>(attrs, 'antialias', 1),</span><br><span class="line">    premultipliedAlpha: <span class="keyword">get</span>(attrs, 'premultipliedAlpha', 1),</span><br><span class="line">    preserveDrawingBuffer: <span class="keyword">get</span>(attrs, 'preserveDrawingBuffer', 0),</span><br><span class="line">    preferLowPowerToHighPerformance: <span class="keyword">get</span>(attrs, 'preferLowPowerToHighPerformance', 0),</span><br><span class="line">    failIfMajorPerformanceCaveat: <span class="keyword">get</span>(attrs, 'failIfMajorPerformanceCaveat', 0),</span><br><span class="line">    majorVersion: <span class="keyword">get</span>(attrs, 'majorVersion', 1),</span><br><span class="line">    minorVersion: <span class="keyword">get</span>(attrs, 'minorVersion', 0),</span><br><span class="line">    enableExtensionsByDefault: <span class="keyword">get</span>(attrs, 'enableExtensionsByDefault', 1),</span><br><span class="line">    explicitSwapControl: <span class="keyword">get</span>(attrs, 'explicitSwapControl', 0),</span><br><span class="line">    renderViaOffscreenBackBuffer: <span class="keyword">get</span>(attrs, 'renderViaOffscreenBackBuffer', 0),</span><br><span class="line">    &#125;;</span><br><span class="line">    if (!canvas) &#123;</span><br><span class="line">    SkDebug(<span class="string">'null canvas passed into makeWebGLContext'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// This check is from the emscripten version</span></span><br><span class="line">    <span class="keyword">if</span> (contextAttributes[<span class="string">'explicitSwapControl'</span>]) &#123;</span><br><span class="line">    SkDebug(<span class="string">'explicitSwapControl is not supported'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// GL is an enscripten provided helper</span></span><br><span class="line"><span class="comment">// See https://github.com/emscripten-core/emscripten/blob/incoming/src/library_webgl.js</span></span><br><span class="line"><span class="keyword">return</span> GL.createContext(canvas, contextAttributes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CanvasKit.GetWebGLContext = <span class="function"><span class="keyword">function</span>(<span class="params">canvas, attrs</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> makeWebGLContext(canvas, attrs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> GL= &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    init:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        GL.miniTempBuffer = <span class="keyword">new</span> <span class="built_in">Float32Array</span>(GL.MINI_TEMP_BUFFER_SIZE);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; GL.MINI_TEMP_BUFFER_SIZE; i++) &#123;</span><br><span class="line">          GL.miniTempBufferViews[i] = GL.miniTempBuffer.subarray(<span class="number">0</span>, i+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      createContext:<span class="function"><span class="keyword">function</span> (<span class="params">canvas, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ctx = (canvas.getContext(<span class="string">"webgl"</span>, webGLContextAttributes)</span><br><span class="line">            || canvas.getContext(<span class="string">"experimental-webgl"</span>, webGLContextAttributes));</span><br><span class="line">        <span class="keyword">return</span> ctx &amp;&amp; GL.registerContext(ctx, webGLContextAttributes);</span><br><span class="line">      &#125;,<span class="attr">registerContext</span>:<span class="function"><span class="keyword">function</span> (<span class="params">ctx, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> handle = _malloc(<span class="number">8</span>); <span class="comment">// Make space on the heap to store GL context attributes that need to be accessible as shared between threads.</span></span><br><span class="line">        assert(handle, <span class="string">'malloc() failed in GL.registerContext!'</span>);</span><br><span class="line">        <span class="keyword">var</span> context = &#123;</span><br><span class="line">          handle: handle,</span><br><span class="line">          attributes: webGLContextAttributes,</span><br><span class="line">          version: webGLContextAttributes.majorVersion,</span><br><span class="line">          GLctx: ctx</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// Store the created context object so that we can access the context given a canvas without having to pass the parameters again.</span></span><br><span class="line">        <span class="keyword">if</span> (ctx.canvas) ctx.canvas.GLctxObject = context;</span><br><span class="line">        GL.contexts[handle] = context;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> webGLContextAttributes.enableExtensionsByDefault === <span class="string">'undefined'</span> || webGLContextAttributes.enableExtensionsByDefault) &#123;</span><br><span class="line">          GL.initExtensions(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handle;</span><br><span class="line">      &#125;,<span class="attr">makeContextCurrent</span>:<span class="function"><span class="keyword">function</span> (<span class="params">contextHandle</span>) </span>&#123;</span><br><span class="line">        GL.currentContext = GL.contexts[contextHandle]; <span class="comment">// Active Emscripten GL layer context object.</span></span><br><span class="line">        Module.ctx = GLctx = GL.currentContext &amp;&amp; GL.currentContext.GLctx; <span class="comment">// Active WebGL context object.</span></span><br><span class="line">        <span class="keyword">return</span> !(contextHandle &amp;&amp; !GLctx);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码中出现了大量的WebGL指令和2d的绘制js代码，其实这一块就是EmscriptenSDK对OpenGL的胶水代码(<a href="https://emscripten.org/docs/porting/multimedia_and_graphics/OpenGL-support.html)" target="_blank" rel="noopener">https://emscripten.org/docs/porting/multimedia_and_graphics/OpenGL-support.html)</a>, 换言之，canvaskit的绘制代码没有脱离浏览器提供的webgl和context2d的相关接口，毕竟这也是目前在浏览器进行绘制操作的唯一途径</p>
<p>那编译的wasm文件做了啥呢？简单看一下对应wasm的一部分代码, 这也是一个比较庞大的文件，我们只关注一下wasm和js连接的桥梁代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(import &quot;env&quot; &quot;_eglGetCurrentDisplay&quot; (func $_eglGetCurrentDisplay (result i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_eglGetProcAddress&quot; (func $_eglGetProcAddress (param i32) (result i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_eglQueryString&quot; (func $_eglQueryString (param i32 i32) (result i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glActiveTexture&quot; (func $_emscripten_glActiveTexture (param i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glAttachShader&quot; (func $_emscripten_glAttachShader (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBeginQueryEXT&quot; (func $_emscripten_glBeginQueryEXT (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindAttribLocation&quot; (func $_emscripten_glBindAttribLocation (param i32 i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindBuffer&quot; (func $_emscripten_glBindBuffer (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindFramebuffer&quot; (func $_emscripten_glBindFramebuffer (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindRenderbuffer&quot; (func $_emscripten_glBindRenderbuffer (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindTexture&quot; (func $_emscripten_glBindTexture (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glClear&quot; (func $_emscripten_glClear (param i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glClearColor&quot; (func $_emscripten_glClearColor (param f64 f64 f64 f64)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glClearDepthf&quot; (func $_emscripten_glClearDepthf (param f64)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glCompileShader&quot; (func $_emscripten_glCompileShader (param i32)))</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里省略了一部分，但是仍然可以看出，wasm对绘制的支持全部依赖其运行环境中js注入的函数实现</p>
<p>以这里的<code>_emscripten_glBindTexture</code>函数为例，对应到js为:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> asmGlobalArg = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> asmLibraryArg = &#123;</span><br><span class="line">    <span class="string">"_emscripten_glBindTexture"</span>: _emscripten_glBindTexture <span class="comment">// .... 上文wasm中的函数注册，这里略去，只保留_emscripten_glBindTexture</span></span><br><span class="line">&#125;</span><br><span class="line">Module[<span class="string">'asm'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">global, env, providedBuffer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// memory was already allocated (so js could use the buffer)</span></span><br><span class="line">    env[<span class="string">'memory'</span>] = wasmMemory</span><br><span class="line">    ;</span><br><span class="line">    <span class="comment">// import table</span></span><br><span class="line">    env[<span class="string">'table'</span>] = wasmTable = <span class="keyword">new</span> WebAssembly.Table(&#123;</span><br><span class="line">    <span class="string">'initial'</span>: <span class="number">1155075</span>,</span><br><span class="line">    <span class="string">'maximum'</span>: <span class="number">1155075</span>,</span><br><span class="line">    <span class="string">'element'</span>: <span class="string">'anyfunc'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    env[<span class="string">'__memory_base'</span>] = <span class="number">1024</span>; <span class="comment">// tell the memory segments where to place themselves</span></span><br><span class="line">    env[<span class="string">'__table_base'</span>] = <span class="number">0</span>; <span class="comment">// table starts at 0 by default (even in dynamic linking, for the main module)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> exports = createWasm(env);   <span class="comment">// 加载WASM对象, env即WASM对象加载时所需要的上下文，包括内存大小，函数表，和堆栈起始地址</span></span><br><span class="line">    assert(exports, <span class="string">'binaryen setup failed (no wasm support?)'</span>);</span><br><span class="line">    <span class="keyword">return</span> exports;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// EMSCRIPTEN_START_ASM</span></span><br><span class="line"><span class="keyword">var</span> asm =Module[<span class="string">"asm"</span>]<span class="comment">// EMSCRIPTEN_END_ASM</span></span><br><span class="line">(asmGlobalArg, asmLibraryArg, buffer);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_emscripten_glBindTexture</span>(<span class="params">target, texture</span>) </span>&#123;</span><br><span class="line">    GL.validateGLObjectID(GL.textures, texture, <span class="string">'glBindTexture'</span>, <span class="string">'texture'</span>);</span><br><span class="line">    GLctx.bindTexture(target, GL.textures[texture]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GLctx通过代码我们也能找到对应:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">createContext:<span class="function"><span class="keyword">function</span> (<span class="params">canvas, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ctx = (canvas.getContext(<span class="string">"webgl"</span>, webGLContextAttributes)</span><br><span class="line">        || canvas.getContext(<span class="string">"experimental-webgl"</span>, webGLContextAttributes));</span><br><span class="line">    <span class="keyword">return</span> ctx &amp;&amp; GL.registerContext(ctx, webGLContextAttributes);</span><br><span class="line">&#125;,<span class="attr">registerContext</span>:<span class="function"><span class="keyword">function</span> (<span class="params">ctx, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> handle = _malloc(<span class="number">8</span>); <span class="comment">// Make space on the heap to store GL context attributes that need to be accessible as shared between threads.</span></span><br><span class="line">assert(handle, <span class="string">'malloc() failed in GL.registerContext!'</span>);</span><br><span class="line"><span class="keyword">var</span> context = &#123;</span><br><span class="line">    handle: handle,</span><br><span class="line">    attributes: webGLContextAttributes,</span><br><span class="line">    version: webGLContextAttributes.majorVersion,</span><br><span class="line">    GLctx: ctx </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Store the created context object so that we can access the context given a canvas without having to pass the parameters again.</span></span><br><span class="line"><span class="keyword">if</span> (ctx.canvas) ctx.canvas.GLctxObject = context;</span><br><span class="line">GL.contexts[handle] = context;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> webGLContextAttributes.enableExtensionsByDefault === <span class="string">'undefined'</span> || webGLContextAttributes.enableExtensionsByDefault) &#123;</span><br><span class="line">    GL.initExtensions(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> handle;</span><br><span class="line">&#125;,<span class="attr">makeContextCurrent</span>:<span class="function"><span class="keyword">function</span> (<span class="params">contextHandle</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">    GL.currentContext = GL.contexts[contextHandle]; <span class="comment">// Active Emscripten GL layer context object.</span></span><br><span class="line">    Module.ctx = GLctx = GL.currentContext &amp;&amp; GL.currentContext.GLctx; <span class="comment">// Active WebGL context object.  // GLCtx变量</span></span><br><span class="line">    <span class="keyword">return</span> !(contextHandle &amp;&amp; !GLctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这里的bindTexture实际上就是WebGL的bindTexture指令(<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/bindTexture#Syntax" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/bindTexture#Syntax</a>)</p>
<p>分析到这里，我们可以得到一个基本结论: <strong>canvaskit中绘制的实现全部在canvaskit.js中调用浏览器绘制API来实现，而计算相关的内容全部放在了wasm中实现</strong></p>
<h3 id="编译脚本解析"><a href="#编译脚本解析" class="headerlink" title="编译脚本解析"></a>编译脚本解析</h3><p>通过对编译产物的分析，我们可以发现canvaskit绝大部分的绘制都是借助了Web API中的2d或webgl绘制API来完成的。这里需要分析的是canvaskit如何搭建了skia原生绘制代码和浏览器绘制API的桥梁。</p>
<p>看到compile.sh发现最后一句话涉及到很多canvaskit目录下的文件，因此直接结合编译日志的相关内容分析。</p>
<p>其他的日志都是常规的skia编译命令，只不过执行程序换成了em++而已，em++就是EmscriptenSDK中的编译器命令，可以类比为g++，这些命令会把skia编译为几个静态库</p>
<p>我们略过之前的skia编译命令来到最后一段，这是真正生成WASM产物的地方，其中有大量的逻辑是涉及到canvaskit中的胶水代码的。略去链接, 编译器优化设置, Skia静态库路径的指定, Skia宏定义和头文件路径指定，我们将会得到:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/Users/JianGuo/VSCodeProject/emsdk/emscripten/1.38.28/em++  \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/debug.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/cpu.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/gpu.js \</span><br><span class="line">--bind \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/preamble.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/helper.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/interface.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/skottie.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/preamble.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/util.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/color.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/font.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/canvas2dcontext.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/htmlcanvas.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/imagedata.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/lineargradient.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/path2d.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/pattern.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/radialgradient.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/postamble.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/postamble.js \</span><br><span class="line">--post-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/ready.js \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/fonts/NotoMono-Regular.ttf.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/canvaskit_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/particles_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/skottie_bindings.cpp \</span><br><span class="line">modules/skottie/utils/SkottieUtils.cpp \</span><br><span class="line">-s ALLOW_MEMORY_GROWTH=1 \ # 允许申请比TOTAL_MEMORY更大的内存</span><br><span class="line">-s EXPORT_NAME=CanvasKitInit \ # js中Module的名字</span><br><span class="line">-s FORCE_FILESYSTEM=0 \ # 开启文件系统支持，用于js中对native的文件系统进行模拟</span><br><span class="line">-s MODULARIZE=1 \ #启用Module的方式生成js，开启后编译的js产物将拥有一个Module作用域，而非全局作用域</span><br><span class="line">-s NO_EXIT_RUNTIME=1 \ # 禁止使用exit函数</span><br><span class="line">-s STRICT=1 \ # 确保编译器不使用弃用语法</span><br><span class="line">-s TOTAL_MEMORY=128MB \ # WASM分配的总内存，如果比此内存更大的场景就需要扩展堆大小</span><br><span class="line">-s USE_FREETYPE=1 \ # 使用emscripten-ports导出的freetype库</span><br><span class="line">-s USE_LIBPNG=1 \ # 使用emscripten-ports导出的libpng库</span><br><span class="line">-s WARN_UNALIGNED=1 \ # 编译时警告未对齐(align)</span><br><span class="line">-s USE_WEBGL2=0 \ # 不使用WebGL2</span><br><span class="line">-s WASM=1 \ # 编译为WASM</span><br><span class="line">-o out/canvaskit_wasm_debug/canvaskit.js # 指定编译路径</span><br></pre></td></tr></table></figure>
<p>其中，<code>pre-js &lt;file&gt;</code>表示将指定文件的内容插入到生成的js文件前, <code>post-js</code>表示将指定文件的内容插入到生成的js文件后，我们以<code>skia/modules/canvaskit/htmlcanvas/htmlcanvas.js</code>为例，看看这些插入的文件都干了啥:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">CanvasKit.MakeCanvas = <span class="function"><span class="keyword">function</span>(<span class="params">width, height</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> surf = CanvasKit.MakeSurface(width, height);</span><br><span class="line">  <span class="keyword">if</span> (surf) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HTMLCanvas(surf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HTMLCanvas</span>(<span class="params">skSurface</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._surface = skSurface;</span><br><span class="line">  <span class="keyword">this</span>._context = <span class="keyword">new</span> CanvasRenderingContext2D(skSurface.getCanvas());</span><br><span class="line">  <span class="keyword">this</span>._toCleanup = [];</span><br><span class="line">  <span class="keyword">this</span>._fontmgr = CanvasKit.SkFontMgr.RefDefault();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Data is either an ArrayBuffer, a TypedArray, or a Node Buffer</span></span><br><span class="line">  <span class="keyword">this</span>.decodeImage = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.loadFont = <span class="function"><span class="keyword">function</span>(<span class="params">buffer, descriptors</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.makePath2D = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A normal &lt;canvas&gt; requires that clients call getContext</span></span><br><span class="line">  <span class="keyword">this</span>.getContext = <span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.toDataURL = <span class="function"><span class="keyword">function</span>(<span class="params">codec, quality</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.dispose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是对齐了一下浏览器实现，同时对齐了一下Skia内部的接口而已。<br>最后我们还剩下一段没有分析:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/Users/JianGuo/VSCodeProject/emsdk/emscripten/1.38.28/em++  \</span><br><span class="line">...</span><br><span class="line">--bind \</span><br><span class="line">...</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/fonts/NotoMono-Regular.ttf.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/canvaskit_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/particles_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/skottie_bindings.cpp \</span><br><span class="line">modules/skottie/utils/SkottieUtils.cpp \</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>根据文档，这段命令要求em++以Embind(<a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/embind.html#embind)连接C++代码和JS代码" target="_blank" rel="noopener">https://emscripten.org/docs/porting/connecting_cpp_and_javascript/embind.html#embind)连接C++代码和JS代码</a>, embind简单来说就是emscriptenSDK提供的将C/C++代码暴露给JavaScript的便捷能力。这里不做重点介绍，我们直接看canvaskit用到的一个代码:</p>
<p><code>particles_bindings.cpp</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;emscripten.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;emscripten/bind.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> emscripten;</span><br><span class="line"></span><br><span class="line">EMSCRIPTEN_BINDINGS(Particles) &#123;</span><br><span class="line">    class_&lt;SkParticleEffect&gt;(<span class="string">"SkParticleEffect"</span>)</span><br><span class="line">        .smart_ptr&lt;sk_sp&lt;SkParticleEffect&gt;&gt;(<span class="string">"sk_sp&lt;SkParticleEffect&gt;"</span>)</span><br><span class="line">        .function(<span class="string">"draw"</span>, &amp;SkParticleEffect::draw, allow_raw_pointers())</span><br><span class="line">        .function(<span class="string">"start"</span>, select_overload&lt;<span class="keyword">void</span> (<span class="keyword">double</span>, <span class="keyword">bool</span>)&gt;(&amp;SkParticleEffect::start))</span><br><span class="line">        .function(<span class="string">"update"</span>, select_overload&lt;<span class="keyword">void</span> (<span class="keyword">double</span>)&gt;(&amp;SkParticleEffect::update));</span><br><span class="line"></span><br><span class="line">    function(<span class="string">"MakeParticles"</span>, optional_override([](<span class="built_in">std</span>::<span class="built_in">string</span> json)-&gt;sk_sp&lt;SkParticleEffect&gt; &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">bool</span> didInit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!didInit) &#123;</span><br><span class="line">            REGISTER_REFLECTED(SkReflected);</span><br><span class="line">            SkParticleAffector::RegisterAffectorTypes();</span><br><span class="line">            SkParticleDrawable::RegisterDrawableTypes();</span><br><span class="line">            didInit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SkRandom r;</span><br><span class="line">        sk_sp&lt;SkParticleEffectParams&gt; params(<span class="keyword">new</span> SkParticleEffectParams());</span><br><span class="line">        skjson::DOM dom(json.c_str(), json.length());</span><br><span class="line">        SkFromJsonVisitor fromJson(dom.root());</span><br><span class="line">        params-&gt;visitFields(&amp;fromJson);</span><br><span class="line">        <span class="keyword">return</span> sk_sp&lt;SkParticleEffect&gt;(<span class="keyword">new</span> SkParticleEffect(<span class="built_in">std</span>::move(params), r));</span><br><span class="line">    &#125;));</span><br><span class="line">    constant(<span class="string">"particles"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码经过em++编译后会直接将其功能内嵌进wasm文件中。至此，整个编译流程就分析完了</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这里用一张图来总结一下整个canvaskit的编译流程, 图中省去了编译器优化和js优化的流程:</p>
<p><img src="https://www.plantuml.com/plantuml/svg/xLJ1JeGm4BtlLpIST5SWgsSyUDU3nhCffK2nj4qxrRZ6VxU50ako6zYJ5pcGlk6zcVODKuKrC61I8DhkTkXxWznpjRr6SNoF8ivoyou164tm3UgGgS9IUINXr4oVQgoe3h36kipjuH0W8tRaCPpWg2laYsHPzh1thp4GnN7EH85QMLYNFYLOV62dWhIK0apw944-IY7ZPrfPZdK2K2P4gP3WZ7PSlNa24vLPren7l40J_5fK15vgWN6JllJerGElcDjpw-tf8WD2tgUnQFA9JJjAFETkC7GIzCugJUF6dDXt3ItlKRfD6XEIdQKhQG2tEQThk9gkfHOqjzKA7b5s1QjQnQefzx_jCf49eBh4PCr1Xh5fJ3HrRl_VY3zjnD4DusqxBN0U5Lzp-ZHeH-7Pc3diBitDpoy0"></p>
<h2 id="可应用场景"><a href="#可应用场景" class="headerlink" title="可应用场景"></a>可应用场景</h2><p>根据官方文档(<a href="https://skia.org/user/modules/canvaskit)" target="_blank" rel="noopener">https://skia.org/user/modules/canvaskit)</a>, canvaskit基于skia的API设计向web平台提供了更加方便的图形接口，可以说起到了类似GLWrapper的作用。</p>
<p>得益于Skia本身的其他扩展功能，canvaskit相比于浏览器原生绘制能力，支持了许多更加上层的业务级别功能，例如skia的动画模块skottie(<a href="https://skia.org/user/modules/skottie" target="_blank" rel="noopener">https://skia.org/user/modules/skottie</a>)</p>
<p>Skia中的skottie本身就支持Lottie动画解析和播放，由于Skia良好的跨平台能力，Android和iOS平台现在均可以使用Skia框架来播放Lottie动画，canvaskit则运用WebAssembly的技术来将跨平台的范围扩展到web上，使得web平台可以通过canvaskit的skottie相关接口直接播放lottie动画</p>
<p>对于Web应用而言，canvaskit提供了开发者更加友好的图形接口，并提供了常见的图形概念（例如Bitmap，Path等），减少了上层应用开发者对于绘制接口的理解负担，开发者只需要理解Skia的图形概念即可开发图形界面，有了skia他们也不需要理解复杂的webgl指令。</p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>得益于WASM的理念和EmscriptenSDK的能力，越来越多的native库可以直接导出web上供开发者使用。CanvasKit可以说是C++ Library向Web平台迁移的又一最佳实践。EmscriptenSDK已经做到将Skia这种规模的C++项目以WASM的方式迁移至Web平台，并保证其代码功能的一致性。整个迁移的过程的代价也就是编译工具链的替换和一部分胶水代码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/07/14/CanvasKit%E7%AE%80%E4%BB%8B/" data-id="ckgx4rr6y0005i8x71uin6k2m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebAssembly/" rel="tag">WebAssembly</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/09/28/%E5%B7%A5%E7%A8%8B%E6%95%88%E7%8E%87%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          工程效率的一些思考
        
      </div>
    </a>
  
  
    <a href="/2019/06/29/APT%E6%8F%92%E4%BB%B6%E5%AE%9E%E6%88%98/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">APT插件实战</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-ROOM/" rel="tag">Android, ROOM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NDK/" rel="tag">NDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebView-JSBridge/" rel="tag">WebView, JSBridge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-jetpack-compose/" rel="tag">android, jetpack compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-mmkv/" rel="tag">android, mmkv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-textview/" rel="tag">android, textview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-coroutine/" rel="tag">kotlin, coroutine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-%E5%8D%8F%E7%A8%8B/" rel="tag">kotlin, 协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v8-WebAssembly/" rel="tag">v8, WebAssembly</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android-ROOM/" style="font-size: 10px;">Android, ROOM</a> <a href="/tags/NDK/" style="font-size: 10px;">NDK</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/WebAssembly/" style="font-size: 15px;">WebAssembly</a> <a href="/tags/WebView-JSBridge/" style="font-size: 10px;">WebView, JSBridge</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/android-jetpack-compose/" style="font-size: 10px;">android, jetpack compose</a> <a href="/tags/android-mmkv/" style="font-size: 20px;">android, mmkv</a> <a href="/tags/android-textview/" style="font-size: 10px;">android, textview</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/kotlin-coroutine/" style="font-size: 10px;">kotlin, coroutine</a> <a href="/tags/kotlin-%E5%8D%8F%E7%A8%8B/" style="font-size: 10px;">kotlin, 协程</a> <a href="/tags/v8-WebAssembly/" style="font-size: 10px;">v8, WebAssembly</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/13/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5/">FFMpeg-Android开发-简单音视频同步</a>
          </li>
        
          <li>
            <a href="/2020/09/12/Kotlin%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">Kotlin协程异常处理</a>
          </li>
        
          <li>
            <a href="/2020/08/29/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E6%92%AD%E6%94%BE%E9%9F%B3%E9%A2%91/">FFMpeg-Android开发-简单播放音频</a>
          </li>
        
          <li>
            <a href="/2020/08/23/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E6%92%AD%E6%94%BE%E8%A7%86%E9%A2%91/">FFMpeg-Android开发-简单播放视频</a>
          </li>
        
          <li>
            <a href="/2020/08/22/FFMpeg-Android%E5%BC%80%E5%8F%91-%E8%A7%A3%E6%9E%90%E8%A7%86%E9%A2%91%E6%A0%BC%E5%BC%8F/">FFMpeg-Android开发-解析视频格式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Jian Guo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>