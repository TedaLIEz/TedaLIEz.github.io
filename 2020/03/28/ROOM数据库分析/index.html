<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>ROOM数据库分析 | Aichi_B7A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="以 2.1.0 版本源码简单分析下 ROOM，主要针对一些自己的困惑做一些记录 为了本文行文方便, 本文的分析全部基于以下的简单的 DB 构造 123456789101112131415161718@Database(entities &#x3D; &amp;#123;Config.class&amp;#125;, version &#x3D; 0)public abstract class AppDatabase extends">
<meta property="og:type" content="article">
<meta property="og:title" content="ROOM数据库分析">
<meta property="og:url" content="https://tedaliez.github.io/2020/03/28/ROOM%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Aichi_B7A">
<meta property="og:description" content="以 2.1.0 版本源码简单分析下 ROOM，主要针对一些自己的困惑做一些记录 为了本文行文方便, 本文的分析全部基于以下的简单的 DB 构造 123456789101112131415161718@Database(entities &#x3D; &amp;#123;Config.class&amp;#125;, version &#x3D; 0)public abstract class AppDatabase extends">
<meta property="og:locale">
<meta property="article:published_time" content="2020-03-28T15:08:43.000Z">
<meta property="article:modified_time" content="2020-03-28T15:09:09.230Z">
<meta property="article:author" content="Jian Guo">
<meta property="article:tag" content="Android, ROOM">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Aichi_B7A" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Aichi_B7A</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://tedaliez.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-ROOM数据库分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/28/ROOM%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2020-03-28T15:08:43.000Z" itemprop="datePublished">2020-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ROOM数据库分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以 2.1.0 版本源码简单分析下 ROOM，主要针对一些自己的困惑做一些记录</p>
<p>为了本文行文方便, 本文的分析全部基于以下的简单的 DB 构造</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = &#123;Config.class&#125;, version = 0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDatabase</span> <span class="title">extends</span> <span class="title">RoomDatabase</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity(tableName = <span class="meta-string">"config"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span> <span class="meta">@Ignore</span> <span class="keyword">constructor</span></span>(<span class="meta">@ColumnInfo(name = <span class="meta-string">"name"</span>)</span> <span class="keyword">var</span> name: String?, <span class="meta">@ColumnInfo(name = <span class="meta-string">"value"</span>)</span> <span class="keyword">var</span> value: String?) &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() : <span class="keyword">this</span>(<span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PrimaryKey(autoGenerate = true)</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(config: <span class="type">Config</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ROOM-的线程安全是如何保证的"><a href="#ROOM-的线程安全是如何保证的" class="headerlink" title="ROOM 的线程安全是如何保证的"></a>ROOM 的线程安全是如何保证的</h2><h3 id="先验知识-Transaction-和-Rollback-Journals"><a href="#先验知识-Transaction-和-Rollback-Journals" class="headerlink" title="先验知识: Transaction 和 Rollback Journals"></a>先验知识: Transaction 和 Rollback Journals</h3><p>sqlite 支持通过 transaction 模式来提交事务，一个典型的调用模式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    db.setTransactionSuccessful();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    db.endTransaction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能这里就会有 Error 出现，那么就有可能会 skip<code>db.setTransactionSuccessful()</code>, 而直接调用<code>db.endTransaction()</code>，根据 Android 文档说明</p>
<pre><code>The changes will be rolled back if any transaction is ended without being marked as clean (by calling setTransactionSuccessful). Otherwise they will be committed.
</code></pre><p>也就是说 setTransactionSuccessful()未调用则执行 rollback，这里的 rollback 即 sqlite 的 rollback 策略，需要了解下 sqlite 的 rollback 策略</p>
<ol>
<li>回滚日志档 (Rollback Journal)：<br>先将源文件备份至 Rollback Journal 中，再将要变动的内容直接写入 DB。当需要 rollback 时，再将原内容从 Rollback Journal 写回 DB；若要 commit 变更时，则只要将该档案刪除即可。<br>而 rollback 的日志模式又可细分为 4 种：DELETE (SQLite 预设)、TRUNCATE (Android 版 SQLite 预设值)、PERSIST、MEMORY</li>
</ol>
<p>TRUNCATE 这个模式就是 ROOM 在非 WAL 模式下的默认设置，即 Rollback Journal 总是清空，而非删除</p>
<p>这种模式下的文件目录为一个<code>db</code>文件+一个<code>db-journal</code>文件</p>
<ol start="2">
<li>WAL (Write-Ahead Log)：<br>作法与 Rollback Journal 刚好相反。原内容仍保留在原 DB 之中，但新的变动则 append 至 WAL 文件。而当 COMMIT 发生时，仅代表某个 Transaction 已 append 进 WAL 文件了，但并不一定有写入原 DB (当 WAL 文件大小到达 checkpoint 的阈值时才会写入)。如此可让其他 DB 连接继续对原 DB 内容进行读取操作，而其他连接也可同时将变动 COMMIT 进 WAL 文件。</li>
</ol>
<p>这种模式下的文件目录为一个<code>db</code>文件+一个<code>db-shm</code>文件(all SQLite database connections associated with the same database file need to share some memory that is used as an index for the WAL file)+一个<code>db-wal</code>文件</p>
<p>ROOM 对 API16 以上机型默认开启 WAL 模式</p>
<h3 id="getDao-方法都是线程安全的"><a href="#getDao-方法都是线程安全的" class="headerlink" title="getDao 方法都是线程安全的"></a>getDao 方法都是线程安全的</h3><p>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigDao <span class="title">getConfigDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_configDao != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> _configDao;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(_configDao == <span class="keyword">null</span>) &#123;</span><br><span class="line">        _configDao = <span class="keyword">new</span> ConfigDao_Impl(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _configDao;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>SQLiteOpenHelper#getWritableDatabase 也是线程安全的</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SQLiteDatabase <span class="title">getReadableDatabase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDatabaseLocked(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLiteDatabase <span class="title">getDatabaseLocked</span><span class="params">(<span class="keyword">boolean</span> writable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDatabase != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mDatabase.isOpen()) &#123;</span><br><span class="line">            <span class="comment">// Darn!  The user closed the database by calling mDatabase.close().</span></span><br><span class="line">            mDatabase = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!writable || !mDatabase.isReadOnly()) &#123;</span><br><span class="line">            <span class="comment">// The database is already open for business.</span></span><br><span class="line">            <span class="keyword">return</span> mDatabase;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsInitializing) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"getDatabase called recursively"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SQLiteDatabase db = mDatabase;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mIsInitializing = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (db != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writable &amp;&amp; db.isReadOnly()) &#123;</span><br><span class="line">                db.reopenReadWrite();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            db = SQLiteDatabase.create(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> connectionPoolSize = mForcedSingleConnection ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STRICT_READONLY &amp;&amp; !writable) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String path = mContext.getDatabasePath(mName).getPath();</span><br><span class="line">                    db = SQLiteDatabase.openDatabase(path, mPassword, mCipher, mFactory,</span><br><span class="line">                            SQLiteDatabase.OPEN_READONLY, mErrorHandler, connectionPoolSize);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mNeedMode = <span class="keyword">true</span>;</span><br><span class="line">                    mMode = mEnableWriteAheadLogging ? Context.MODE_ENABLE_WRITE_AHEAD_LOGGING : <span class="number">0</span>;</span><br><span class="line">                    db = Context.openOrCreateDatabase(mContext, mName, mPassword, mCipher,</span><br><span class="line">                            mMode, mFactory, mErrorHandler, connectionPoolSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLiteException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (writable) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">                Log.e(TAG, <span class="string">"Couldn't open "</span> + mName</span><br><span class="line">                        + <span class="string">" for writing (will try read-only):"</span>, ex);</span><br><span class="line">                <span class="keyword">final</span> String path = mContext.getDatabasePath(mName).getPath();</span><br><span class="line">                db = SQLiteDatabase.openDatabase(path, mPassword, mCipher, mFactory,</span><br><span class="line">                        SQLiteDatabase.OPEN_READONLY, mErrorHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getDatabaseLockedLast(db);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mIsInitializing = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (db != <span class="keyword">null</span> &amp;&amp; db != mDatabase) &#123;</span><br><span class="line">            db.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLiteDatabase <span class="title">getDatabaseLockedLast</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">    onConfigure(db);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> version = db.getVersion();</span><br><span class="line">    <span class="keyword">if</span> (version != mNewVersion) &#123;</span><br><span class="line">        <span class="keyword">if</span> (db.isReadOnly()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLiteException(<span class="string">"Can't upgrade read-only database from version "</span> +</span><br><span class="line">                    db.getVersion() + <span class="string">" to "</span> + mNewVersion + <span class="string">": "</span> + mName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        db.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (version == <span class="number">0</span>) &#123;</span><br><span class="line">                onCreate(db);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (version &gt; mNewVersion) &#123;</span><br><span class="line">                    onDowngrade(db, version, mNewVersion);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    onUpgrade(db, version, mNewVersion);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            db.setVersion(mNewVersion);</span><br><span class="line">            db.setTransactionSuccessful();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            db.endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onOpen(db);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (db.isReadOnly()) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Opened "</span> + mName + <span class="string">" in read-only mode"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDatabase = db;</span><br><span class="line">    <span class="keyword">return</span> db;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ROOM-的-Dao-层是依赖-Transaction-来执行数据库操作的"><a href="#ROOM-的-Dao-层是依赖-Transaction-来执行数据库操作的" class="headerlink" title="ROOM 的 Dao 层是依赖 Transaction 来执行数据库操作的"></a>ROOM 的 Dao 层是依赖 Transaction 来执行数据库操作的</h3><p>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RoomDatabase __db;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">final</span> Config arg0)</span> </span>&#123;</span><br><span class="line">  __db.assertNotSuspendingTransaction();</span><br><span class="line">  __db.beginTransaction();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    __insertionAdapterOfConfig.insert(arg0); <span class="comment">// 实际上就是SupportSQLiteStatement的操作，这里略去实现代码</span></span><br><span class="line">    __db.setTransactionSuccessful();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    __db.endTransaction();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，当我们通过 RoomDatabase#getXXXDao()执行数据库操作时，不同线程将会获得同一个 dao 对象，每个 dao 对象持有同一个 RoomDatabase 对象。那么来看看 RoomDatabase#beginTransaction()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertNotMainThread();</span><br><span class="line">    SupportSQLiteDatabase database = mOpenHelper.getWritableDatabase();</span><br><span class="line">    mInvalidationTracker.syncTriggers(database);</span><br><span class="line">    database.beginTransaction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>beginTransaction 委托了给其 SQLiteOpenHelper#getWritableDatabase()</li>
</ol>
<p>参考上文中 SQLiteOpenHelper#getWritableDatabase()部分代码, getWritableDatabase()也是线程安全</p>
<ol start="2">
<li>在 SupportSQLiteDatabase#beginTransaction()前，进行了 InvalidationTracer#syncTriggers()调用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syncTriggers</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (database.inTransaction()) &#123;</span><br><span class="line">        <span class="comment">// we won't run this inside another transaction.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// This method runs in a while loop because while changes are synced to db, another</span></span><br><span class="line">        <span class="comment">// runnable may be skipped. If we cause it to skip, we need to do its work.</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Lock closeLock = mDatabase.getCloseLock();</span><br><span class="line">            closeLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// there is a potential race condition where another mSyncTriggers runnable</span></span><br><span class="line">                <span class="comment">// can start running right after we get the tables list to sync.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span>[] tablesToSync = mObservedTableTracker.getTablesToSync();</span><br><span class="line">                <span class="keyword">if</span> (tablesToSync == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> limit = tablesToSync.length;</span><br><span class="line">                database.beginTransaction();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> tableId = <span class="number">0</span>; tableId &lt; limit; tableId++) &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (tablesToSync[tableId]) &#123;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.ADD:</span><br><span class="line">                                startTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.REMOVE:</span><br><span class="line">                                stopTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    database.setTransactionSuccessful();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    database.endTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">                mObservedTableTracker.onSyncCompleted();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                closeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException | SQLiteException exception) &#123;</span><br><span class="line">        <span class="comment">// may happen if db is closed. just log.</span></span><br><span class="line">        Log.e(Room.LOG_TAG, <span class="string">"Cannot run invalidation tracker. Is the db closed?"</span>,</span><br><span class="line">                exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 InvalidationTracer 涉及的模块比较大，主要是 ROOM 通过 sqlite 的 trigger 实现对数据变化的监听，下一个部分仔细展开.</p>
<h2 id="InvalidationTracer-模块的分析"><a href="#InvalidationTracer-模块的分析" class="headerlink" title="InvalidationTracer 模块的分析"></a>InvalidationTracer 模块的分析</h2><h3 id="先验知识-Temporary-Databases"><a href="#先验知识-Temporary-Databases" class="headerlink" title="先验知识: Temporary Databases"></a>先验知识: Temporary Databases</h3><p>sqlite 在创建表的时候可以用 temp 对 table 进行修饰为 Temporary Database，根据文档的描述<a href="https://www.sqlite.org/inmemorydb.html" target="_blank" rel="noopener">https://www.sqlite.org/inmemorydb.html</a></p>
<pre><code>A different temporary file is created each time, so that just like as with the special &quot;:memory:&quot; string, two database connections to temporary databases each have their own private database. Temporary databases are automatically deleted when the connection that created them closes.
</code></pre><p>简单来说，Temporary 是针对每个数据库链接，在其链接的生命周期下存在的数据表，链接关闭时，这个数据库也就不存在了。</p>
<h3 id="先验知识-sqlite-trigger"><a href="#先验知识-sqlite-trigger" class="headerlink" title="先验知识: sqlite trigger"></a>先验知识: sqlite trigger</h3><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><ul>
<li>CREATE TRIGGER — command that says that we want to create trigger.<br>trigger-name — is a name of the trigger</li>
<li>BEFORE/AFTER/INSTEAD OF — is a mode of the trigger (when we’d like our operation to work — before our actual query, after or instead)</li>
<li>DELETE/INSERT/UPDATE ON table-name — is description on the query which will activate our trigger</li>
<li>BEGIN stmt; END — is actual trigger operation</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER update_value INSTEAD OF UPDATE ON persons</span><br><span class="line">BEGIN</span><br><span class="line">UPDATE persons(age) values(21)</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>
<p>上面这个例子中，如果 persons 表被更新，那么 update_value 这个 trigger 就会触发, 将 persons 插入的 age 改为 21</p>
<h4 id="Android-中如何使用-Trigger"><a href="#Android-中如何使用-Trigger" class="headerlink" title="Android 中如何使用 Trigger"></a>Android 中如何使用 Trigger</h4><p>我们知道 SQLiteDatabase 是可以编写 sql 语句的，因此我们可以尝试在 onCreate 阶执行我们的 trigger 构建语句即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.execSQL(</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    create trigger order_added after insert on data</span></span><br><span class="line"><span class="string">    begin</span></span><br><span class="line"><span class="string">    insert into log(timestamp, payload) values(datetime(), new.order_id || ' ' || new.timestamp || ' ' || new.price);</span></span><br><span class="line"><span class="string">    end;</span></span><br><span class="line"><span class="string">    """</span>.trimIndent()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="InvalidationTracer-room-table-modification-log-表"><a href="#InvalidationTracer-room-table-modification-log-表" class="headerlink" title="InvalidationTracer, room_table_modification_log 表"></a>InvalidationTracer, room_table_modification_log 表</h3><p>首先我们看下 InvalidationTracer 的构造调用</p>
<p>AppDatabase_Impl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> InvalidationTracker <span class="title">createInvalidationTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> HashMap&lt;String, String&gt; _shadowTablesMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">0</span>);</span><br><span class="line">  HashMap&lt;String, Set&lt;String&gt;&gt; _viewTables = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> InvalidationTracker(<span class="keyword">this</span>, _shadowTablesMap, _viewTables, <span class="string">"config"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>config 字段就是我们在 AppDatabase 中注册的 Entity 对应的 tableName</p>
<p>InvalidationTracker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line"><span class="meta">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvalidationTracker</span><span class="params">(RoomDatabase database, Map&lt;String, String&gt; shadowTablesMap,</span></span></span><br><span class="line"><span class="function"><span class="params">        Map&lt;String, Set&lt;String&gt;&gt; viewTables, String... tableNames)</span> </span>&#123;</span><br><span class="line">    mDatabase = database;</span><br><span class="line">    mObservedTableTracker = <span class="keyword">new</span> ObservedTableTracker(tableNames.length);</span><br><span class="line">    mTableIdLookup = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    mViewTables = viewTables;</span><br><span class="line">    mInvalidationLiveDataContainer = <span class="keyword">new</span> InvalidationLiveDataContainer(mDatabase);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = tableNames.length;</span><br><span class="line">    mTableNames = <span class="keyword">new</span> String[size];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> id = <span class="number">0</span>; id &lt; size; id++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String tableName = tableNames[id].toLowerCase(Locale.US);</span><br><span class="line">        mTableIdLookup.put(tableName, id);</span><br><span class="line">        String shadowTableName = shadowTablesMap.get(tableNames[id]);</span><br><span class="line">        <span class="keyword">if</span> (shadowTableName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTableNames[id] = shadowTableName.toLowerCase(Locale.US);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mTableNames[id] = tableName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Adjust table id lookup for those tables whose shadow table is another already mapped</span></span><br><span class="line">    <span class="comment">// table (e.g. external content fts tables).</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; shadowTableEntry : shadowTablesMap.entrySet()) &#123;</span><br><span class="line">        String shadowTableName = shadowTableEntry.getValue().toLowerCase(Locale.US);</span><br><span class="line">        <span class="keyword">if</span> (mTableIdLookup.containsKey(shadowTableName)) &#123;</span><br><span class="line">            String tableName = shadowTableEntry.getKey().toLowerCase(Locale.US);</span><br><span class="line">            mTableIdLookup.put(tableName, mTableIdLookup.get(shadowTableName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有几个数据结构需要注意</p>
<ol>
<li>mTableIdLookup 记录了 tableName 和 index 的关系。例如这里”config”-&gt;0</li>
<li>mTableNames 数组依次记录了 tableName。例如这里, mTableNames.length = 1, mTableNames[0] = “config”</li>
<li>mDatabase 即 AppDatabase_Impl 对象</li>
<li>mObservedTableTracker 是一个 ObservedTableTracker 对象，这个对象内部维护了三个数组:<ol>
<li>mTableObservers, 一个 long 数组</li>
<li>mTriggerStates, 一个 boolean 数组</li>
<li>mTriggerStateChanges, 一个 int 数组</li>
</ol>
</li>
</ol>
<p>再来关注下<code>InvalidationTracker#internalInit</code>的调用链，查阅源码可以得到</p>
<p><code>SupportSQLiteOpenHelper.Callback#onOpen</code>-&gt;<code>AppDatabase_Impl#internalInitInvalidationTracker</code>-&gt;<br><code>InvalidationTracker#internalInit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">internalInit</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mInitialized) &#123;</span><br><span class="line">            Log.e(Room.LOG_TAG, <span class="string">"Invalidation tracker is initialized twice :/."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// These actions are not in a transaction because temp_store is not allowed to be</span></span><br><span class="line">        <span class="comment">// performed on a transaction, and recursive_triggers is not affected by transactions.</span></span><br><span class="line">        database.execSQL(<span class="string">"PRAGMA temp_store = MEMORY;"</span>);</span><br><span class="line">        database.execSQL(<span class="string">"PRAGMA recursive_triggers='ON';"</span>);</span><br><span class="line">        database.execSQL(CREATE_TRACKING_TABLE_SQL);</span><br><span class="line">        syncTriggers(database);</span><br><span class="line">        mCleanupStatement = database.compileStatement(RESET_UPDATED_TABLES_SQL);</span><br><span class="line">        mInitialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把 sql 语句串联一下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PRAGMA</span> temp_store = <span class="keyword">MEMORY</span>;</span><br><span class="line"><span class="keyword">PRAGMA</span> recursive_triggers=<span class="string">'ON'</span>;</span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TABLE</span> room_table_modification_log (table_id <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span>, invalidated <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated <span class="number">0</span> <span class="keyword">WHERE</span> invalidated = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>创建了一个 In-memory 的临时表 room_table_modification_log</li>
<li>主键 table_id, 我们这里可以猜测这个 table_id 应该就和构造函数里提到的 id 概念对应</li>
<li>invalidated 字段，字面意思应该是表示数据是否有效</li>
</ol>
<p>在 CREATE 语句和 UPDATE 语句之间，还有一个 syncTriggers 调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syncTriggers</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (database.inTransaction()) &#123;</span><br><span class="line">        <span class="comment">// we won't run this inside another transaction.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// This method runs in a while loop because while changes are synced to db, another</span></span><br><span class="line">        <span class="comment">// runnable may be skipped. If we cause it to skip, we need to do its work.</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Lock closeLock = mDatabase.getCloseLock();</span><br><span class="line">            closeLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// there is a potential race condition where another mSyncTriggers runnable</span></span><br><span class="line">                <span class="comment">// can start running right after we get the tables list to sync.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span>[] tablesToSync = mObservedTableTracker.getTablesToSync();  <span class="comment">// #1</span></span><br><span class="line">                <span class="keyword">if</span> (tablesToSync == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> limit = tablesToSync.length;</span><br><span class="line">                database.beginTransaction();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> tableId = <span class="number">0</span>; tableId &lt; limit; tableId++) &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (tablesToSync[tableId]) &#123;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.ADD:</span><br><span class="line">                                startTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.REMOVE:</span><br><span class="line">                                stopTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    database.setTransactionSuccessful();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    database.endTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">                mObservedTableTracker.onSyncCompleted();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                closeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException | SQLiteException exception) &#123;</span><br><span class="line">        <span class="comment">// may happen if db is closed. just log.</span></span><br><span class="line">        Log.e(Room.LOG_TAG, <span class="string">"Cannot run invalidation tracker. Is the db closed?"</span>,</span><br><span class="line">                exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着看下#1 这里， <code>ObservedTableTracker#getTablesToSync()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">int</span>[] getTablesToSync() &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mNeedsSync || mPendingSync) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> tableCount = mTableObservers.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tableCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> newState = mTableObservers[i] &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (newState != mTriggerStates[i]) &#123;</span><br><span class="line">                mTriggerStateChanges[i] = newState ? ADD : REMOVE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mTriggerStateChanges[i] = NO_OP;</span><br><span class="line">            &#125;</span><br><span class="line">            mTriggerStates[i] = newState;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingSync = <span class="keyword">true</span>;</span><br><span class="line">        mNeedsSync = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> mTriggerStateChanges;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不需要同步(!mNeedSync)或者正在同步(mPendingSync)，返回 null</p>
<p>否则</p>
<p>我们对每个 table_id 做判断，在当前场景下, mTableObservers[0] = 0, mTriggerStates[0] = false, mTriggerStateChanges[0] = 0, 经过算法后<br>mTableObservers[0] = 0, mTriggerStates[0] = false, mTriggerStateChanges[0] = NO_OP</p>
<p>回到 syncTriggers 这里，返回了一个 NO_OP，那么什么事情都不做。直接返回</p>
<p>那么时候才会走到 startTrackingTable 或者 stopTrackingTable 呢？针对这个问题，我们看下 ObservedTableTracker.ADD 的赋值位置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> newState = mTableObservers[i] &gt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (newState != mTriggerStates[i]) &#123;</span><br><span class="line">    mTriggerStateChanges[i] = newState ? ADD : REMOVE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mTriggerStateChanges[i] = NO_OP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 newState = mTableObservers[i] &gt; 0 成立时才会是 ADD, 那么我们看看什么时候 mTableObservers[i] &gt; 0，可以发现是<code>ObservedTableTracker#onAdded调用</code></p>
<p>onAdded 调用链:</p>
<p><code>InvalidationTracker#addObserver</code>-&gt;<code>InvalidationTracker#onAdded()</code></p>
<p><code>InvalidationTracker#addWeakObserver</code>-&gt;<code>InvalidationTracker#addObserver</code>-&gt;<code>InvalidationTracker#onAdded()</code></p>
<p>addWeakObserver 则用在了<code>RoomTrackingLiveData#mRefreshRunnable</code>或<code>LimitOffsetDataSource()</code></p>
<p>这里我们可以大致做一个推断</p>
<ol>
<li>paging 或 ROOM 中对 LiveData 的支持，依赖了 addObserver 或者 addWeakObserver 来实现，这是必然的。因为二者是一个典型的观察者模式范型的表现</li>
</ol>
<p>接下来我们看看 addObserver 的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"RestrictedApi"</span>)</span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(@NonNull Observer observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String[] tableNames = resolveViews(observer.mTables);</span><br><span class="line">    <span class="keyword">int</span>[] tableIds = <span class="keyword">new</span> <span class="keyword">int</span>[tableNames.length];</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = tableNames.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        Integer tableId = mTableIdLookup.get(tableNames[i].toLowerCase(Locale.US));</span><br><span class="line">        <span class="keyword">if</span> (tableId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"There is no table with name "</span> + tableNames[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        tableIds[i] = tableId;</span><br><span class="line">    &#125;</span><br><span class="line">    ObserverWrapper wrapper = <span class="keyword">new</span> ObserverWrapper(observer, tableIds, tableNames);</span><br><span class="line">    ObserverWrapper currentObserver;</span><br><span class="line">    <span class="keyword">synchronized</span> (mObserverMap) &#123;</span><br><span class="line">        currentObserver = mObserverMap.putIfAbsent(observer, wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (currentObserver == <span class="keyword">null</span> &amp;&amp; mObservedTableTracker.onAdded(tableIds)) &#123;</span><br><span class="line">        syncTriggers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>observer.mTables 就是 observer 所观察的 tableName 数组, 是 String[], 我们这里可以假设是[“config”], resolveViews 主要解决了数据库的视图映射，这里我们不涉及。可以直接理解 tableNames=[“config”], 后续算法我们可以得到 tablesIds.length = 1, tablesIds[0] = 0. 之后做了两件事情</p>
<ol>
<li>将一个 ObserverWrapper 对象放到 mObserverMap 中，map 维护了一个 Observer 和 ObserverWrapper 关系</li>
<li>如果是第一次加入 observerMap 的 observer 对象，调用 onAdded()</li>
<li>如果 2 的基础上，onAdded()返回 true，调用 syncTriggers()</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onAdded</span><span class="params">(<span class="keyword">int</span>... tableIds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> needTriggerSync = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> tableId : tableIds) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> prevObserverCount = mTableObservers[tableId];</span><br><span class="line">            mTableObservers[tableId] = prevObserverCount + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (prevObserverCount == <span class="number">0</span>) &#123;</span><br><span class="line">                mNeedsSync = <span class="keyword">true</span>;</span><br><span class="line">                needTriggerSync = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> needTriggerSync;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对每个 tableId 做了判断, 如果其之前从没有过 observer 对该 tableId 进行监听, 那么就需要进行一次 sync(needTriggerSync = true)</p>
<p>回忆一下之前对 getTablesToSync 的分析，此时 mTableObservers[tableId]&gt;0, 那么在 syncTriggers()逻辑中就会得到一个 ADD 指令, 我们看看 ADD 对应的<code>startTrackingTable</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startTrackingTable</span><span class="params">(SupportSQLiteDatabase writableDb, <span class="keyword">int</span> tableId)</span> </span>&#123;</span><br><span class="line">    writableDb.execSQL(</span><br><span class="line">            <span class="string">"INSERT OR IGNORE INTO "</span> + UPDATE_TABLE_NAME + <span class="string">" VALUES("</span> + tableId + <span class="string">", 0)"</span>);</span><br><span class="line">    <span class="keyword">final</span> String tableName = mTableNames[tableId];</span><br><span class="line">    StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (String trigger : TRIGGERS) &#123;</span><br><span class="line">        stringBuilder.setLength(<span class="number">0</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">"CREATE TEMP TRIGGER IF NOT EXISTS "</span>);</span><br><span class="line">        appendTriggerName(stringBuilder, tableName, trigger);</span><br><span class="line">        stringBuilder.append(<span class="string">" AFTER "</span>)</span><br><span class="line">                .append(trigger)</span><br><span class="line">                .append(<span class="string">" ON `"</span>)</span><br><span class="line">                .append(tableName)</span><br><span class="line">                .append(<span class="string">"` BEGIN UPDATE "</span>)</span><br><span class="line">                .append(UPDATE_TABLE_NAME)</span><br><span class="line">                .append(<span class="string">" SET "</span>).append(INVALIDATED_COLUMN_NAME).append(<span class="string">" = 1"</span>)</span><br><span class="line">                .append(<span class="string">" WHERE "</span>).append(TABLE_ID_COLUMN_NAME).append(<span class="string">" = "</span>).append(tableId)</span><br><span class="line">                .append(<span class="string">" AND "</span>).append(INVALIDATED_COLUMN_NAME).append(<span class="string">" = 0"</span>)</span><br><span class="line">                .append(<span class="string">"; END"</span>);</span><br><span class="line">        writableDb.execSQL(stringBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们尝试把所有 sql 展开得到</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> room_table_modification_log <span class="keyword">VALUES</span>($tableId, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`room_table_modification_trigger_$tableName_UPDATE`</span> <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> <span class="string">`$tableName`</span> <span class="keyword">BEGIN</span> <span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated = <span class="number">1</span> <span class="keyword">WHERE</span> tableId = $tableId <span class="keyword">AND</span> invalidated = <span class="number">0</span>; <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`room_table_modification_trigger_$tableName_REMOVE`</span> <span class="keyword">AFTER</span> REMOVE <span class="keyword">ON</span> <span class="string">`$tableName`</span> <span class="keyword">BEGIN</span> <span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated = <span class="number">1</span> <span class="keyword">WHERE</span> tableId = $tableId <span class="keyword">AND</span> invalidated = <span class="number">0</span>; <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`room_table_modification_trigger_$tableName_INSERT`</span> <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`$tableName`</span> <span class="keyword">BEGIN</span> <span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated = <span class="number">1</span> <span class="keyword">WHERE</span> tableId = $tableId <span class="keyword">AND</span> invalidated = <span class="number">0</span>; <span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>这一段就是在 DB，建立了对不同的表的有效值 trigger 机制, 通过这个 trigger 的设置，我们能进一步理解 room_table_modification_log 的作用</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tableId</td>
<td>唯一值，与上层 Entity 中的 tableName 构成一一对应</td>
</tr>
<tr>
<td>invalidated</td>
<td>0 或 1，1 表示数据有更新</td>
</tr>
</tbody>
</table>
<p>那么综合一下上述分析:</p>
<ol>
<li>当且仅当一个表首次被监听时, 我们会创建一组 trigger，对这个表的数据更新状态通过 invalidated 进行表示</li>
<li>在 Java 层，我们使用一个 Map 保存了 Observer 的映射关系，以便后续观察到数据变化时唤起</li>
</ol>
<p>看完了监听的建立，我们就要来看看如何唤起这个监听了</p>
<h3 id="InvalidationTracker-观察者模式的触发"><a href="#InvalidationTracker-观察者模式的触发" class="headerlink" title="InvalidationTracker 观察者模式的触发"></a>InvalidationTracker 观察者模式的触发</h3><p>首先需要明确的是，我们肯定是要获得 DB 中哪些表的数据进行了更新，根据上述分析。我们可以从 room_table_modification_log 中 invalidated=1 的项进行分析。那么遵循这个思路，我们查阅代码中对 room_table_modification_log 的查询操作</p>
<p>InvalidationTracker#mRefreshRunnable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Lock closeLock = mDatabase.getCloseLock();</span><br><span class="line">        Set&lt;Integer&gt; invalidatedTableIds = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            closeLock.lock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!ensureInitialization()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mPendingRefresh.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// no pending refresh</span></span><br><span class="line">                <span class="comment">// 防止重入</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDatabase.inTransaction()) &#123;</span><br><span class="line">                <span class="comment">// current thread is in a transaction. when it ends, it will invoke</span></span><br><span class="line">                <span class="comment">// refreshRunnable again. mPendingRefresh is left as false on purpose</span></span><br><span class="line">                <span class="comment">// so that the last transaction can flip it on again.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDatabase.mWriteAheadLoggingEnabled) &#123; <span class="comment">// #1</span></span><br><span class="line">                <span class="comment">// This transaction has to be on the underlying DB rather than the RoomDatabase</span></span><br><span class="line">                <span class="comment">// in order to avoid a recursive loop after endTransaction.</span></span><br><span class="line">                SupportSQLiteDatabase db = mDatabase.getOpenHelper().getWritableDatabase();</span><br><span class="line">                db.beginTransaction();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    invalidatedTableIds = checkUpdatedTable();</span><br><span class="line">                    db.setTransactionSuccessful();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    db.endTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invalidatedTableIds = checkUpdatedTable();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException | SQLiteException exception) &#123;</span><br><span class="line">            <span class="comment">// may happen if db is closed. just log.</span></span><br><span class="line">            Log.e(Room.LOG_TAG, <span class="string">"Cannot run invalidation tracker. Is the db closed?"</span>,</span><br><span class="line">                    exception);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (invalidatedTableIds != <span class="keyword">null</span> &amp;&amp; !invalidatedTableIds.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mObserverMap) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;Observer, ObserverWrapper&gt; entry : mObserverMap) &#123;</span><br><span class="line">                    entry.getValue().notifyByTableInvalidStatus(invalidatedTableIds); <span class="comment">// #2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;Integer&gt; <span class="title">checkUpdatedTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArraySet&lt;Integer&gt; invalidatedTableIds = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">        Cursor cursor = mDatabase.query(<span class="keyword">new</span> SimpleSQLiteQuery(SELECT_UPDATED_TABLES_SQL));  <span class="comment">// #3</span></span><br><span class="line">        <span class="comment">//noinspection TryFinallyCanBeTryWithResources</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过cursor读到 invalidatedTableIds，略去</span></span><br><span class="line">        <span class="keyword">if</span> (!invalidatedTableIds.isEmpty()) &#123;</span><br><span class="line">            mCleanupStatement.executeUpdateDelete(); <span class="comment">// 有数据更新，重置下invalidated标志位</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invalidatedTableIds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过 checkUpdatedTable 函数，我们得到了所有 invalidated=1 的 tableId，之后在 mObserverMap 中通知观察者 notifyByTableInvalidStatus</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyByTableInvalidStatus</span><span class="params">(Set&lt;Integer&gt; invalidatedTablesIds)</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; invalidatedTables = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mTableIds.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> tableId = mTableIds[index];</span><br><span class="line">        <span class="keyword">if</span> (invalidatedTablesIds.contains(tableId)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (size == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// Optimization for a single-table observer</span></span><br><span class="line">                invalidatedTables = mSingleTableSet;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (invalidatedTables == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    invalidatedTables = <span class="keyword">new</span> ArraySet&lt;&gt;(size);</span><br><span class="line">                &#125;</span><br><span class="line">                invalidatedTables.add(mTableNames[index]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (invalidatedTables != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mObserver.onInvalidated(invalidatedTables);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>invalidatedTables 记录了 tableId 对应的原 Entity 对应的 table_name, onInvalidated 则是接口，由 Observer 自己实现，这里我们以 RoomTrackingLiveData 分析一下，找到其内部聚合的<code>onInvalidated</code>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint</span>(&#123;<span class="string">"RestrictedApi"</span>&#125;)</span><br><span class="line">RoomTrackingLiveData(RoomDatabase database, InvalidationLiveDataContainer container, <span class="keyword">boolean</span> inTransaction, Callable&lt;T&gt; computeFunction, String[] tableNames) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.mObserver = <span class="keyword">new</span> Observer(tableNames) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">(@NonNull Set&lt;String&gt; tables)</span> </span>&#123;</span><br><span class="line">            ArchTaskExecutor.getInstance().executeOnMainThread(RoomTrackingLiveData.<span class="keyword">this</span>.mInvalidationRunnable); <span class="comment">// #1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Runnable mInvalidationRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isActive = RoomTrackingLiveData.<span class="keyword">this</span>.hasActiveObservers();</span><br><span class="line">        <span class="keyword">if</span> (RoomTrackingLiveData.<span class="keyword">this</span>.mInvalid.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>) &amp;&amp; isActive) &#123;</span><br><span class="line">            RoomTrackingLiveData.<span class="keyword">this</span>.getQueryExecutor().execute(RoomTrackingLiveData.<span class="keyword">this</span>.mRefreshRunnable); <span class="comment">// #2</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (RoomTrackingLiveData.<span class="keyword">this</span>.mRegisteredObserver.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        RoomTrackingLiveData.<span class="keyword">this</span>.mDatabase.getInvalidationTracker().addWeakObserver(RoomTrackingLiveData.<span class="keyword">this</span>.mObserver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> computed;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        computed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (RoomTrackingLiveData.<span class="keyword">this</span>.mComputing.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(RoomTrackingLiveData.<span class="keyword">this</span>.mInvalid.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                    computed = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        value = RoomTrackingLiveData.<span class="keyword">this</span>.mComputeFunction.call();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Exception while computing database live data."</span>, var7);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (computed) &#123;</span><br><span class="line">                    RoomTrackingLiveData.<span class="keyword">this</span>.postValue(value); <span class="comment">// #3</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                RoomTrackingLiveData.<span class="keyword">this</span>.mComputing.set(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(computed &amp;&amp; RoomTrackingLiveData.<span class="keyword">this</span>.mInvalid.get());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>篇幅问题这里不分析 RoomTrackingLiveData 的仔细实现，从关键的#1, #2, #3 看，RoomTrackingLiveData 利用这个 Observer，当<code>Observer#onInvalidated</code>被触发的时候, 对 DB 进行了<code>mComputeFunction#call()</code>操作，这个我们可以直接猜测就是上层的 DB 查询具体实现，这个由具体的 DAO 层解释。然后调用 postValue 来刷新 LiveData 的值</p>
<p>分析完整个监听被触发的过程，有一个问题没有解释，就是<code>InvalidationTracker#mRefreshRunnable</code>是如何被调用的</p>
<p>追溯源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshVersionsAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO we should consider doing this sync instead of async.</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingRefresh.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        mDatabase.getQueryExecutor().execute(mRefreshRunnable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshVersionsSync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    syncTriggers();</span><br><span class="line">    mRefreshRunnable.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>追溯调用链</p>
<ol>
<li><p><code>RoomDatabase#endTransaction()</code>-&gt;<code>InvalidationTracker#refreshVersionsAsync()</code></p>
</li>
<li><p><code>LimitOffsetDataSource#isInvalid()</code>-&gt;<code>InvalidationTracker#refreshVersionsSync()</code></p>
</li>
</ol>
<p>篇幅问题，不分析跟 Paging Library 关联大的 2。分析一下 1</p>
<p>实际上，在[ROOM 的线程安全是如何保证的]这节的第三部分，我们已经能发现 Dao 层的 DB 操作都是依赖 beginTransaction, endTransaction 来完成 DB 事务的。也就是说，只要 DAO 层有 DB 事务发生，那么 ROOM 必定会在 getQueryExecutor()的线程池中，执行 mRefreshRunnable, 如果发现了有数据更新的 table，就将这些 table 信息全部抛给<code>Observer#onInvalidated</code>处理</p>
<h2 id="InvalidationTracker-小结"><a href="#InvalidationTracker-小结" class="headerlink" title="InvalidationTracker 小结"></a>InvalidationTracker 小结</h2><p><code>InvalidationTracker</code>的职责即建立了业务对 DB 数据写的观察者模式, 业务的 Observer 被<code>InvalidationTracker</code>聚合持有，同时建立一个临时表<code>room_table_modification_log</code></p>
<table>
<thead>
<tr>
<th>表名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tableId</td>
<td>唯一值，与上层 Entity 中的 tableName 构成一一对应</td>
</tr>
<tr>
<td>invalidated</td>
<td>0 或 1，1 表示数据有更新</td>
</tr>
</tbody>
</table>
<p>当某个表被业务监听时，对这个表创建 trigger 建立观察者模式，监听这张表的写操作，trigger 被触发时就写<code>room_table_modification_log</code></p>
<p>DAO 层业务代码委托<code>RoomDatabase</code>通过<code>beginTransaction</code>, <code>endTransaction</code>来完成 DB 的事务提交，这些函数被调用时，顺带触发了<code>InvalidationTracker</code>内部对表<code>room_table_modification_log</code>的异步查询，查询到有数据更新<code>(invalidated=1）</code>的表名信息, 将这些表名信息带给<code>Observer#onInvalidated</code>的参数中。例如 RoomTrackingLiveData 中, 利用<code>InvalidationTracker</code>建立的这套机制，实现了 DAO 层 LiveData 的持有数据实时更新的特性</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2020/03/28/ROOM%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E6%9E%90/" data-id="ckgx4rr7s0011i8x7tzo2mdeg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-ROOM/" rel="tag">Android, ROOM</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/05/04/MMKV%E6%BA%90%E7%A0%81%E7%AE%80%E6%9E%90-%E5%88%9D%E5%A7%8B%E5%8C%96/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          MMKV源码简析---初始化
        
      </div>
    </a>
  
  
    <a href="/2020/02/14/Android-focus%E6%A6%82%E5%BF%B5/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Android focus概念</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-ROOM/" rel="tag">Android, ROOM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NDK/" rel="tag">NDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebView-JSBridge/" rel="tag">WebView, JSBridge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-jetpack-compose/" rel="tag">android, jetpack compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-mmkv/" rel="tag">android, mmkv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-textview/" rel="tag">android, textview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-coroutine/" rel="tag">kotlin, coroutine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-%E5%8D%8F%E7%A8%8B/" rel="tag">kotlin, 协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v8-WebAssembly/" rel="tag">v8, WebAssembly</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android-ROOM/" style="font-size: 10px;">Android, ROOM</a> <a href="/tags/NDK/" style="font-size: 10px;">NDK</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/WebAssembly/" style="font-size: 15px;">WebAssembly</a> <a href="/tags/WebView-JSBridge/" style="font-size: 10px;">WebView, JSBridge</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/android-jetpack-compose/" style="font-size: 10px;">android, jetpack compose</a> <a href="/tags/android-mmkv/" style="font-size: 20px;">android, mmkv</a> <a href="/tags/android-textview/" style="font-size: 10px;">android, textview</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/kotlin-coroutine/" style="font-size: 10px;">kotlin, coroutine</a> <a href="/tags/kotlin-%E5%8D%8F%E7%A8%8B/" style="font-size: 10px;">kotlin, 协程</a> <a href="/tags/v8-WebAssembly/" style="font-size: 10px;">v8, WebAssembly</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/13/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5/">FFMpeg-Android开发-简单音视频同步</a>
          </li>
        
          <li>
            <a href="/2020/09/12/Kotlin%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">Kotlin协程异常处理</a>
          </li>
        
          <li>
            <a href="/2020/08/29/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E6%92%AD%E6%94%BE%E9%9F%B3%E9%A2%91/">FFMpeg-Android开发-简单播放音频</a>
          </li>
        
          <li>
            <a href="/2020/08/23/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E6%92%AD%E6%94%BE%E8%A7%86%E9%A2%91/">FFMpeg-Android开发-简单播放视频</a>
          </li>
        
          <li>
            <a href="/2020/08/22/FFMpeg-Android%E5%BC%80%E5%8F%91-%E8%A7%A3%E6%9E%90%E8%A7%86%E9%A2%91%E6%A0%BC%E5%BC%8F/">FFMpeg-Android开发-解析视频格式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Jian Guo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>