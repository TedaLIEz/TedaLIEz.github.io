<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Aichi_B7A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Aichi_B7A">
<meta property="og:url" content="https://tedaliez.github.io/page/2/index.html">
<meta property="og:site_name" content="Aichi_B7A">
<meta property="og:locale">
<meta property="article:author" content="Jian Guo">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Aichi_B7A" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Aichi_B7A</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://tedaliez.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-ROOM数据库分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/28/ROOM%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2020-03-28T15:08:43.000Z" itemprop="datePublished">2020-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/28/ROOM%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E6%9E%90/">ROOM数据库分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>以 2.1.0 版本源码简单分析下 ROOM，主要针对一些自己的困惑做一些记录</p>
<p>为了本文行文方便, 本文的分析全部基于以下的简单的 DB 构造</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Database(entities = &#123;Config.class&#125;, version = 0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDatabase</span> <span class="title">extends</span> <span class="title">RoomDatabase</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity(tableName = <span class="meta-string">"config"</span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span> <span class="meta">@Ignore</span> <span class="keyword">constructor</span></span>(<span class="meta">@ColumnInfo(name = <span class="meta-string">"name"</span>)</span> <span class="keyword">var</span> name: String?, <span class="meta">@ColumnInfo(name = <span class="meta-string">"value"</span>)</span> <span class="keyword">var</span> value: String?) &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() : <span class="keyword">this</span>(<span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PrimaryKey(autoGenerate = true)</span></span><br><span class="line">    <span class="keyword">var</span> id: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Dao</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(onConflict = OnConflictStrategy.REPLACE)</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">insert</span><span class="params">(config: <span class="type">Config</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ROOM-的线程安全是如何保证的"><a href="#ROOM-的线程安全是如何保证的" class="headerlink" title="ROOM 的线程安全是如何保证的"></a>ROOM 的线程安全是如何保证的</h2><h3 id="先验知识-Transaction-和-Rollback-Journals"><a href="#先验知识-Transaction-和-Rollback-Journals" class="headerlink" title="先验知识: Transaction 和 Rollback Journals"></a>先验知识: Transaction 和 Rollback Journals</h3><p>sqlite 支持通过 transaction 模式来提交事务，一个典型的调用模式如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.beginTransaction();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    db.setTransactionSuccessful();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    db.endTransaction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能这里就会有 Error 出现，那么就有可能会 skip<code>db.setTransactionSuccessful()</code>, 而直接调用<code>db.endTransaction()</code>，根据 Android 文档说明</p>
<pre><code>The changes will be rolled back if any transaction is ended without being marked as clean (by calling setTransactionSuccessful). Otherwise they will be committed.
</code></pre><p>也就是说 setTransactionSuccessful()未调用则执行 rollback，这里的 rollback 即 sqlite 的 rollback 策略，需要了解下 sqlite 的 rollback 策略</p>
<ol>
<li>回滚日志档 (Rollback Journal)：<br>先将源文件备份至 Rollback Journal 中，再将要变动的内容直接写入 DB。当需要 rollback 时，再将原内容从 Rollback Journal 写回 DB；若要 commit 变更时，则只要将该档案刪除即可。<br>而 rollback 的日志模式又可细分为 4 种：DELETE (SQLite 预设)、TRUNCATE (Android 版 SQLite 预设值)、PERSIST、MEMORY</li>
</ol>
<p>TRUNCATE 这个模式就是 ROOM 在非 WAL 模式下的默认设置，即 Rollback Journal 总是清空，而非删除</p>
<p>这种模式下的文件目录为一个<code>db</code>文件+一个<code>db-journal</code>文件</p>
<ol start="2">
<li>WAL (Write-Ahead Log)：<br>作法与 Rollback Journal 刚好相反。原内容仍保留在原 DB 之中，但新的变动则 append 至 WAL 文件。而当 COMMIT 发生时，仅代表某个 Transaction 已 append 进 WAL 文件了，但并不一定有写入原 DB (当 WAL 文件大小到达 checkpoint 的阈值时才会写入)。如此可让其他 DB 连接继续对原 DB 内容进行读取操作，而其他连接也可同时将变动 COMMIT 进 WAL 文件。</li>
</ol>
<p>这种模式下的文件目录为一个<code>db</code>文件+一个<code>db-shm</code>文件(all SQLite database connections associated with the same database file need to share some memory that is used as an index for the WAL file)+一个<code>db-wal</code>文件</p>
<p>ROOM 对 API16 以上机型默认开启 WAL 模式</p>
<h3 id="getDao-方法都是线程安全的"><a href="#getDao-方法都是线程安全的" class="headerlink" title="getDao 方法都是线程安全的"></a>getDao 方法都是线程安全的</h3><p>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigDao <span class="title">getConfigDao</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (_configDao != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> _configDao;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span>(_configDao == <span class="keyword">null</span>) &#123;</span><br><span class="line">        _configDao = <span class="keyword">new</span> ConfigDao_Impl(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _configDao;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>SQLiteOpenHelper#getWritableDatabase 也是线程安全的</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> SQLiteDatabase <span class="title">getReadableDatabase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> getDatabaseLocked(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLiteDatabase <span class="title">getDatabaseLocked</span><span class="params">(<span class="keyword">boolean</span> writable)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDatabase != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mDatabase.isOpen()) &#123;</span><br><span class="line">            <span class="comment">// Darn!  The user closed the database by calling mDatabase.close().</span></span><br><span class="line">            mDatabase = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!writable || !mDatabase.isReadOnly()) &#123;</span><br><span class="line">            <span class="comment">// The database is already open for business.</span></span><br><span class="line">            <span class="keyword">return</span> mDatabase;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIsInitializing) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"getDatabase called recursively"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SQLiteDatabase db = mDatabase;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mIsInitializing = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (db != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (writable &amp;&amp; db.isReadOnly()) &#123;</span><br><span class="line">                db.reopenReadWrite();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            db = SQLiteDatabase.create(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> connectionPoolSize = mForcedSingleConnection ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_STRICT_READONLY &amp;&amp; !writable) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String path = mContext.getDatabasePath(mName).getPath();</span><br><span class="line">                    db = SQLiteDatabase.openDatabase(path, mPassword, mCipher, mFactory,</span><br><span class="line">                            SQLiteDatabase.OPEN_READONLY, mErrorHandler, connectionPoolSize);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mNeedMode = <span class="keyword">true</span>;</span><br><span class="line">                    mMode = mEnableWriteAheadLogging ? Context.MODE_ENABLE_WRITE_AHEAD_LOGGING : <span class="number">0</span>;</span><br><span class="line">                    db = Context.openOrCreateDatabase(mContext, mName, mPassword, mCipher,</span><br><span class="line">                            mMode, mFactory, mErrorHandler, connectionPoolSize);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLiteException ex) &#123;</span><br><span class="line">                <span class="keyword">if</span> (writable) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ex;</span><br><span class="line">                &#125;</span><br><span class="line">                Log.e(TAG, <span class="string">"Couldn't open "</span> + mName</span><br><span class="line">                        + <span class="string">" for writing (will try read-only):"</span>, ex);</span><br><span class="line">                <span class="keyword">final</span> String path = mContext.getDatabasePath(mName).getPath();</span><br><span class="line">                db = SQLiteDatabase.openDatabase(path, mPassword, mCipher, mFactory,</span><br><span class="line">                        SQLiteDatabase.OPEN_READONLY, mErrorHandler);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> getDatabaseLockedLast(db);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mIsInitializing = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (db != <span class="keyword">null</span> &amp;&amp; db != mDatabase) &#123;</span><br><span class="line">            db.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> SQLiteDatabase <span class="title">getDatabaseLockedLast</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">    onConfigure(db);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> version = db.getVersion();</span><br><span class="line">    <span class="keyword">if</span> (version != mNewVersion) &#123;</span><br><span class="line">        <span class="keyword">if</span> (db.isReadOnly()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLiteException(<span class="string">"Can't upgrade read-only database from version "</span> +</span><br><span class="line">                    db.getVersion() + <span class="string">" to "</span> + mNewVersion + <span class="string">": "</span> + mName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        db.beginTransaction();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (version == <span class="number">0</span>) &#123;</span><br><span class="line">                onCreate(db);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (version &gt; mNewVersion) &#123;</span><br><span class="line">                    onDowngrade(db, version, mNewVersion);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    onUpgrade(db, version, mNewVersion);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            db.setVersion(mNewVersion);</span><br><span class="line">            db.setTransactionSuccessful();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            db.endTransaction();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    onOpen(db);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (db.isReadOnly()) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Opened "</span> + mName + <span class="string">" in read-only mode"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDatabase = db;</span><br><span class="line">    <span class="keyword">return</span> db;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ROOM-的-Dao-层是依赖-Transaction-来执行数据库操作的"><a href="#ROOM-的-Dao-层是依赖-Transaction-来执行数据库操作的" class="headerlink" title="ROOM 的 Dao 层是依赖 Transaction 来执行数据库操作的"></a>ROOM 的 Dao 层是依赖 Transaction 来执行数据库操作的</h3><p>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> RoomDatabase __db;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">final</span> Config arg0)</span> </span>&#123;</span><br><span class="line">  __db.assertNotSuspendingTransaction();</span><br><span class="line">  __db.beginTransaction();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    __insertionAdapterOfConfig.insert(arg0); <span class="comment">// 实际上就是SupportSQLiteStatement的操作，这里略去实现代码</span></span><br><span class="line">    __db.setTransactionSuccessful();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    __db.endTransaction();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，当我们通过 RoomDatabase#getXXXDao()执行数据库操作时，不同线程将会获得同一个 dao 对象，每个 dao 对象持有同一个 RoomDatabase 对象。那么来看看 RoomDatabase#beginTransaction()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    assertNotMainThread();</span><br><span class="line">    SupportSQLiteDatabase database = mOpenHelper.getWritableDatabase();</span><br><span class="line">    mInvalidationTracker.syncTriggers(database);</span><br><span class="line">    database.beginTransaction();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>beginTransaction 委托了给其 SQLiteOpenHelper#getWritableDatabase()</li>
</ol>
<p>参考上文中 SQLiteOpenHelper#getWritableDatabase()部分代码, getWritableDatabase()也是线程安全</p>
<ol start="2">
<li>在 SupportSQLiteDatabase#beginTransaction()前，进行了 InvalidationTracer#syncTriggers()调用</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syncTriggers</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (database.inTransaction()) &#123;</span><br><span class="line">        <span class="comment">// we won't run this inside another transaction.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// This method runs in a while loop because while changes are synced to db, another</span></span><br><span class="line">        <span class="comment">// runnable may be skipped. If we cause it to skip, we need to do its work.</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Lock closeLock = mDatabase.getCloseLock();</span><br><span class="line">            closeLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// there is a potential race condition where another mSyncTriggers runnable</span></span><br><span class="line">                <span class="comment">// can start running right after we get the tables list to sync.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span>[] tablesToSync = mObservedTableTracker.getTablesToSync();</span><br><span class="line">                <span class="keyword">if</span> (tablesToSync == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> limit = tablesToSync.length;</span><br><span class="line">                database.beginTransaction();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> tableId = <span class="number">0</span>; tableId &lt; limit; tableId++) &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (tablesToSync[tableId]) &#123;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.ADD:</span><br><span class="line">                                startTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.REMOVE:</span><br><span class="line">                                stopTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    database.setTransactionSuccessful();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    database.endTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">                mObservedTableTracker.onSyncCompleted();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                closeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException | SQLiteException exception) &#123;</span><br><span class="line">        <span class="comment">// may happen if db is closed. just log.</span></span><br><span class="line">        Log.e(Room.LOG_TAG, <span class="string">"Cannot run invalidation tracker. Is the db closed?"</span>,</span><br><span class="line">                exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 InvalidationTracer 涉及的模块比较大，主要是 ROOM 通过 sqlite 的 trigger 实现对数据变化的监听，下一个部分仔细展开.</p>
<h2 id="InvalidationTracer-模块的分析"><a href="#InvalidationTracer-模块的分析" class="headerlink" title="InvalidationTracer 模块的分析"></a>InvalidationTracer 模块的分析</h2><h3 id="先验知识-Temporary-Databases"><a href="#先验知识-Temporary-Databases" class="headerlink" title="先验知识: Temporary Databases"></a>先验知识: Temporary Databases</h3><p>sqlite 在创建表的时候可以用 temp 对 table 进行修饰为 Temporary Database，根据文档的描述<a href="https://www.sqlite.org/inmemorydb.html" target="_blank" rel="noopener">https://www.sqlite.org/inmemorydb.html</a></p>
<pre><code>A different temporary file is created each time, so that just like as with the special &quot;:memory:&quot; string, two database connections to temporary databases each have their own private database. Temporary databases are automatically deleted when the connection that created them closes.
</code></pre><p>简单来说，Temporary 是针对每个数据库链接，在其链接的生命周期下存在的数据表，链接关闭时，这个数据库也就不存在了。</p>
<h3 id="先验知识-sqlite-trigger"><a href="#先验知识-sqlite-trigger" class="headerlink" title="先验知识: sqlite trigger"></a>先验知识: sqlite trigger</h3><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><ul>
<li>CREATE TRIGGER — command that says that we want to create trigger.<br>trigger-name — is a name of the trigger</li>
<li>BEFORE/AFTER/INSTEAD OF — is a mode of the trigger (when we’d like our operation to work — before our actual query, after or instead)</li>
<li>DELETE/INSERT/UPDATE ON table-name — is description on the query which will activate our trigger</li>
<li>BEGIN stmt; END — is actual trigger operation</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER update_value INSTEAD OF UPDATE ON persons</span><br><span class="line">BEGIN</span><br><span class="line">UPDATE persons(age) values(21)</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>
<p>上面这个例子中，如果 persons 表被更新，那么 update_value 这个 trigger 就会触发, 将 persons 插入的 age 改为 21</p>
<h4 id="Android-中如何使用-Trigger"><a href="#Android-中如何使用-Trigger" class="headerlink" title="Android 中如何使用 Trigger"></a>Android 中如何使用 Trigger</h4><p>我们知道 SQLiteDatabase 是可以编写 sql 语句的，因此我们可以尝试在 onCreate 阶执行我们的 trigger 构建语句即可</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">db.execSQL(</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    create trigger order_added after insert on data</span></span><br><span class="line"><span class="string">    begin</span></span><br><span class="line"><span class="string">    insert into log(timestamp, payload) values(datetime(), new.order_id || ' ' || new.timestamp || ' ' || new.price);</span></span><br><span class="line"><span class="string">    end;</span></span><br><span class="line"><span class="string">    """</span>.trimIndent()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="InvalidationTracer-room-table-modification-log-表"><a href="#InvalidationTracer-room-table-modification-log-表" class="headerlink" title="InvalidationTracer, room_table_modification_log 表"></a>InvalidationTracer, room_table_modification_log 表</h3><p>首先我们看下 InvalidationTracer 的构造调用</p>
<p>AppDatabase_Impl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> InvalidationTracker <span class="title">createInvalidationTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> HashMap&lt;String, String&gt; _shadowTablesMap = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">0</span>);</span><br><span class="line">  HashMap&lt;String, Set&lt;String&gt;&gt; _viewTables = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> InvalidationTracker(<span class="keyword">this</span>, _shadowTablesMap, _viewTables, <span class="string">"config"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>config 字段就是我们在 AppDatabase 中注册的 Entity 对应的 tableName</p>
<p>InvalidationTracker.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line"><span class="meta">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvalidationTracker</span><span class="params">(RoomDatabase database, Map&lt;String, String&gt; shadowTablesMap,</span></span></span><br><span class="line"><span class="function"><span class="params">        Map&lt;String, Set&lt;String&gt;&gt; viewTables, String... tableNames)</span> </span>&#123;</span><br><span class="line">    mDatabase = database;</span><br><span class="line">    mObservedTableTracker = <span class="keyword">new</span> ObservedTableTracker(tableNames.length);</span><br><span class="line">    mTableIdLookup = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    mViewTables = viewTables;</span><br><span class="line">    mInvalidationLiveDataContainer = <span class="keyword">new</span> InvalidationLiveDataContainer(mDatabase);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = tableNames.length;</span><br><span class="line">    mTableNames = <span class="keyword">new</span> String[size];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> id = <span class="number">0</span>; id &lt; size; id++) &#123;</span><br><span class="line">        <span class="keyword">final</span> String tableName = tableNames[id].toLowerCase(Locale.US);</span><br><span class="line">        mTableIdLookup.put(tableName, id);</span><br><span class="line">        String shadowTableName = shadowTablesMap.get(tableNames[id]);</span><br><span class="line">        <span class="keyword">if</span> (shadowTableName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTableNames[id] = shadowTableName.toLowerCase(Locale.US);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mTableNames[id] = tableName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Adjust table id lookup for those tables whose shadow table is another already mapped</span></span><br><span class="line">    <span class="comment">// table (e.g. external content fts tables).</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; shadowTableEntry : shadowTablesMap.entrySet()) &#123;</span><br><span class="line">        String shadowTableName = shadowTableEntry.getValue().toLowerCase(Locale.US);</span><br><span class="line">        <span class="keyword">if</span> (mTableIdLookup.containsKey(shadowTableName)) &#123;</span><br><span class="line">            String tableName = shadowTableEntry.getKey().toLowerCase(Locale.US);</span><br><span class="line">            mTableIdLookup.put(tableName, mTableIdLookup.get(shadowTableName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有几个数据结构需要注意</p>
<ol>
<li>mTableIdLookup 记录了 tableName 和 index 的关系。例如这里”config”-&gt;0</li>
<li>mTableNames 数组依次记录了 tableName。例如这里, mTableNames.length = 1, mTableNames[0] = “config”</li>
<li>mDatabase 即 AppDatabase_Impl 对象</li>
<li>mObservedTableTracker 是一个 ObservedTableTracker 对象，这个对象内部维护了三个数组:<ol>
<li>mTableObservers, 一个 long 数组</li>
<li>mTriggerStates, 一个 boolean 数组</li>
<li>mTriggerStateChanges, 一个 int 数组</li>
</ol>
</li>
</ol>
<p>再来关注下<code>InvalidationTracker#internalInit</code>的调用链，查阅源码可以得到</p>
<p><code>SupportSQLiteOpenHelper.Callback#onOpen</code>-&gt;<code>AppDatabase_Impl#internalInitInvalidationTracker</code>-&gt;<br><code>InvalidationTracker#internalInit</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">internalInit</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mInitialized) &#123;</span><br><span class="line">            Log.e(Room.LOG_TAG, <span class="string">"Invalidation tracker is initialized twice :/."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// These actions are not in a transaction because temp_store is not allowed to be</span></span><br><span class="line">        <span class="comment">// performed on a transaction, and recursive_triggers is not affected by transactions.</span></span><br><span class="line">        database.execSQL(<span class="string">"PRAGMA temp_store = MEMORY;"</span>);</span><br><span class="line">        database.execSQL(<span class="string">"PRAGMA recursive_triggers='ON';"</span>);</span><br><span class="line">        database.execSQL(CREATE_TRACKING_TABLE_SQL);</span><br><span class="line">        syncTriggers(database);</span><br><span class="line">        mCleanupStatement = database.compileStatement(RESET_UPDATED_TABLES_SQL);</span><br><span class="line">        mInitialized = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们把 sql 语句串联一下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">PRAGMA</span> temp_store = <span class="keyword">MEMORY</span>;</span><br><span class="line"><span class="keyword">PRAGMA</span> recursive_triggers=<span class="string">'ON'</span>;</span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TABLE</span> room_table_modification_log (table_id <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span>, invalidated <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>);</span><br><span class="line"><span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated <span class="number">0</span> <span class="keyword">WHERE</span> invalidated = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>创建了一个 In-memory 的临时表 room_table_modification_log</li>
<li>主键 table_id, 我们这里可以猜测这个 table_id 应该就和构造函数里提到的 id 概念对应</li>
<li>invalidated 字段，字面意思应该是表示数据是否有效</li>
</ol>
<p>在 CREATE 语句和 UPDATE 语句之间，还有一个 syncTriggers 调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">syncTriggers</span><span class="params">(SupportSQLiteDatabase database)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (database.inTransaction()) &#123;</span><br><span class="line">        <span class="comment">// we won't run this inside another transaction.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// This method runs in a while loop because while changes are synced to db, another</span></span><br><span class="line">        <span class="comment">// runnable may be skipped. If we cause it to skip, we need to do its work.</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            Lock closeLock = mDatabase.getCloseLock();</span><br><span class="line">            closeLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// there is a potential race condition where another mSyncTriggers runnable</span></span><br><span class="line">                <span class="comment">// can start running right after we get the tables list to sync.</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span>[] tablesToSync = mObservedTableTracker.getTablesToSync();  <span class="comment">// #1</span></span><br><span class="line">                <span class="keyword">if</span> (tablesToSync == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> limit = tablesToSync.length;</span><br><span class="line">                database.beginTransaction();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> tableId = <span class="number">0</span>; tableId &lt; limit; tableId++) &#123;</span><br><span class="line">                        <span class="keyword">switch</span> (tablesToSync[tableId]) &#123;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.ADD:</span><br><span class="line">                                startTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            <span class="keyword">case</span> ObservedTableTracker.REMOVE:</span><br><span class="line">                                stopTrackingTable(database, tableId);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    database.setTransactionSuccessful();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    database.endTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">                mObservedTableTracker.onSyncCompleted();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                closeLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException | SQLiteException exception) &#123;</span><br><span class="line">        <span class="comment">// may happen if db is closed. just log.</span></span><br><span class="line">        Log.e(Room.LOG_TAG, <span class="string">"Cannot run invalidation tracker. Is the db closed?"</span>,</span><br><span class="line">                exception);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着看下#1 这里， <code>ObservedTableTracker#getTablesToSync()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">int</span>[] getTablesToSync() &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mNeedsSync || mPendingSync) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> tableCount = mTableObservers.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tableCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> newState = mTableObservers[i] &gt; <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (newState != mTriggerStates[i]) &#123;</span><br><span class="line">                mTriggerStateChanges[i] = newState ? ADD : REMOVE;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mTriggerStateChanges[i] = NO_OP;</span><br><span class="line">            &#125;</span><br><span class="line">            mTriggerStates[i] = newState;</span><br><span class="line">        &#125;</span><br><span class="line">        mPendingSync = <span class="keyword">true</span>;</span><br><span class="line">        mNeedsSync = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> mTriggerStateChanges;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果不需要同步(!mNeedSync)或者正在同步(mPendingSync)，返回 null</p>
<p>否则</p>
<p>我们对每个 table_id 做判断，在当前场景下, mTableObservers[0] = 0, mTriggerStates[0] = false, mTriggerStateChanges[0] = 0, 经过算法后<br>mTableObservers[0] = 0, mTriggerStates[0] = false, mTriggerStateChanges[0] = NO_OP</p>
<p>回到 syncTriggers 这里，返回了一个 NO_OP，那么什么事情都不做。直接返回</p>
<p>那么时候才会走到 startTrackingTable 或者 stopTrackingTable 呢？针对这个问题，我们看下 ObservedTableTracker.ADD 的赋值位置:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> newState = mTableObservers[i] &gt; <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> (newState != mTriggerStates[i]) &#123;</span><br><span class="line">    mTriggerStateChanges[i] = newState ? ADD : REMOVE;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mTriggerStateChanges[i] = NO_OP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 newState = mTableObservers[i] &gt; 0 成立时才会是 ADD, 那么我们看看什么时候 mTableObservers[i] &gt; 0，可以发现是<code>ObservedTableTracker#onAdded调用</code></p>
<p>onAdded 调用链:</p>
<p><code>InvalidationTracker#addObserver</code>-&gt;<code>InvalidationTracker#onAdded()</code></p>
<p><code>InvalidationTracker#addWeakObserver</code>-&gt;<code>InvalidationTracker#addObserver</code>-&gt;<code>InvalidationTracker#onAdded()</code></p>
<p>addWeakObserver 则用在了<code>RoomTrackingLiveData#mRefreshRunnable</code>或<code>LimitOffsetDataSource()</code></p>
<p>这里我们可以大致做一个推断</p>
<ol>
<li>paging 或 ROOM 中对 LiveData 的支持，依赖了 addObserver 或者 addWeakObserver 来实现，这是必然的。因为二者是一个典型的观察者模式范型的表现</li>
</ol>
<p>接下来我们看看 addObserver 的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint</span>(<span class="string">"RestrictedApi"</span>)</span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(@NonNull Observer observer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String[] tableNames = resolveViews(observer.mTables);</span><br><span class="line">    <span class="keyword">int</span>[] tableIds = <span class="keyword">new</span> <span class="keyword">int</span>[tableNames.length];</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = tableNames.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        Integer tableId = mTableIdLookup.get(tableNames[i].toLowerCase(Locale.US));</span><br><span class="line">        <span class="keyword">if</span> (tableId == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"There is no table with name "</span> + tableNames[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        tableIds[i] = tableId;</span><br><span class="line">    &#125;</span><br><span class="line">    ObserverWrapper wrapper = <span class="keyword">new</span> ObserverWrapper(observer, tableIds, tableNames);</span><br><span class="line">    ObserverWrapper currentObserver;</span><br><span class="line">    <span class="keyword">synchronized</span> (mObserverMap) &#123;</span><br><span class="line">        currentObserver = mObserverMap.putIfAbsent(observer, wrapper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (currentObserver == <span class="keyword">null</span> &amp;&amp; mObservedTableTracker.onAdded(tableIds)) &#123;</span><br><span class="line">        syncTriggers();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>observer.mTables 就是 observer 所观察的 tableName 数组, 是 String[], 我们这里可以假设是[“config”], resolveViews 主要解决了数据库的视图映射，这里我们不涉及。可以直接理解 tableNames=[“config”], 后续算法我们可以得到 tablesIds.length = 1, tablesIds[0] = 0. 之后做了两件事情</p>
<ol>
<li>将一个 ObserverWrapper 对象放到 mObserverMap 中，map 维护了一个 Observer 和 ObserverWrapper 关系</li>
<li>如果是第一次加入 observerMap 的 observer 对象，调用 onAdded()</li>
<li>如果 2 的基础上，onAdded()返回 true，调用 syncTriggers()</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">onAdded</span><span class="params">(<span class="keyword">int</span>... tableIds)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> needTriggerSync = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> tableId : tableIds) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> prevObserverCount = mTableObservers[tableId];</span><br><span class="line">            mTableObservers[tableId] = prevObserverCount + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (prevObserverCount == <span class="number">0</span>) &#123;</span><br><span class="line">                mNeedsSync = <span class="keyword">true</span>;</span><br><span class="line">                needTriggerSync = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> needTriggerSync;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对每个 tableId 做了判断, 如果其之前从没有过 observer 对该 tableId 进行监听, 那么就需要进行一次 sync(needTriggerSync = true)</p>
<p>回忆一下之前对 getTablesToSync 的分析，此时 mTableObservers[tableId]&gt;0, 那么在 syncTriggers()逻辑中就会得到一个 ADD 指令, 我们看看 ADD 对应的<code>startTrackingTable</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startTrackingTable</span><span class="params">(SupportSQLiteDatabase writableDb, <span class="keyword">int</span> tableId)</span> </span>&#123;</span><br><span class="line">    writableDb.execSQL(</span><br><span class="line">            <span class="string">"INSERT OR IGNORE INTO "</span> + UPDATE_TABLE_NAME + <span class="string">" VALUES("</span> + tableId + <span class="string">", 0)"</span>);</span><br><span class="line">    <span class="keyword">final</span> String tableName = mTableNames[tableId];</span><br><span class="line">    StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (String trigger : TRIGGERS) &#123;</span><br><span class="line">        stringBuilder.setLength(<span class="number">0</span>);</span><br><span class="line">        stringBuilder.append(<span class="string">"CREATE TEMP TRIGGER IF NOT EXISTS "</span>);</span><br><span class="line">        appendTriggerName(stringBuilder, tableName, trigger);</span><br><span class="line">        stringBuilder.append(<span class="string">" AFTER "</span>)</span><br><span class="line">                .append(trigger)</span><br><span class="line">                .append(<span class="string">" ON `"</span>)</span><br><span class="line">                .append(tableName)</span><br><span class="line">                .append(<span class="string">"` BEGIN UPDATE "</span>)</span><br><span class="line">                .append(UPDATE_TABLE_NAME)</span><br><span class="line">                .append(<span class="string">" SET "</span>).append(INVALIDATED_COLUMN_NAME).append(<span class="string">" = 1"</span>)</span><br><span class="line">                .append(<span class="string">" WHERE "</span>).append(TABLE_ID_COLUMN_NAME).append(<span class="string">" = "</span>).append(tableId)</span><br><span class="line">                .append(<span class="string">" AND "</span>).append(INVALIDATED_COLUMN_NAME).append(<span class="string">" = 0"</span>)</span><br><span class="line">                .append(<span class="string">"; END"</span>);</span><br><span class="line">        writableDb.execSQL(stringBuilder.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们尝试把所有 sql 展开得到</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">OR</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> room_table_modification_log <span class="keyword">VALUES</span>($tableId, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`room_table_modification_trigger_$tableName_UPDATE`</span> <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> <span class="string">`$tableName`</span> <span class="keyword">BEGIN</span> <span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated = <span class="number">1</span> <span class="keyword">WHERE</span> tableId = $tableId <span class="keyword">AND</span> invalidated = <span class="number">0</span>; <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`room_table_modification_trigger_$tableName_REMOVE`</span> <span class="keyword">AFTER</span> REMOVE <span class="keyword">ON</span> <span class="string">`$tableName`</span> <span class="keyword">BEGIN</span> <span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated = <span class="number">1</span> <span class="keyword">WHERE</span> tableId = $tableId <span class="keyword">AND</span> invalidated = <span class="number">0</span>; <span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> TEMP <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`room_table_modification_trigger_$tableName_INSERT`</span> <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`$tableName`</span> <span class="keyword">BEGIN</span> <span class="keyword">UPDATE</span> room_table_modification_log <span class="keyword">SET</span> invalidated = <span class="number">1</span> <span class="keyword">WHERE</span> tableId = $tableId <span class="keyword">AND</span> invalidated = <span class="number">0</span>; <span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>这一段就是在 DB，建立了对不同的表的有效值 trigger 机制, 通过这个 trigger 的设置，我们能进一步理解 room_table_modification_log 的作用</p>
<table>
<thead>
<tr>
<th>表名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tableId</td>
<td>唯一值，与上层 Entity 中的 tableName 构成一一对应</td>
</tr>
<tr>
<td>invalidated</td>
<td>0 或 1，1 表示数据有更新</td>
</tr>
</tbody>
</table>
<p>那么综合一下上述分析:</p>
<ol>
<li>当且仅当一个表首次被监听时, 我们会创建一组 trigger，对这个表的数据更新状态通过 invalidated 进行表示</li>
<li>在 Java 层，我们使用一个 Map 保存了 Observer 的映射关系，以便后续观察到数据变化时唤起</li>
</ol>
<p>看完了监听的建立，我们就要来看看如何唤起这个监听了</p>
<h3 id="InvalidationTracker-观察者模式的触发"><a href="#InvalidationTracker-观察者模式的触发" class="headerlink" title="InvalidationTracker 观察者模式的触发"></a>InvalidationTracker 观察者模式的触发</h3><p>首先需要明确的是，我们肯定是要获得 DB 中哪些表的数据进行了更新，根据上述分析。我们可以从 room_table_modification_log 中 invalidated=1 的项进行分析。那么遵循这个思路，我们查阅代码中对 room_table_modification_log 的查询操作</p>
<p>InvalidationTracker#mRefreshRunnable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Lock closeLock = mDatabase.getCloseLock();</span><br><span class="line">        Set&lt;Integer&gt; invalidatedTableIds = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            closeLock.lock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!ensureInitialization()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!mPendingRefresh.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="comment">// no pending refresh</span></span><br><span class="line">                <span class="comment">// 防止重入</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDatabase.inTransaction()) &#123;</span><br><span class="line">                <span class="comment">// current thread is in a transaction. when it ends, it will invoke</span></span><br><span class="line">                <span class="comment">// refreshRunnable again. mPendingRefresh is left as false on purpose</span></span><br><span class="line">                <span class="comment">// so that the last transaction can flip it on again.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mDatabase.mWriteAheadLoggingEnabled) &#123; <span class="comment">// #1</span></span><br><span class="line">                <span class="comment">// This transaction has to be on the underlying DB rather than the RoomDatabase</span></span><br><span class="line">                <span class="comment">// in order to avoid a recursive loop after endTransaction.</span></span><br><span class="line">                SupportSQLiteDatabase db = mDatabase.getOpenHelper().getWritableDatabase();</span><br><span class="line">                db.beginTransaction();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    invalidatedTableIds = checkUpdatedTable();</span><br><span class="line">                    db.setTransactionSuccessful();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    db.endTransaction();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invalidatedTableIds = checkUpdatedTable();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException | SQLiteException exception) &#123;</span><br><span class="line">            <span class="comment">// may happen if db is closed. just log.</span></span><br><span class="line">            Log.e(Room.LOG_TAG, <span class="string">"Cannot run invalidation tracker. Is the db closed?"</span>,</span><br><span class="line">                    exception);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (invalidatedTableIds != <span class="keyword">null</span> &amp;&amp; !invalidatedTableIds.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mObserverMap) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;Observer, ObserverWrapper&gt; entry : mObserverMap) &#123;</span><br><span class="line">                    entry.getValue().notifyByTableInvalidStatus(invalidatedTableIds); <span class="comment">// #2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Set&lt;Integer&gt; <span class="title">checkUpdatedTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ArraySet&lt;Integer&gt; invalidatedTableIds = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">        Cursor cursor = mDatabase.query(<span class="keyword">new</span> SimpleSQLiteQuery(SELECT_UPDATED_TABLES_SQL));  <span class="comment">// #3</span></span><br><span class="line">        <span class="comment">//noinspection TryFinallyCanBeTryWithResources</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过cursor读到 invalidatedTableIds，略去</span></span><br><span class="line">        <span class="keyword">if</span> (!invalidatedTableIds.isEmpty()) &#123;</span><br><span class="line">            mCleanupStatement.executeUpdateDelete(); <span class="comment">// 有数据更新，重置下invalidated标志位</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> invalidatedTableIds;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>通过 checkUpdatedTable 函数，我们得到了所有 invalidated=1 的 tableId，之后在 mObserverMap 中通知观察者 notifyByTableInvalidStatus</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notifyByTableInvalidStatus</span><span class="params">(Set&lt;Integer&gt; invalidatedTablesIds)</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; invalidatedTables = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mTableIds.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> index = <span class="number">0</span>; index &lt; size; index++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> tableId = mTableIds[index];</span><br><span class="line">        <span class="keyword">if</span> (invalidatedTablesIds.contains(tableId)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (size == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// Optimization for a single-table observer</span></span><br><span class="line">                invalidatedTables = mSingleTableSet;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (invalidatedTables == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    invalidatedTables = <span class="keyword">new</span> ArraySet&lt;&gt;(size);</span><br><span class="line">                &#125;</span><br><span class="line">                invalidatedTables.add(mTableNames[index]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (invalidatedTables != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mObserver.onInvalidated(invalidatedTables);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>invalidatedTables 记录了 tableId 对应的原 Entity 对应的 table_name, onInvalidated 则是接口，由 Observer 自己实现，这里我们以 RoomTrackingLiveData 分析一下，找到其内部聚合的<code>onInvalidated</code>实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@SuppressLint</span>(&#123;<span class="string">"RestrictedApi"</span>&#125;)</span><br><span class="line">RoomTrackingLiveData(RoomDatabase database, InvalidationLiveDataContainer container, <span class="keyword">boolean</span> inTransaction, Callable&lt;T&gt; computeFunction, String[] tableNames) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.mObserver = <span class="keyword">new</span> Observer(tableNames) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInvalidated</span><span class="params">(@NonNull Set&lt;String&gt; tables)</span> </span>&#123;</span><br><span class="line">            ArchTaskExecutor.getInstance().executeOnMainThread(RoomTrackingLiveData.<span class="keyword">this</span>.mInvalidationRunnable); <span class="comment">// #1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Runnable mInvalidationRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@MainThread</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> isActive = RoomTrackingLiveData.<span class="keyword">this</span>.hasActiveObservers();</span><br><span class="line">        <span class="keyword">if</span> (RoomTrackingLiveData.<span class="keyword">this</span>.mInvalid.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>) &amp;&amp; isActive) &#123;</span><br><span class="line">            RoomTrackingLiveData.<span class="keyword">this</span>.getQueryExecutor().execute(RoomTrackingLiveData.<span class="keyword">this</span>.mRefreshRunnable); <span class="comment">// #2</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Runnable mRefreshRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (RoomTrackingLiveData.<span class="keyword">this</span>.mRegisteredObserver.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        RoomTrackingLiveData.<span class="keyword">this</span>.mDatabase.getInvalidationTracker().addWeakObserver(RoomTrackingLiveData.<span class="keyword">this</span>.mObserver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> computed;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        computed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (RoomTrackingLiveData.<span class="keyword">this</span>.mComputing.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Object value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(RoomTrackingLiveData.<span class="keyword">this</span>.mInvalid.compareAndSet(<span class="keyword">true</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                    computed = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        value = RoomTrackingLiveData.<span class="keyword">this</span>.mComputeFunction.call();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Exception while computing database live data."</span>, var7);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (computed) &#123;</span><br><span class="line">                    RoomTrackingLiveData.<span class="keyword">this</span>.postValue(value); <span class="comment">// #3</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                RoomTrackingLiveData.<span class="keyword">this</span>.mComputing.set(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(computed &amp;&amp; RoomTrackingLiveData.<span class="keyword">this</span>.mInvalid.get());</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>篇幅问题这里不分析 RoomTrackingLiveData 的仔细实现，从关键的#1, #2, #3 看，RoomTrackingLiveData 利用这个 Observer，当<code>Observer#onInvalidated</code>被触发的时候, 对 DB 进行了<code>mComputeFunction#call()</code>操作，这个我们可以直接猜测就是上层的 DB 查询具体实现，这个由具体的 DAO 层解释。然后调用 postValue 来刷新 LiveData 的值</p>
<p>分析完整个监听被触发的过程，有一个问题没有解释，就是<code>InvalidationTracker#mRefreshRunnable</code>是如何被调用的</p>
<p>追溯源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshVersionsAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// TODO we should consider doing this sync instead of async.</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingRefresh.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        mDatabase.getQueryExecutor().execute(mRefreshRunnable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestrictTo</span>(RestrictTo.Scope.LIBRARY_GROUP_PREFIX)</span><br><span class="line"><span class="meta">@WorkerThread</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshVersionsSync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    syncTriggers();</span><br><span class="line">    mRefreshRunnable.run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>追溯调用链</p>
<ol>
<li><p><code>RoomDatabase#endTransaction()</code>-&gt;<code>InvalidationTracker#refreshVersionsAsync()</code></p>
</li>
<li><p><code>LimitOffsetDataSource#isInvalid()</code>-&gt;<code>InvalidationTracker#refreshVersionsSync()</code></p>
</li>
</ol>
<p>篇幅问题，不分析跟 Paging Library 关联大的 2。分析一下 1</p>
<p>实际上，在[ROOM 的线程安全是如何保证的]这节的第三部分，我们已经能发现 Dao 层的 DB 操作都是依赖 beginTransaction, endTransaction 来完成 DB 事务的。也就是说，只要 DAO 层有 DB 事务发生，那么 ROOM 必定会在 getQueryExecutor()的线程池中，执行 mRefreshRunnable, 如果发现了有数据更新的 table，就将这些 table 信息全部抛给<code>Observer#onInvalidated</code>处理</p>
<h2 id="InvalidationTracker-小结"><a href="#InvalidationTracker-小结" class="headerlink" title="InvalidationTracker 小结"></a>InvalidationTracker 小结</h2><p><code>InvalidationTracker</code>的职责即建立了业务对 DB 数据写的观察者模式, 业务的 Observer 被<code>InvalidationTracker</code>聚合持有，同时建立一个临时表<code>room_table_modification_log</code></p>
<table>
<thead>
<tr>
<th>表名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>tableId</td>
<td>唯一值，与上层 Entity 中的 tableName 构成一一对应</td>
</tr>
<tr>
<td>invalidated</td>
<td>0 或 1，1 表示数据有更新</td>
</tr>
</tbody>
</table>
<p>当某个表被业务监听时，对这个表创建 trigger 建立观察者模式，监听这张表的写操作，trigger 被触发时就写<code>room_table_modification_log</code></p>
<p>DAO 层业务代码委托<code>RoomDatabase</code>通过<code>beginTransaction</code>, <code>endTransaction</code>来完成 DB 的事务提交，这些函数被调用时，顺带触发了<code>InvalidationTracker</code>内部对表<code>room_table_modification_log</code>的异步查询，查询到有数据更新<code>(invalidated=1）</code>的表名信息, 将这些表名信息带给<code>Observer#onInvalidated</code>的参数中。例如 RoomTrackingLiveData 中, 利用<code>InvalidationTracker</code>建立的这套机制，实现了 DAO 层 LiveData 的持有数据实时更新的特性</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2020/03/28/ROOM%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E6%9E%90/" data-id="ckgx4rr7s0011i8x7tzo2mdeg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-ROOM/" rel="tag">Android, ROOM</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-focus概念" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/14/Android-focus%E6%A6%82%E5%BF%B5/" class="article-date">
  <time datetime="2020-02-14T09:52:43.000Z" itemprop="datePublished">2020-02-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/14/Android-focus%E6%A6%82%E5%BF%B5/">Android focus概念</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Android-focus-相关概念"><a href="#Android-focus-相关概念" class="headerlink" title="Android focus 相关概念"></a>Android focus 相关概念</h1><h2 id="focus"><a href="#focus" class="headerlink" title="focus"></a>focus</h2><p>焦点实际上是窗口系统中一个重要概念，如果一个窗体获得了焦点，其含义是该窗体获得了可交互的机会。在 android 中也是如此，例如一个 EditText，只有当其获得了焦点时，我们才能通过键盘对其做输入操作</p>
<h2 id="focusable-amp-amp-focusableInTouchMode"><a href="#focusable-amp-amp-focusableInTouchMode" class="headerlink" title="focusable &amp;&amp; focusableInTouchMode"></a>focusable &amp;&amp; focusableInTouchMode</h2><p>这两个属性是比较容易造成理解混淆。</p>
<p>首先我们看下<code>focusableInTouchMode</code>的官方定义</p>
<pre><code>Boolean that controls whether a view can take focus while in touch mode. If this is true for a view, that view can gain focus when clicked on, and can keep focus if another view is clicked on that doesn&apos;t have this attribute set to true.
</code></pre><p>翻译一下，如果设置为 true，那么当其被触摸点击时，就有能力获得焦点；并且其他为 false 的 View 的点击都不能夺取这个焦点。</p>
<p>举例来说，如果有一个 EditText 其<code>focusableInTouchMode</code>为 true, 那么我们在屏幕上对其点击就会拉起虚拟键盘。</p>
<p>另外，有些业务场景是点击 EditText 后不拉起键盘，而是弹起 Dialog 来输入的场景。那么这个时候最简单的方案就是设置<code>focusableInTouchMode</code>为 false，然后给这个 EditText 的点击事件实现你的弹窗逻辑</p>
<p>但这里就有个冲突，如果<code>focusableInTouchMode</code>为 true，那么此时我对 Widget 的点击到底算是点击(click)事件还是算作 focus 事件呢？答案是算作 focus 事件，所以有时候你会遇到给 Button 设置<code>focusableInTouchMode</code>为 true 后，每次第一次点击都不触发 onClick 的问题， 因为其 focus 的逻辑会优先 click 逻辑触发</p>
<p>事实上，任何窗体系统的交互其实是要分为两步走的:</p>
<ol>
<li>找到特定的 Widget，让其获得焦点</li>
<li>开始交互(输入, 点击等)</li>
</ol>
<p>因此获取焦点的逻辑应该都是优先触发的</p>
<p>这里有个疑问是为什么额外需要一个 touchMode，我的理解是跟 android 机器面临的历史问题，历史上 android 机器曾经是有软硬件两种操作方式的。有些古老手机上会保留类似滚球的操作设备来在不同窗体上 focus。另外，类似智能电视这样的设备上也会有硬件(遥控器), 触摸屏两种交互的方式.</p>
<p>而 focusable 则是表示一个 Widget 是否能被 focus，如果这个属性设置成 false，那么这个 Widget 是不能获得焦点的，用户也无法与这个 Widget 进行交互(例如输入)</p>
<p>同时根据文档描述</p>
<pre><code>Setting this to false will also ensure that this view is not focusable in touch mode.
</code></pre><p>这个属性为 false 时，会将<code>focusableInTouchMode</code>也变成 false</p>
<p>在代码中，我们发现<code>View#setFocusable</code>有一个 int 作为参数，除去两个常见的<code>FOCUSABLE</code>和<code>NOT_FOCUSABLE</code>对应 xml 中的 true 和 false 外，我们看到其还有一个选项, <code>FOCUSABLE_AUTO</code>. 根据注释，这个是 Widget 的默认 focusable 值，android 系统会自动决定 Widget 的焦点</p>
<h2 id="descendantFocusability-属性"><a href="#descendantFocusability-属性" class="headerlink" title="descendantFocusability 属性"></a>descendantFocusability 属性</h2><p>这个属性常常用在 ViewGroup，用来定义这个 ViewGroup 和其子 View 之间获取焦点时的关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">+------------------------------------------------------------------------------------------+</span><br><span class="line">|      Constant            Value            Description                                    |</span><br><span class="line">+------------------------------------------------------------------------------------------+</span><br><span class="line">| afterDescendants           1          The ViewGroup will get focus only if               |</span><br><span class="line">|                                       none of its descendants want it.                   |</span><br><span class="line">+------------------------------------------------------------------------------------------+</span><br><span class="line">| beforeDescendants          0          The ViewGroup will get focus before                |</span><br><span class="line">|                                       any of its descendants.                            |</span><br><span class="line">+------------------------------------------------------------------------------------------+</span><br><span class="line">| blocksDescendants          2          The ViewGroup will block its descendants from      |</span><br><span class="line">|                                       receiving focus.                                   |</span><br><span class="line">+------------------------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<p>也就是说，根据不同的定义，ViewGroup 有能力在子 View 之前，之后，或者阻止子 View 获取焦点</p>
<p>那么这个属性的使用场景是什么呢? 例如你要在一个 ListView 里面与 item 的某个元素做交互, 那么你是希望子 View 先于 ListView 交互的(这样才能避免 ListView 的焦点逻辑优先触发), 此时设置 afterDescendants 就是有用的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onItemSelected</span><span class="params">(AdapterView&lt;?&gt; parent, View view,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> position, <span class="keyword">long</span> id)</span> </span>&#123;</span><br><span class="line">    ListView listView = getListView();</span><br><span class="line">    Log.d(TAG, <span class="string">"onItemSelected gave us "</span> + view.toString());</span><br><span class="line">    Button b = (Button) view.findViewById(R.id.button);</span><br><span class="line">    EditText et = (EditText) view.findViewById(R.id.editor);</span><br><span class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span> || et != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Use afterDescendants to keep ListView from getting focus</span></span><br><span class="line">        listView.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span><br><span class="line">        <span class="keyword">if</span>(et!=<span class="keyword">null</span>) et.requestFocus();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(b!=<span class="keyword">null</span>) b.requestFocus();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!listView.isFocused()) &#123;</span><br><span class="line">            <span class="comment">// Use beforeDescendants so that previous selections don't re-take focus</span></span><br><span class="line">            listView.setDescendantFocusability(ViewGroup.FOCUS_BEFORE_DESCENDANTS);</span><br><span class="line">            listView.requestFocus();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2020/02/14/Android-focus%E6%A6%82%E5%BF%B5/" data-id="ckgx4rr6s0002i8x77l1ck3gp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android-TextView绘制技巧" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/12/Android-TextView%E7%BB%98%E5%88%B6%E6%8A%80%E5%B7%A7/" class="article-date">
  <time datetime="2020-01-12T01:22:37.000Z" itemprop="datePublished">2020-01-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/12/Android-TextView%E7%BB%98%E5%88%B6%E6%8A%80%E5%B7%A7/">Android TextView绘制技巧</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="文本绘制概念"><a href="#文本绘制概念" class="headerlink" title="文本绘制概念"></a>文本绘制概念</h2><ul>
<li>Top - The maximum distance above the baseline for the tallest glyph in the font at a given text size.</li>
<li>Ascent - The recommended distance above the baseline for singled spaced text.</li>
<li>Descent - The recommended distance below the baseline for singled spaced text.</li>
<li>Bottom - The maximum distance below the baseline for the lowest glyph in the font at a given text size.</li>
<li>Leading - The recommended additional space to add between lines of text.</li>
</ul>
<img src="/2020/01/12/Android-TextView绘制技巧/android_textview.png">
<p>这套概念在<code>android.text.Layout</code>中也成立</p>
<p>需要注意的是 android.text.Layout 也是从 0 计算的, 对于其 API getLineBottom, getLineBaseline, getLineTop…. 都是从 0 计算的</p>
<p>同时, android.text.TextView#getLayout()方法必定在 measure 过程结束后才能非空</p>
<h2 id="TextView-Layout-奇招"><a href="#TextView-Layout-奇招" class="headerlink" title="TextView#Layout 奇招"></a>TextView#Layout 奇招</h2><p>TextView 的 Layout 属性管理了文本的布局展示，同时也提供了两个能力，</p>
<p>获取省略号在当前行的开始位置；<br>获取当前行内被省略文字的长度。</p>
<pre><code>/** * Return the offset of the first character to be ellipsized away, * relative to the start of the line. (So 0 if the beginning of the * line is ellipsized, not getLineStart().) */
public abstract int getEllipsisStart(int line);

/** * Returns the number of characters to be ellipsized away, or 0 if * no ellipsis is to take place. */
public abstract int getEllipsisCount(int line);
</code></pre><p>有了以上能力，针对上文最后提到的问题马上便会有思路：通过精确计算被省略的文字位置，截取字符串重新插入占位标识符，然后实现在省略号处添加图片</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String text = guessLikeBean.getTitle()+<span class="string">"(精)"</span>;</span><br><span class="line">mTvTitle.setText(text);</span><br><span class="line"><span class="keyword">int</span> ellipsisCount = mTvTitle.getLayout().getEllipsisCount(mTvTitle.getLineCount() - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (ellipsisCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    text = text.substring(<span class="number">0</span>, text.length() - ellipsisCount - <span class="number">1</span>) + <span class="string">"…(精)"</span>;</span><br><span class="line">&#125;</span><br><span class="line">SpannableString imageString = <span class="keyword">new</span> SpannableString(text);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>同时，为了保证 TextView#getLayout 一定有值，我们可以使用 View#post 函数来调用我们的函数，View#post 会确保 View 在 attach 之后再执行，而 attach 一定保证了 layout 过程先执行</p>
<p>实际上 TextView#Layout 中可以找到很多跟文本相关的属性，在排版的过程中或多或少你会用到，因此遇到文本排版问题时，不妨先试试这个, 例如:</p>
<p>Layout 的一个子类<code>BoringLayout</code>,有一个静态方法<code>isBoring()</code>,可以用来判断一段文字是否能在一行放下，这个方法就有广泛的应用场景</p>
<h2 id="如何绘制居中的图标"><a href="#如何绘制居中的图标" class="headerlink" title="如何绘制居中的图标"></a>如何绘制居中的图标</h2><p>参考<a href="https://gist.github.com/TedaLIEz/97f03a2cb842621f022bd27ba1dfd020" target="_blank" rel="noopener">https://gist.github.com/TedaLIEz/97f03a2cb842621f022bd27ba1dfd020</a></p>
<h2 id="如何判断文字能否塞得下一行"><a href="#如何判断文字能否塞得下一行" class="headerlink" title="如何判断文字能否塞得下一行"></a>如何判断文字能否塞得下一行</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * titleTxt: 文本</span></span><br><span class="line"><span class="comment"> * layout: TextView#Layout</span></span><br><span class="line"><span class="comment"> * title: TextView</span></span><br><span class="line"><span class="comment"> * maxWidth: 期望的view最大宽度</span></span><br><span class="line"><span class="comment"> * spacing: 期望能够剩余出来的宽度, 即文本的最大宽度为maxWidth - spacing</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">badgeHelper</span><span class="params">(titleTxt: <span class="type">String</span>, layout: <span class="type">Layout</span>, title: <span class="type">TextView</span>, maxWidth: <span class="type">Int</span>, spacing: <span class="type">Int</span>)</span></span> : String &#123;</span><br><span class="line">    <span class="keyword">var</span> txt = titleTxt + <span class="string">"精精精"</span></span><br><span class="line">    <span class="keyword">val</span> lineCount = layout.lineCount</span><br><span class="line">    <span class="keyword">if</span> (lineCount == <span class="number">1</span>) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"we have only one line text <span class="variable">$titleTxt</span>, return"</span>)</span><br><span class="line">        <span class="keyword">return</span> txt</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> dWidth = spacing</span><br><span class="line">    <span class="keyword">val</span> lastLineStart = layout.getLineStart(lineCount - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> lastLineStr = txt.replace(<span class="string">'.'</span>, <span class="string">'x'</span>).substring(lastLineStart)</span><br><span class="line">    <span class="keyword">val</span> boring = BoringLayout.isBoring(lastLineStr, title.paint)</span><br><span class="line">    <span class="keyword">if</span> (boring != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">val</span> sW = ScreenUtil.getScreenWidth(title.context)</span><br><span class="line">        <span class="keyword">val</span> px = maxWidth</span><br><span class="line">        <span class="keyword">val</span> width = boring.width</span><br><span class="line">        <span class="keyword">if</span> (sW &lt; px + width) &#123;</span><br><span class="line">            <span class="comment">// text ellipsize</span></span><br><span class="line">            Log.w(TAG, <span class="string">"BoringLayout says it will ellipsize, skip some text now"</span>)</span><br><span class="line">            <span class="keyword">val</span> diff = px + width - sW</span><br><span class="line">            <span class="keyword">val</span> diffSize = ((diff + dWidth) / title.textSize).roundToInt()</span><br><span class="line">            txt = titleTxt.substring(<span class="number">0</span>, titleTxt.length - diffSize) + title.context.getString(R.string.ellipsize_string) + <span class="string">"(精)"</span></span><br><span class="line">            Log.d(TAG, <span class="string">"we change txt from <span class="variable">$titleTxt</span> to <span class="variable">$txt</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> txt</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">val</span> size = (dWidth / title.textSize).roundToInt()</span><br><span class="line">    <span class="keyword">val</span> seq = TextUtils.ellipsize(lastLineStr, title.paint, (title.width - title.paddingRight - title.paddingLeft).toFloat(), TextUtils.TruncateAt.END)</span><br><span class="line">    <span class="keyword">val</span> lastIndexOfDot = seq.lastIndexOf(title.context.getString(R.string.ellipsize_string))</span><br><span class="line">    <span class="keyword">if</span> (lastIndexOfDot != -<span class="number">1</span> &amp;&amp; lastLineStart + lastIndexOfDot - size - <span class="number">3</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"TextUtils says it will ellipsize, skip some text now"</span>)</span><br><span class="line">        txt = titleTxt.substring(<span class="number">0</span>, lastLineStart + lastIndexOfDot - size - <span class="number">3</span>) + title.context.getString(R.string.ellipsize_string) + <span class="string">"(精)"</span></span><br><span class="line">        Log.d(TAG, <span class="string">"we change txt from <span class="variable">$titleTxt</span> to <span class="variable">$txt</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> txt</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ellipsisCount = layout.getEllipsisCount(lineCount - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> (ellipsisCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Layout says it will ellipsize, skip some text now"</span>)</span><br><span class="line">        txt = txt.substring(<span class="number">0</span>, txt.length - ellipsisCount - size - <span class="number">3</span>) + title.context.getString(R.string.ellipsize_string) + <span class="string">"(精)"</span></span><br><span class="line">        Log.d(TAG, <span class="string">"we change txt from <span class="variable">$titleTxt</span> to <span class="variable">$txt</span>"</span>)</span><br><span class="line">        <span class="keyword">return</span> txt</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> txt</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p>ref: <a href="https://stackoverflow.com/a/27631737/4380801" target="_blank" rel="noopener">https://stackoverflow.com/a/27631737/4380801</a></p>
<p>ref: <a href="https://tristanzeng.github.io/2019/05/29/TextView%E5%A4%9A%E8%A1%8C%E6%96%87%E5%AD%97%E8%B6%85%E5%87%BA%E6%97%B6%E5%A6%82%E4%BD%95%E5%9C%A8%E7%9C%81%E7%95%A5%E5%8F%B7%E5%90%8E%E6%B7%BB%E5%8A%A0%E5%9B%BE%E6%A0%87/" target="_blank" rel="noopener">https://tristanzeng.github.io/2019/05/29/TextView%E5%A4%9A%E8%A1%8C%E6%96%87%E5%AD%97%E8%B6%85%E5%87%BA%E6%97%B6%E5%A6%82%E4%BD%95%E5%9C%A8%E7%9C%81%E7%95%A5%E5%8F%B7%E5%90%8E%E6%B7%BB%E5%8A%A0%E5%9B%BE%E6%A0%87/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2020/01/12/Android-TextView%E7%BB%98%E5%88%B6%E6%8A%80%E5%B7%A7/" data-id="ckgx4rr6q0001i8x7s7m2ordm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android-textview/" rel="tag">android, textview</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kotlin协程浅析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/05/Kotlin%E5%8D%8F%E7%A8%8B%E6%B5%85%E6%9E%90/" class="article-date">
  <time datetime="2020-01-05T11:00:55.000Z" itemprop="datePublished">2020-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/05/Kotlin%E5%8D%8F%E7%A8%8B%E6%B5%85%E6%9E%90/">Kotlin协程浅析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本文主要参考 KotlinConf 2017 内容来对 Kotlin 中协程的实现进行解析</p>
<p>TL;DR;</p>
<pre><code>Kotlin的协程本质上仍旧是Callback式的调用, 但采用了CPS的编程范式，使得我们的代码显得线性
</code></pre><p>这里略过对协程的定义，首先我们需要解释 CPS 是什么东西</p>
<h2 id="CPS"><a href="#CPS" class="headerlink" title="CPS()"></a>CPS()</h2><p>CPS 实际上是一种编程风格，根据 wiki 定义</p>
<pre><code>In functional programming, continuation-passing style (CPS) is a style of programming in which control is passed explicitly in the form of a continuation. (from Wikipedia.)
</code></pre><p>举个简单的例子，如果我们定义一类型的函数，这些函数都以 async 开头，并且在函数参数中都带有一个 callback 函数参数，每个函数在执行自己的逻辑完成后，都通过 callback 来处理结果</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">asyncDoSomething</span><span class="params">(param1: <span class="type">Int</span>, param2: <span class="type">Any</span>, callback: (<span class="type">Any</span>?)</span></span> -&gt; <span class="built_in">Unit</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// when execution is done</span></span><br><span class="line">    callback.invoke(result)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种类型的函数中，callback 往往被称作 continuation，因为实际上它表达的是下一个函数执行的逻辑，即这个回调函数决定了程序接下来的行为</p>
<p>上述这种方式就是一种标准的 CPS 实现方式</p>
<p>举一个现实例子来说，例如:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> token = requestToken()</span><br><span class="line">    <span class="keyword">val</span> post = createPost(token, item)</span><br><span class="line">    processPost(post)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里你有一个过程需要三个子过程来完成</p>
<p>对于 requestToken()函数来说，createPost 和 processPost 是其过程的 continuation</p>
<p>那么我们可以尝试把 postItem 这个过程转换为一个 CPS 式的编码范式</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;</span><br><span class="line">    requestToken &#123; token -&gt;</span><br><span class="line">        createPost(token, item) &#123; post -&gt;</span><br><span class="line">            processPost(post)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种写法看上去还算 OK，但是也有很多问题，例如:</p>
<ol>
<li>Callback Hell</li>
<li>过分多的回调，会带来非常大的调用栈开销</li>
</ol>
<p>那么 Kotlin 是如何实现 CPS 的呢？</p>
<h2 id="Kotlin-对-CPS-的实现"><a href="#Kotlin-对-CPS-的实现" class="headerlink" title="Kotlin 对 CPS 的实现"></a>Kotlin 对 CPS 的实现</h2><p>Kotlin 对 CPS 风格的实现，实际上就是解决了 Kotlin 对协程的支持</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">createPost</span><span class="params">(token: <span class="type">Token</span>, item: <span class="type">Item</span>)</span></span> : Post &#123; ... &#125;</span><br></pre></td></tr></table></figure>
<p>实际上会转换为:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Object createPost(Token token, Item item, Continuation&lt;Post&gt; cont) &#123; … &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Continuation</span>&lt;<span class="type">in T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">val</span> context: CoroutineContext</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">resume</span><span class="params">(value: <span class="type">T</span>)</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">resumeWithException</span><span class="params">(exception: <span class="type">Throwable</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以很明显的发现 kotlin 的 Continuation 对象就是一个典型的 Callback</p>
<p>接下来我们来看看 Kotlin 对协程的实现方式</p>
<h2 id="Kotlin-对协程的实现"><a href="#Kotlin-对协程的实现" class="headerlink" title="Kotlin 对协程的实现"></a>Kotlin 对协程的实现</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> token = requestToken()</span><br><span class="line">    <span class="keyword">val</span> post = createPost(token, item)</span><br><span class="line">    processPost(post)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面是一段典型的 kotlin 协程代码，根据之前的讨论，对于协程，我们有一种典型的实现:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;</span><br><span class="line">    requestToken &#123; token -&gt;</span><br><span class="line">        createPost(token, item) &#123; post -&gt;</span><br><span class="line">            processPost(post)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种实现被认为存在回调地狱和栈开销的问题，接下来我们看看 kotlin 是如何解决的</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>, cont: <span class="type">Continuation</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> sm =  cont <span class="keyword">as</span>? ThisSM ?: <span class="keyword">object</span> : ThisSM &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">resume</span><span class="params">(…)</span></span> &#123;</span><br><span class="line">            postItem(<span class="literal">null</span>, <span class="keyword">this</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    switch (sm.label) &#123;</span><br><span class="line">        case <span class="number">0</span>:</span><br><span class="line">            sm.item = item</span><br><span class="line">            sm.label = <span class="number">1</span></span><br><span class="line">            requestToken(sm)</span><br><span class="line">        case <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">val</span> item = sm.item</span><br><span class="line">            <span class="keyword">val</span> token = sm.result <span class="keyword">as</span> Token</span><br><span class="line">            sm.label = <span class="number">2</span></span><br><span class="line">            createPost(token, item, sm)</span><br><span class="line">        …</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，这里 kotlin 实际上是利用状态机来实现 CPS 风格的，对于每一个 suspend point，都有一个唯一的状态值对应，状态机根据不同的状态，执行不同的过程</p>
<p>总结一下:</p>
<ol>
<li>一个 suspend 函数定义了一个状态机</li>
<li>一个协程就是一个状态机的实例，这个实例就是将其调用的 suspend 函数组合在了一起</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2020/01/05/Kotlin%E5%8D%8F%E7%A8%8B%E6%B5%85%E6%9E%90/" data-id="ckgx4rr7j000ni8x7rp8elmhm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kotlin-coroutine/" rel="tag">kotlin, coroutine</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-JSBridge解析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/21/JSBridge%E8%A7%A3%E6%9E%90/" class="article-date">
  <time datetime="2019-12-21T12:10:53.000Z" itemprop="datePublished">2019-12-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/21/JSBridge%E8%A7%A3%E6%9E%90/">JSBridge解析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>利用 webview 的特性，我们设计一个 jsbridge 来实现 js 和 native 的<strong>双向通信</strong></p>
<h3 id="native-和-JS-的调用实现手段"><a href="#native-和-JS-的调用实现手段" class="headerlink" title="native 和 JS 的调用实现手段"></a>native 和 JS 的调用实现手段</h3><h4 id="JavaScript-调用-Native"><a href="#JavaScript-调用-Native" class="headerlink" title="JavaScript 调用 Native"></a>JavaScript 调用 Native</h4><ol>
<li><p>注入 api<br>这种方式的实现要么通过 webview 的借口，向 js 的 window 对象注入能力，js 调用这些能力时直接执行对应的 native 逻辑<br>要么就是在我们实现浏览器的 jsbinding 时，就预埋一些基础能力(类似系统级别的函数接口)</p>
</li>
<li><p>拦截 URL SCHEME</p>
<p>这种实现方式主要依赖 native 的拦截能力，让 js 向一个 native 约定的 scheme 发送请求(例如使用 iframe.src)<br>这种实现的缺陷一是会有 url 长度的隐患，另外创建请求会有耗时</p>
</li>
</ol>
<h4 id="Native-调用-JS"><a href="#Native-调用-JS" class="headerlink" title="Native 调用 JS"></a>Native 调用 JS</h4><pre><code>相对简单，使用webview的evaluateJS类似的接口就可以调用
</code></pre><h3 id="JSBridge-实现方式"><a href="#JSBridge-实现方式" class="headerlink" title="JSBridge 实现方式"></a>JSBridge 实现方式</h3><p>本质上讲，JSBridge 可以当作是一种 RPC，其核心实现就是句柄解析调用，JSBridge 的句柄往往就是一个 BridgeName，同时携带约定数据格式的序列化数据</p>
<p>JS 调用 native 的 RPC 实现是比较简单的，大致可以表达为:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.JSBridge = &#123;</span><br><span class="line">  <span class="comment">// 调用 Native</span></span><br><span class="line">  invoke: <span class="function"><span class="keyword">function</span>(<span class="params">bridgeName, data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 判断环境，获取不同的 nativeBridge</span></span><br><span class="line">    nativeBridge.postMessage(&#123;</span><br><span class="line">      bridgeName: bridgeName,</span><br><span class="line">      data: data || &#123;&#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  receiveMessage: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> bridgeName = msg.bridgeName,</span><br><span class="line">      data = msg.data || &#123;&#125;;</span><br><span class="line">    <span class="comment">// 具体逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里有个问题，目前的调用但是单向的，如何在一次调用实现双向通信呢？这里实际上可以类比 JSONP 机制进行处理</p>
<pre><code>JSONP请求发送时，url参数里有callback参数，其值是当前唯一，且被当前window记录，随后服务器返回的记录中，也会用这个参数值为句柄，调用相应的回调函数
</code></pre><p>因此我们可以参考这个设计，在我们的 jsbridge 设计一个 id 的生成器，和一个 id 保持一对一映射关系的 map，每次 js 调用 native 时，将这个 id 一并带给 native，native 不做理解，透传这个 id 回到 js 端，js 可以利用这个 id 在 map 中寻找到对应的 callback，调用对应的回调。用代码描述如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id = <span class="number">0</span>,</span><br><span class="line">        callbacks = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.JSBridge = &#123;</span><br><span class="line">        <span class="comment">// 调用 Native</span></span><br><span class="line">        invoke: <span class="function"><span class="keyword">function</span>(<span class="params">bridgeName, callback, data</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 判断环境，获取不同的 nativeBridge</span></span><br><span class="line">            <span class="keyword">var</span> thisId = id ++; <span class="comment">// 获取唯一 id</span></span><br><span class="line">            callbacks[thisId] = callback; <span class="comment">// 存储 Callback</span></span><br><span class="line">            nativeBridge.postMessage(&#123;</span><br><span class="line">                bridgeName: bridgeName,</span><br><span class="line">                data: data || &#123;&#125;,</span><br><span class="line">                callbackId: thisId <span class="comment">// 传到 Native 端</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        receiveMessage: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> bridgeName = msg.bridgeName,</span><br><span class="line">                data = msg.data || &#123;&#125;,</span><br><span class="line">                callbackId = msg.callbackId; <span class="comment">// Native 将 callbackId 原封不动传回</span></span><br><span class="line">            <span class="comment">// 具体逻辑</span></span><br><span class="line">            <span class="comment">// bridgeName 和 callbackId 不会同时存在</span></span><br><span class="line">            <span class="keyword">if</span> (callbackId) &#123;</span><br><span class="line">                <span class="keyword">if</span> (callbacks[callbackId]) &#123; <span class="comment">// 找到相应句柄</span></span><br><span class="line">                    callbacks[callbackId](msg.data); <span class="comment">// 执行调用</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; elseif (bridgeName) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h2 id="P-S-jsbridge-如何解决加载顺序问题？"><a href="#P-S-jsbridge-如何解决加载顺序问题？" class="headerlink" title="P.S jsbridge 如何解决加载顺序问题？"></a>P.S jsbridge 如何解决加载顺序问题？</h2><p>根据我们之前的分析，jsbridge 的建立应该在业务的 js 执行前调用，那么这里就会有一个强逻辑的假设，我们有没有办法解除这种依赖关系呢？<br>jsbridge 的解决方案是业务的 js 将自己将要调用的 bridge 调用通过闭包的形式传到 window 的一个固定对象中，然后我们在加载 jsbridge 时，从这个约定的固定对象中将所有的调用闭包取出，然后依次调用即可</p>
<p>因为这层逻辑的存在，即使你的 jsbridge 因为网页的 CSP 策略导致加载 bridge 的请求被屏蔽，但由于屏蔽的请求仍旧会触发终端 native 的拦截器代码，你仍旧可以加载 jsbridge，同时利用闭包特性，将请求依次调用回来</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/12/21/JSBridge%E8%A7%A3%E6%9E%90/" data-id="ckgx4rr7f000gi8x7sonj4f92" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebView-JSBridge/" rel="tag">WebView, JSBridge</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kotlin协程实战" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/07/Kotlin%E5%8D%8F%E7%A8%8B%E5%AE%9E%E6%88%98/" class="article-date">
  <time datetime="2019-12-07T11:49:40.000Z" itemprop="datePublished">2019-12-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/07/Kotlin%E5%8D%8F%E7%A8%8B%E5%AE%9E%E6%88%98/">Kotlin协程实战</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#%e5%ad%a6%e4%b9%a0%e8%b7%af%e5%be%84">学习路径</a></li>
<li><a href="#%e5%8d%8f%e7%a8%8b%e5%b0%9d%e8%af%95%e8%a7%a3%e5%86%b3%e4%bb%80%e4%b9%88%e9%97%ae%e9%a2%98">协程尝试解决什么问题</a></li>
<li><a href="#%e5%a6%82%e4%bd%95%e7%90%86%e8%a7%a3-suspend-%e5%85%b3%e9%94%ae%e5%ad%97">如何理解 suspend 关键字</a></li>
<li><a href="#%e5%8d%8f%e7%a8%8b%e4%b8%ad%e7%9a%84%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86">协程中的异常处理</a></li>
<li><a href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">最佳实践</a></li>
</ul>
<h2 id="学习路径"><a href="#学习路径" class="headerlink" title="学习路径"></a>学习路径</h2><ol>
<li><a href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines/#0" target="_blank" rel="noopener">https://codelabs.developers.google.com/codelabs/kotlin-coroutines/#0</a></li>
<li>官方文档</li>
<li><a href="https://kaixue.io/kotlin-coroutines-1/" target="_blank" rel="noopener">https://kaixue.io/kotlin-coroutines-1/</a></li>
</ol>
<p>下面说下个人理解</p>
<h2 id="协程尝试解决什么问题"><a href="#协程尝试解决什么问题" class="headerlink" title="协程尝试解决什么问题"></a>协程尝试解决什么问题</h2><p>从编码角度，协程尝试解决了回调地狱的问题<br>从实现上，协程尝试减少了线程切换的开销</p>
<h2 id="如何理解-suspend-关键字"><a href="#如何理解-suspend-关键字" class="headerlink" title="如何理解 suspend 关键字"></a>如何理解 suspend 关键字</h2><p>TL;DR:</p>
<blockquote>
<p>使用 suspend 包装一个耗时操作，同时将耗时操作用 withContext()包装起来，并指定其要使用的线程</p>
</blockquote>
<p>suspend 关键字在 kotlin 中用于函数声明，这里需要做一个说明：</p>
<pre><code>一个suspend的函数并不代表其不会在主线程上执行
</code></pre><p>在 Dispatchers.MAIN 的上下文下，你的函数就是会在主线程上执行的</p>
<p>另外一条说明：</p>
<pre><code>suspend关键字并不是真正实现挂起
</code></pre><p>它只是一个提醒，提醒调用者我是一个耗时函数，我被我的创建者用挂起的方式放到后台执行，你需要用协程来调用我</p>
<p>例如:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> : String &#123;</span><br><span class="line">    viewModelScope.launch &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"test in IO thread: "</span> + Thread.currentThread())</span><br><span class="line">        delay(<span class="number">1_000</span>)</span><br><span class="line">        Log.d(TAG, <span class="string">"do we really sleep about 1000ms? "</span> + Thread.currentThread())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Test"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">onMainViewClicked</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    viewModelScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> rst = test()</span><br><span class="line">        _snackBar.postValue(rst)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们说，test()在 viewModelScope.launch 时启动了一个协程，这个线程 delay 了 1000ms 后返回 test，那么这段代码的表现就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-12-02 21:21:39.615 21445-21445/com.example.android.kotlincoroutines D/MainViewModel: test in IO thread: Thread[main,5,main]</span><br><span class="line">2019-12-02 21:21:40.620 21445-21445/com.example.android.kotlincoroutines D/MainViewModel: do we really sleep about 1000ms? Thread[main,5,main]</span><br></pre></td></tr></table></figure>
<p>在第一条日志出现时，_snackBar 就已经调用了 postValue 了，delay 函数并没有阻塞住我们的 viewModelScope</p>
<p>如果我们希望延时 1s 后 postValue 呢？下面这个写法 ok 吗？</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> : String &#123;</span><br><span class="line">    viewModelScope.async &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"test in IO thread: "</span> + Thread.currentThread())</span><br><span class="line">        delay(<span class="number">1_000</span>)</span><br><span class="line">        Log.d(TAG, <span class="string">"do we really sleep about 1000ms? "</span> + Thread.currentThread())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Test"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wait one second then display a snackbar.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">onMainViewClicked</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    viewModelScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> rst = test()</span><br><span class="line">        _snackBar.postValue(rst)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果和 launch 一致，原因也很简单，因为我们没有对 async 内的协程做任何操作，只是让它执行.</p>
<p>为了让它等待 1s，就有两种方式</p>
<ol>
<li>async#await()</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> : String &#123;</span><br><span class="line">    viewModelScope.async &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"test in IO thread: "</span> + Thread.currentThread())</span><br><span class="line">        delay(<span class="number">1_000</span>)</span><br><span class="line">        Log.d(TAG, <span class="string">"do we really sleep about 1000ms? "</span> + Thread.currentThread())</span><br><span class="line">    &#125;.await()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Test"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Wait one second then display a snackbar.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">onMainViewClicked</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    viewModelScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> rst = test()</span><br><span class="line">        _snackBar.postValue(rst)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们会发现一旦调用了 await()，编译器就会要求我们声明 test 为 suspend 函数，原因很简单。如上文所述，await()是被声明为 suspend，它被声明为耗时函数，那么你需要放在一个 suspend 函数去调用</p>
<p>结果:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2019-12-02 21:26:10.198 21809-21809/com.example.android.kotlincoroutines D/MainViewModel: test in IO thread: Thread[main,5,main]</span><br><span class="line">2019-12-02 21:26:11.202 21809-21809/com.example.android.kotlincoroutines D/MainViewModel: do we really sleep about 1000ms? Thread[main,5,main]</span><br></pre></td></tr></table></figure>
<p>postValue 将会在第二条日志打印时调用，满足延时效果</p>
<ol start="2">
<li>withContext()</li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">test</span><span class="params">()</span></span> : String &#123;</span><br><span class="line">    withContext(viewModelScope.coroutineContext) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">"test in IO thread: "</span> + Thread.currentThread())</span><br><span class="line">        delay(<span class="number">1_000</span>)</span><br><span class="line">        Log.d(TAG, <span class="string">"do we really sleep about 1000ms? "</span> + Thread.currentThread())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Test"</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wait one second then display a snackbar.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">onMainViewClicked</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    viewModelScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> rst = test()</span><br><span class="line">        _snackBar.postValue(rst)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果同 1，但这里可以额外说一下，withContext 允许带返回值，你可以理解就是 async#await()的整合版。</p>
<p>这里需要对 1 和 2 做一个总结，async 配合 await()和 withContext 到底干了什么？简单来说</p>
<pre><code>就是帮助你将线程切走，同时当传入的lambda有返回值时，帮你自动切回来
</code></pre><p>啥意思呢？比如你有下面一段代码:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUser</span><span class="params">()</span></span> : User&#123;</span><br><span class="line">    <span class="keyword">return</span> withContext(Dispatchers.IO) &#123;</span><br><span class="line">        <span class="keyword">return</span> network.fetchUser()   <span class="comment">// IO Thread</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">showUser</span><span class="params">()</span></span> &#123;</span><br><span class="line">    viewModelScope.launch &#123;</span><br><span class="line">        <span class="keyword">val</span> user = getUser()   <span class="comment">// Main Thread</span></span><br><span class="line">        _user.postValue(user)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们认为<code>network.fetchUser()</code>是一个耗时操作，那么我们用 withContext(Dispatchers.IO)包裹起来，丢给 IO 线程处理，当 network.fetchUser()返回时，withContext 自动将线程切回 MAIN 线程，回到 showUser()的 user 变量处，这里也是 MAIN 线程</p>
<h2 id="协程中的异常处理"><a href="#协程中的异常处理" class="headerlink" title="协程中的异常处理"></a>协程中的异常处理</h2><p>协程中的异常处理取决于你创建协程的方式</p>
<p>如果是 launch 创建的协程，异常会立即抛出，同时会导致其树状关系的所有 job 失败，因此你需要在协程内代码自行使用 try-catch</p>
<p>例如:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> job: Job = Job()</span><br><span class="line"><span class="keyword">val</span> scope = CoroutineScope(Dispatchers.Default + job)</span><br><span class="line"><span class="comment">// may throw Exception</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: Deferred&lt;String&gt; = scope.async &#123; ... &#125;   <span class="comment">// (1)</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loadData</span><span class="params">()</span></span> = scope.launch &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doWork().await()                               <span class="comment">// (2)</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候(2)中捕获的异常也会立即使其父 job 失败，一种解决方案就是用 SupervisorJob 来作为父 job</p>
<pre><code>A failure or cancellation of a child does not cause the supervisor job to fail and does not affect its other children.
</code></pre><p>这么做能捕获的前提是你的 async 也在 SupervisorJob 构造的 scope 中执行，不然也是会 crash 的, 例如:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> job = SupervisorJob()</span><br><span class="line"><span class="keyword">val</span> scope = CoroutineScope(Dispatchers.Default + job)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loadData</span><span class="params">()</span></span> = scope.launch &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        async &#123;                                         <span class="comment">// (1)</span></span><br><span class="line">            <span class="comment">// may throw Exception, still crash</span></span><br><span class="line">        &#125;.await()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另一种解决方案就是使用 coroutineScope 函数包裹你的 async 调用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> job = SupervisorJob()</span><br><span class="line"><span class="keyword">val</span> scope = CoroutineScope(Dispatchers.Default + job)</span><br><span class="line"></span><br><span class="line"><span class="comment">// may throw Exception</span></span><br><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">doWork</span><span class="params">()</span></span>: String = coroutineScope &#123;     <span class="comment">// (1)</span></span><br><span class="line">    async &#123; ... &#125;.await()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loadData</span><span class="params">()</span></span> = scope.launch &#123;                       <span class="comment">// (2)</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        doWork()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果是 async 创建的协程，异常会在你调用 await 的位置抛出，如果没有调用 await，不会有抛出异常的可能，因此你需要在 await 调用的位置使用 try-catch</p>
<p>如果是 withContext 创建的协程，同 launch 的处理</p>
<p>最后，你都可以创建一个 CoroutineExceptionHandler 对象传入到你的 scope 中来统一处理异常</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> coroutineExceptionHandler: CoroutineExceptionHandler =</span><br><span class="line">    CoroutineExceptionHandler &#123; _, throwable -&gt;</span><br><span class="line">      <span class="comment">//2</span></span><br><span class="line">      coroutineScope.launch(Dispatchers.Main) &#123;</span><br><span class="line">        <span class="comment">//3</span></span><br><span class="line">        errorMessage.visibility = View.VISIBLE</span><br><span class="line">        errorMessage.text = getString(R.string.error_message)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      GlobalScope.launch &#123; println(<span class="string">"Caught <span class="variable">$throwable</span>"</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> coroutineScope =</span><br><span class="line">    CoroutineScope(Dispatchers.Main + parentJob + coroutineExceptionHandler)</span><br></pre></td></tr></table></figure>
<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><ol>
<li>实现 suspend 函数时，保证其线程安全，<strong>可以在任何线程(Dispatcher)调用</strong></li>
</ol>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">login</span><span class="params">()</span></span> : Result &#123;</span><br><span class="line">    view.showLoading()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> result = withContext(Dispatchers.IO) &#123;</span><br><span class="line">        loginBlockingCall()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    view.hideLoading()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的 login 有潜在的 crash 风险，调用方极有可能将这个函数放在 non-Main dispatcher 中调用，为了避免这种类型的 crash，请将你的函数设计成线程安全的</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">login</span><span class="params">()</span></span> : Result = withContext(Dispachers.Main) &#123;</span><br><span class="line">        view.showLoading()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> result = withContext(Dispatchers.IO) &#123;</span><br><span class="line">            loginBlockingCall()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        view.hideLoading()</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Android 开发应避免 GlobalScope<br>因为 GlobalScope 是跟随 Application 的生命周期，使用 GlobalScope 下的协程会带来资源泄漏的风险</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/12/07/Kotlin%E5%8D%8F%E7%A8%8B%E5%AE%9E%E6%88%98/" data-id="ckgx4rr7h000ki8x7l915vzp1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Android自定义View中一些参数的含义" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/16/Android%E8%87%AA%E5%AE%9A%E4%B9%89View%E4%B8%AD%E4%B8%80%E4%BA%9B%E5%8F%82%E6%95%B0%E7%9A%84%E5%90%AB%E4%B9%89/" class="article-date">
  <time datetime="2019-11-16T12:31:21.000Z" itemprop="datePublished">2019-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/16/Android%E8%87%AA%E5%AE%9A%E4%B9%89View%E4%B8%AD%E4%B8%80%E4%BA%9B%E5%8F%82%E6%95%B0%E7%9A%84%E5%90%AB%E4%B9%89/">Android自定义View中一些参数的含义</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#android-%e8%87%aa%e5%ae%9a%e4%b9%89-view-%e4%b8%ad%e4%b8%80%e4%ba%9b%e5%8f%82%e6%95%b0%e7%9a%84%e5%90%ab%e4%b9%89">Android 自定义 View 中一些参数的含义</a><ul>
<li><a href="#tldr">TL;DR</a><ul>
<li><a href="#attributeset">AttributeSet</a></li>
<li><a href="#defstyleattr">defStyleAttr</a></li>
<li><a href="#defstyleres">defStyleRes</a></li>
</ul>
</li>
<li><a href="#%e5%b0%8f%e7%bb%93">小结</a></li>
<li><a href="#ps-%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e4%bd%bf%e7%94%a8%e9%9b%86%e8%81%94%e6%96%b9%e5%bc%8f%e5%ae%9e%e7%8e%b0%e8%87%aa%e5%ae%9a%e4%b9%89-view">P.S 为什么不使用集联方式实现自定义 View</a></li>
<li><a href="#references">References</a></li>
</ul>
</li>
</ul>
<h1 id="Android-自定义-View-中一些参数的含义"><a href="#Android-自定义-View-中一些参数的含义" class="headerlink" title="Android 自定义 View 中一些参数的含义"></a>Android 自定义 View 中一些参数的含义</h1><h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><p>不要理会<code>View(Context, AttributeSet, defStyleAttr)</code>和<code>View(Context, AttributeSet, defStyleAttr, defStyleRes)</code>, 关心<code>View(Context)</code>, <code>View(Context, AttributeSet)</code>, 范例代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyView</span> <span class="keyword">extends</span> <span class="title">SomeView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        init(context, <span class="keyword">null</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context,attrs);</span><br><span class="line">        init(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">        init(context, attrs, defStyle);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something cool</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AttributeSet"><a href="#AttributeSet" class="headerlink" title="AttributeSet"></a>AttributeSet</h3><p>这个参数代表了所有在 XML 中申明的属性, 例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;TextView</span><br><span class="line">    android:layout_width=<span class="string">"wrap_content"</span></span><br><span class="line">    android:layout_height=<span class="string">"wrap_content"</span></span><br><span class="line">    android:text=<span class="string">"@string/hello"</span></span><br><span class="line">    undeclaredAttr=<span class="string">"value for undeclared attr"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>所有 XML 中调用都会涉及 View 的两个参数的构造函数, 此时 AttributeSet 就会包含四个属性: <code>layout_width</code>, <code>layout_height</code>, <code>text</code>, <code>undeclaredAttr</code></p>
<p>可能有的人会好奇这些属性是从哪里来的，实际上在自定义 View 时，我们可以在 attrs 中声明<code>declare-styleable</code>来为我们的 View 增加属性, 例如:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"ImageView"</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- Sets a drawable as the content of this ImageView. --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"src"</span> <span class="attr">format</span>=<span class="string">"reference|color"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- ...snipped for brevity... --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面这个就是 ImageView 中 src 属性的由来, 有了这个定义, Android 的 ImageView 才能通过 xml 来设置 src 属性</p>
<p>通常在<code>View(Context context, AttributeSet attrs)</code>, 我们会使用<code>Theme.obtainStyledAttributes(android.util.AttributeSet, int[], int, int)</code>来获取 AttributeSet 中的属性, 主要原因是因为我们往往需要依赖一套机制来解决在 xml 配置时使用的各种关系</p>
<blockquote>
<p>For example, if you define style=@style/MyStyle in your XML, this method resolves MyStyle and adds its attributes to the mix. In the end, obtainStyledAttributes() returns a TypedArray which you can use to access the attributes.</p>
</blockquote>
<h3 id="defStyleAttr"><a href="#defStyleAttr" class="headerlink" title="defStyleAttr"></a>defStyleAttr</h3><p>View 的构造函数有一种方法签名: <code>View(Context context, AttributeSet attrs, int defStyleAttr)</code>, 其中的 defStyleAttr 是什么含义呢？</p>
<p>defStyleAttr 可以理解为是你的 View 的默认风格，例如，你希望你 app 中的所有 MaterialButton 最小高度都为 72dp，那么你可以在你 app 中的 style.xml 中声明:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Theme.Demo"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">    ...</span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"materialButtonStyle"</span>&gt;</span>@style/BigButton<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"BigButton"</span> <span class="attr">parent</span>=<span class="string">"Widget.MaterialComponents.Button"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:minHeight"</span>&gt;</span>72dp<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里 MaterialButton 构造时使用的 defStyleAttr 即<code>R.attr.materialButtonStyle</code>, 我们在<code>Theme.Demo</code>的 style 配置中定义了我们自己的<code>materialButtonStyle</code>, 因此 App 内所有用的 MaterialButton 最小高度就是 72dp 了</p>
<p>实际上在上一个 Part 中我们提到<code>Theme.obtainStyledAttributes(android.util.AttributeSet, int[], int, int)</code>时会发现其第三个参数名也是 defStyleAttr, 这里的<code>defStyleAttr</code>和我们在 View 的构造函数里面表达的是同一个意思. 这里举个例子方便大家理解, 以 Android 的 TextView 举例:</p>
<p>首先我们需要声明一下我们 TextView 支持的属性:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"Theme"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ...snip... --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Default TextView style. --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"textViewStyle"</span> <span class="attr">format</span>=<span class="string">"reference"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- ...etc... --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的 textViewStyle 被我们声明为 reference, 即 textViewStyle 可以被定义为某一种 style</p>
<p>接着我们声明一下我们的 style</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Theme"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- ...snip... --&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"textViewStyle"</span>&gt;</span>@style/Widget.TextView<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="comment">&lt;!-- ...etc... --&gt;</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 Manifest 中我们声明使用此 style</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:name</span>=<span class="string">".MyActivity"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:theme</span>=<span class="string">"@style/Theme"</span></span></span><br><span class="line"><span class="tag">  /&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着在 TextView 构造时我们调用:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypedArray ta = theme.obtainStyledAttributes(attrs, R.styleable.TextView, R.attr.textViewStyle, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>此时会产生如下的结果:</p>
<ol>
<li>任何在 xml 中显式定义的属性会优先返回</li>
<li>如果 xml 中没有定义的属性, 那么会从<code>R.styleable.TextView</code>指向的 style, 在这里即<code>@style/Widget.TextView</code>, 取出</li>
</ol>
<h3 id="defStyleRes"><a href="#defStyleRes" class="headerlink" title="defStyleRes"></a>defStyleRes</h3><p>View 的构造函数中还有最后一种: <code>View(Context context, AttributeSet attrs, int defStyleAttr, int defStyleRes)</code>, 其中的 defStyleRes 又是什么意思呢？</p>
<p>简单来说, 当 defStyleAttr 为 0 或者没有在当前主题中设置 defStyleAttr 时, 就会使用 defStyleRes 对应的 style 来构造这个 View</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>列举一下在不同位置设置的属性使用的优先级，简单来说优先级从高到低如下排列:</p>
<pre><code>1. Any value defined in the AttributeSet.
2. The style resource defined in the AttributeSet (i.e. style=@style/blah).
3. The default style attribute specified by defStyleAttr.
4. The default style resource specified by defStyleResource (if there was no defStyleAttr).
5. Values in the theme.
</code></pre><h2 id="P-S-为什么不使用集联方式实现自定义-View"><a href="#P-S-为什么不使用集联方式实现自定义-View" class="headerlink" title="P.S 为什么不使用集联方式实现自定义 View"></a>P.S 为什么不使用集联方式实现自定义 View</h2><p>这里有一点需要注意, 往往我们会采用如下方式实现自定义 View:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyView</span> <span class="keyword">extends</span> <span class="title">SomeView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context,attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</span><br><span class="line">        <span class="comment">// do something cool</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种写法被称为<code>telescopic constructor</code></p>
<p>但这样写有可能会丢掉继承自 SomeView 的默认风格配置, 因为很有可能 SomeView 就是用集联方式实现构造的, 例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SomeView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SomeView</span><span class="params">(Context context, @Nullable AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context, attrs, com.android.internal.R.attr.textViewStyle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SomeView</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(context, attrs, defStyleAttr, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你在<code>MyView(Context)</code>中没有调用<code>super(context)</code>, 那么你就会丢掉<code>com.android.internal.R.attr.textViewStyle</code>的所有默认属性值, 会给你造成一些麻烦, 因此建议参考<a href="#tldr">TL;DR</a>中的方式实现自定义 View 的构造</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://stackoverflow.com/a/34301725/4380801" target="_blank" rel="noopener">Stackoverflow</a><br><a href="https://blog.danlew.net/2016/07/19/a-deep-dive-into-android-view-constructors/" target="_blank" rel="noopener">A deep dive into Android View constructors</a><br><a href="https://ataulm.github.io/2019/10/28/resolving-view-attributes.html" target="_blank" rel="noopener">Resolving View Attributes on Android</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/11/16/Android%E8%87%AA%E5%AE%9A%E4%B9%89View%E4%B8%AD%E4%B8%80%E4%BA%9B%E5%8F%82%E6%95%B0%E7%9A%84%E5%90%AB%E4%B9%89/" data-id="ckgx4rr6w0004i8x7ihdskhsa" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/android/" rel="tag">android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-工程效率的一些思考" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/09/28/%E5%B7%A5%E7%A8%8B%E6%95%88%E7%8E%87%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" class="article-date">
  <time datetime="2019-09-28T02:00:25.000Z" itemprop="datePublished">2019-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/09/28/%E5%B7%A5%E7%A8%8B%E6%95%88%E7%8E%87%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/">工程效率的一些思考</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="有关工程效率的一些思考"><a href="#有关工程效率的一些思考" class="headerlink" title="有关工程效率的一些思考"></a>有关工程效率的一些思考</h1><p>最近工作中花了很多时间处理了团队的devops和版本控制协作的问题，有了一些不成熟的想法，正好也是来到公司刚好一年的时间，借这个机会沉淀一下。</p>
<h2 id="使用键盘，而非UI"><a href="#使用键盘，而非UI" class="headerlink" title="使用键盘，而非UI"></a>使用键盘，而非UI</h2><p>我自己使用过一年的Linux作为主力开发环境，同时也有3年左右的Linux服务器维护的经历。这些经历让我更加习惯Shell环境，因此我也有一个习惯，任何开发环境，我一定会使用Shell辅助我开发，同时使用IDE等工具时，总是习惯尽可能用其快捷键位进行操作。</p>
<p>很有意思的是，我在大学期间认识的一部分朋友，大都也有这样类似的习惯。然而现在我身边还是有不少人习惯于用UI的交互方式进行日常开发，而用UI的结果往往是花费了更多时间去处理交互问题，这些交互问题浪费的时间最后积少成多拖慢了整个开发效率。</p>
<h3 id="Shell和UI的本质"><a href="#Shell和UI的本质" class="headerlink" title="Shell和UI的本质"></a>Shell和UI的本质</h3><p>Shell的本质其实是一个REPL(Read-Evaluate-Print-Loop)，当我们使用Shell操作时，本身就是把自己的操作<strong>用文本线性地进行记录</strong></p>
<p>而我们绝大部分时候使用的UI交互工具，往往都是在Shell命令基础上做了层UI交互的封装。基于此我提出一个自己的论断，欢迎打脸:</p>
<blockquote>
<p>任何UI工具的功能必然是某一个或多个Shell命令对应功能的子集，并且这个Shell命令必然早于UI工具诞生</p>
</blockquote>
<p>我也问过他们为什么更加喜欢用UI(鼠标)来完成日常的开发任务，原因无外乎:</p>
<ol>
<li>UI更直观</li>
<li>UI更易懂，直接用UI比起用键盘更”快”</li>
</ol>
<p>但实际果真如此吗？</p>
<h3 id="UI交互真的直观吗"><a href="#UI交互真的直观吗" class="headerlink" title="UI交互真的直观吗"></a>UI交互真的直观吗</h3><p>我想到近日有很多时间，我都在帮助我的同事解决他们遇到的各种Git问题。但遇到的情况大都是:</p>
<blockquote>
<p>我用了UI上的XXX按钮，点了几个选择框后发现后续的功能没办法继续用了</p>
</blockquote>
<p>同时附上一些截图到我的企业IM，问我为什么。</p>
<p>说实话这样我也不知道为什么会出现这个问题。</p>
<p>那假如我们换种描述方式呢？</p>
<blockquote>
<p>我执行git merge –no-ff xxx &amp;&amp; git pull -r后，我的merge commit不见了，这是为什么呢？</p>
</blockquote>
<p>在我看来，下面这种描述是更容易理解和定位问题的，这也是我一直热衷于使用Shell操作的原因。</p>
<p>UI交互相比Shell虽然优化了展示信息的方式，但也增加了你理解和另一个人理解的难度，这有几个原因：</p>
<ol>
<li>UI封装后，部分描述会跟其对应Shell的描述不一致</li>
<li>UI封装后为了尽可能地展示信息，会将信息和选项罗列，换句话说，你需要同时理解这个UI上的所有信息</li>
</ol>
<p>UI本身不是文本，其表述方式往往是模糊不清的(如某个确定按钮, 某个选项卡等)，这样就只能用图片等方式辅助描述。因此，当你在UI上操作出现问题时，他需要首先理解这个UI所展示的上下文环境后，才能明白你要发生了什么。如果这个UI本身的描述和其对应的Shell不一致，那么你们就会面临一个黑盒，这个黑盒是需要额外的手段才能破解的(如此UI工具的帮助文档等)</p>
<p>所以，UI的直观，只是单纯的在画面上的直观，但是比起工程上要求的精准，UI是绝对不合格的。工程上要求的直观，应该是<strong>正确的</strong>直观。</p>
<h3 id="UI交互真的比键盘交互快吗"><a href="#UI交互真的比键盘交互快吗" class="headerlink" title="UI交互真的比键盘交互快吗"></a>UI交互真的比键盘交互快吗</h3><p>很多人觉得鼠标点击是很快的一件事情，但实际上也不是这样。在一个复杂的UI环境，找到一个功能往往需要非常深的操作路径才能找到。而鼠标本身是一个定位精确度差的硬件，远不如键盘这样按下哪个键就来哪个键精准，操作鼠标还需要更多时间去定位，因此操作上显然还是键盘来的更加精准和快捷。</p>
<h2 id="我们该如何培养使用键盘的意识"><a href="#我们该如何培养使用键盘的意识" class="headerlink" title="我们该如何培养使用键盘的意识"></a>我们该如何培养使用键盘的意识</h2><p>很多时候我们的困境是我们并不知道有更好的方式，所以只能保持现状。我在这里给一些如何培养自己多使用键盘提升开发效率的建议，总的来说就是一点:</p>
<blockquote>
<p>DRY(Don’t Repeat Yourself) &amp;&amp; Search</p>
</blockquote>
<p>当你发现有一个UI操作范式你在反复使用时，不妨试着把它转换为一个键盘操作或者Shell命令，然后去使用这个你转换的结果；如果你发现这个操作范式可以被优化，试着去Google一下，往往会有很多人会有类似的疑问，而他们也会给你一个高效的操作方式。大家都是很懒的，没人愿意反复一个枯燥的<strong>点点点操作</strong>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/09/28/%E5%B7%A5%E7%A8%8B%E6%95%88%E7%8E%87%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83/" data-id="ckgx4rr7x0018i8x7hlpk2mug" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CanvasKit简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/07/14/CanvasKit%E7%AE%80%E4%BB%8B/" class="article-date">
  <time datetime="2019-07-14T02:08:57.000Z" itemprop="datePublished">2019-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/07/14/CanvasKit%E7%AE%80%E4%BB%8B/">CanvasKit简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#CanvasKit%E7%AE%80%E4%BB%8B">CanvasKit简介</a><ul>
<li><a href="#%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86">编译原理</a><ul>
<li><a href="#%E7%BC%96%E8%AF%91">编译</a></li>
<li><a href="#%E7%BC%96%E8%AF%91%E4%BA%A7%E7%89%A9%E6%B5%85%E6%9E%90">编译产物浅析</a></li>
<li><a href="#%E7%BC%96%E8%AF%91%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90">编译脚本解析</a></li>
<li><a href="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
<li><a href="#%E5%8F%AF%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">可应用场景</a></li>
<li><a href="#%E5%B0%8F%E7%BB%93-1">小结</a></li>
</ul>
</li>
</ul>
<h1 id="CanvasKit简介"><a href="#CanvasKit简介" class="headerlink" title="CanvasKit简介"></a>CanvasKit简介</h1><p>CanvasKit是以WASM为编译目标的Web平台图形绘制接口，其目标是将Skia的图形API导出到Web平台。<br>从代码提交记录来看，CanvasKit作为了一个Module放置在整个代码仓库中，最早的一次提交记录在2018年9月左右，是一个比较新的codebase</p>
<p>本文简单介绍一下Skia是如何编译为Web平台的，其性能以及未来的可应用场景</p>
<h2 id="编译原理"><a href="#编译原理" class="headerlink" title="编译原理"></a>编译原理</h2><p>整个canvaskit模块的代码量非常少:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.gitignore</span><br><span class="line">CHANGELOG.md</span><br><span class="line">Makefile</span><br><span class="line">WasmAliases.h</span><br><span class="line">canvaskit/  发布代码，canvaskit介绍文档</span><br><span class="line">canvaskit_bindings.cpp</span><br><span class="line">compile.sh  编译脚本</span><br><span class="line">cpu.js</span><br><span class="line">debug.js</span><br><span class="line">externs.js</span><br><span class="line">fonts/  字体资源文件</span><br><span class="line">gpu.js</span><br><span class="line">helper.js</span><br><span class="line">htmlcanvas/</span><br><span class="line">interface.js</span><br><span class="line">karma.bench.conf.js</span><br><span class="line">karma.conf.js</span><br><span class="line">package.json</span><br><span class="line">particles_bindings.cpp</span><br><span class="line">perf/ 性能数据</span><br><span class="line">postamble.js</span><br><span class="line">preamble.js</span><br><span class="line">ready.js</span><br><span class="line">release.js</span><br><span class="line">serve.py</span><br><span class="line">skottie.js</span><br><span class="line">skottie_bindings.cpp</span><br><span class="line">tests/    测试代码</span><br></pre></td></tr></table></figure></p>
<p>整个模块我们可以看到其实没有修改包括任何skia的代码文件，只是在编译时指明了skia的源码依赖，同时写了一些胶水代码，从这里可以看出skia迁移至WASM并没有付出很多额外的改造工作。</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>设置好WASM工具链EmscriptenSDK的环境变量后运行compile.sh就会在<code>out</code>文件夹中得到<code>canvaskit.js</code>和<code>canvaskit.wasm</code>这两个编译产物，这里为了分析选择编译一个debug版本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./compile.sh debug</span><br></pre></td></tr></table></figure>
<p>debug版本会得到一个未混淆的canvaskit.js，方便我们分析其实现</p>
<h3 id="编译产物浅析"><a href="#编译产物浅析" class="headerlink" title="编译产物浅析"></a>编译产物浅析</h3><p>为了快速了解整个模块的情况，直接观察canvaskit.js和canvaskit.wasm文件，先来看下canvaskit.js<br>js代码量比较大，这里摘取一段最能展示其运行原理的代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeWebGLContext</span>(<span class="params">canvas, attrs</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// These defaults come from the emscripten _emscripten_webgl_create_context</span></span><br><span class="line">    <span class="keyword">var</span> contextAttributes = &#123;</span><br><span class="line">    alpha: <span class="keyword">get</span>(attrs, 'alpha', 1),</span><br><span class="line">    depth: <span class="keyword">get</span>(attrs, 'depth', 1),</span><br><span class="line">    stencil: <span class="keyword">get</span>(attrs, 'stencil', 0),</span><br><span class="line">    antialias: <span class="keyword">get</span>(attrs, 'antialias', 1),</span><br><span class="line">    premultipliedAlpha: <span class="keyword">get</span>(attrs, 'premultipliedAlpha', 1),</span><br><span class="line">    preserveDrawingBuffer: <span class="keyword">get</span>(attrs, 'preserveDrawingBuffer', 0),</span><br><span class="line">    preferLowPowerToHighPerformance: <span class="keyword">get</span>(attrs, 'preferLowPowerToHighPerformance', 0),</span><br><span class="line">    failIfMajorPerformanceCaveat: <span class="keyword">get</span>(attrs, 'failIfMajorPerformanceCaveat', 0),</span><br><span class="line">    majorVersion: <span class="keyword">get</span>(attrs, 'majorVersion', 1),</span><br><span class="line">    minorVersion: <span class="keyword">get</span>(attrs, 'minorVersion', 0),</span><br><span class="line">    enableExtensionsByDefault: <span class="keyword">get</span>(attrs, 'enableExtensionsByDefault', 1),</span><br><span class="line">    explicitSwapControl: <span class="keyword">get</span>(attrs, 'explicitSwapControl', 0),</span><br><span class="line">    renderViaOffscreenBackBuffer: <span class="keyword">get</span>(attrs, 'renderViaOffscreenBackBuffer', 0),</span><br><span class="line">    &#125;;</span><br><span class="line">    if (!canvas) &#123;</span><br><span class="line">    SkDebug(<span class="string">'null canvas passed into makeWebGLContext'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// This check is from the emscripten version</span></span><br><span class="line">    <span class="keyword">if</span> (contextAttributes[<span class="string">'explicitSwapControl'</span>]) &#123;</span><br><span class="line">    SkDebug(<span class="string">'explicitSwapControl is not supported'</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// GL is an enscripten provided helper</span></span><br><span class="line"><span class="comment">// See https://github.com/emscripten-core/emscripten/blob/incoming/src/library_webgl.js</span></span><br><span class="line"><span class="keyword">return</span> GL.createContext(canvas, contextAttributes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CanvasKit.GetWebGLContext = <span class="function"><span class="keyword">function</span>(<span class="params">canvas, attrs</span>) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> makeWebGLContext(canvas, attrs);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> GL= &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    init:<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        GL.miniTempBuffer = <span class="keyword">new</span> <span class="built_in">Float32Array</span>(GL.MINI_TEMP_BUFFER_SIZE);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; GL.MINI_TEMP_BUFFER_SIZE; i++) &#123;</span><br><span class="line">          GL.miniTempBufferViews[i] = GL.miniTempBuffer.subarray(<span class="number">0</span>, i+<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//...</span></span><br><span class="line">      createContext:<span class="function"><span class="keyword">function</span> (<span class="params">canvas, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ctx = (canvas.getContext(<span class="string">"webgl"</span>, webGLContextAttributes)</span><br><span class="line">            || canvas.getContext(<span class="string">"experimental-webgl"</span>, webGLContextAttributes));</span><br><span class="line">        <span class="keyword">return</span> ctx &amp;&amp; GL.registerContext(ctx, webGLContextAttributes);</span><br><span class="line">      &#125;,<span class="attr">registerContext</span>:<span class="function"><span class="keyword">function</span> (<span class="params">ctx, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> handle = _malloc(<span class="number">8</span>); <span class="comment">// Make space on the heap to store GL context attributes that need to be accessible as shared between threads.</span></span><br><span class="line">        assert(handle, <span class="string">'malloc() failed in GL.registerContext!'</span>);</span><br><span class="line">        <span class="keyword">var</span> context = &#123;</span><br><span class="line">          handle: handle,</span><br><span class="line">          attributes: webGLContextAttributes,</span><br><span class="line">          version: webGLContextAttributes.majorVersion,</span><br><span class="line">          GLctx: ctx</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// Store the created context object so that we can access the context given a canvas without having to pass the parameters again.</span></span><br><span class="line">        <span class="keyword">if</span> (ctx.canvas) ctx.canvas.GLctxObject = context;</span><br><span class="line">        GL.contexts[handle] = context;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> webGLContextAttributes.enableExtensionsByDefault === <span class="string">'undefined'</span> || webGLContextAttributes.enableExtensionsByDefault) &#123;</span><br><span class="line">          GL.initExtensions(context);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handle;</span><br><span class="line">      &#125;,<span class="attr">makeContextCurrent</span>:<span class="function"><span class="keyword">function</span> (<span class="params">contextHandle</span>) </span>&#123;</span><br><span class="line">        GL.currentContext = GL.contexts[contextHandle]; <span class="comment">// Active Emscripten GL layer context object.</span></span><br><span class="line">        Module.ctx = GLctx = GL.currentContext &amp;&amp; GL.currentContext.GLctx; <span class="comment">// Active WebGL context object.</span></span><br><span class="line">        <span class="keyword">return</span> !(contextHandle &amp;&amp; !GLctx);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>代码中出现了大量的WebGL指令和2d的绘制js代码，其实这一块就是EmscriptenSDK对OpenGL的胶水代码(<a href="https://emscripten.org/docs/porting/multimedia_and_graphics/OpenGL-support.html)" target="_blank" rel="noopener">https://emscripten.org/docs/porting/multimedia_and_graphics/OpenGL-support.html)</a>, 换言之，canvaskit的绘制代码没有脱离浏览器提供的webgl和context2d的相关接口，毕竟这也是目前在浏览器进行绘制操作的唯一途径</p>
<p>那编译的wasm文件做了啥呢？简单看一下对应wasm的一部分代码, 这也是一个比较庞大的文件，我们只关注一下wasm和js连接的桥梁代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(import &quot;env&quot; &quot;_eglGetCurrentDisplay&quot; (func $_eglGetCurrentDisplay (result i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_eglGetProcAddress&quot; (func $_eglGetProcAddress (param i32) (result i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_eglQueryString&quot; (func $_eglQueryString (param i32 i32) (result i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glActiveTexture&quot; (func $_emscripten_glActiveTexture (param i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glAttachShader&quot; (func $_emscripten_glAttachShader (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBeginQueryEXT&quot; (func $_emscripten_glBeginQueryEXT (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindAttribLocation&quot; (func $_emscripten_glBindAttribLocation (param i32 i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindBuffer&quot; (func $_emscripten_glBindBuffer (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindFramebuffer&quot; (func $_emscripten_glBindFramebuffer (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindRenderbuffer&quot; (func $_emscripten_glBindRenderbuffer (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glBindTexture&quot; (func $_emscripten_glBindTexture (param i32 i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glClear&quot; (func $_emscripten_glClear (param i32)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glClearColor&quot; (func $_emscripten_glClearColor (param f64 f64 f64 f64)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glClearDepthf&quot; (func $_emscripten_glClearDepthf (param f64)))</span><br><span class="line">(import &quot;env&quot; &quot;_emscripten_glCompileShader&quot; (func $_emscripten_glCompileShader (param i32)))</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里省略了一部分，但是仍然可以看出，wasm对绘制的支持全部依赖其运行环境中js注入的函数实现</p>
<p>以这里的<code>_emscripten_glBindTexture</code>函数为例，对应到js为:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> asmGlobalArg = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> asmLibraryArg = &#123;</span><br><span class="line">    <span class="string">"_emscripten_glBindTexture"</span>: _emscripten_glBindTexture <span class="comment">// .... 上文wasm中的函数注册，这里略去，只保留_emscripten_glBindTexture</span></span><br><span class="line">&#125;</span><br><span class="line">Module[<span class="string">'asm'</span>] = <span class="function"><span class="keyword">function</span>(<span class="params">global, env, providedBuffer</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// memory was already allocated (so js could use the buffer)</span></span><br><span class="line">    env[<span class="string">'memory'</span>] = wasmMemory</span><br><span class="line">    ;</span><br><span class="line">    <span class="comment">// import table</span></span><br><span class="line">    env[<span class="string">'table'</span>] = wasmTable = <span class="keyword">new</span> WebAssembly.Table(&#123;</span><br><span class="line">    <span class="string">'initial'</span>: <span class="number">1155075</span>,</span><br><span class="line">    <span class="string">'maximum'</span>: <span class="number">1155075</span>,</span><br><span class="line">    <span class="string">'element'</span>: <span class="string">'anyfunc'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    env[<span class="string">'__memory_base'</span>] = <span class="number">1024</span>; <span class="comment">// tell the memory segments where to place themselves</span></span><br><span class="line">    env[<span class="string">'__table_base'</span>] = <span class="number">0</span>; <span class="comment">// table starts at 0 by default (even in dynamic linking, for the main module)</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> exports = createWasm(env);   <span class="comment">// 加载WASM对象, env即WASM对象加载时所需要的上下文，包括内存大小，函数表，和堆栈起始地址</span></span><br><span class="line">    assert(exports, <span class="string">'binaryen setup failed (no wasm support?)'</span>);</span><br><span class="line">    <span class="keyword">return</span> exports;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// EMSCRIPTEN_START_ASM</span></span><br><span class="line"><span class="keyword">var</span> asm =Module[<span class="string">"asm"</span>]<span class="comment">// EMSCRIPTEN_END_ASM</span></span><br><span class="line">(asmGlobalArg, asmLibraryArg, buffer);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_emscripten_glBindTexture</span>(<span class="params">target, texture</span>) </span>&#123;</span><br><span class="line">    GL.validateGLObjectID(GL.textures, texture, <span class="string">'glBindTexture'</span>, <span class="string">'texture'</span>);</span><br><span class="line">    GLctx.bindTexture(target, GL.textures[texture]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GLctx通过代码我们也能找到对应:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">createContext:<span class="function"><span class="keyword">function</span> (<span class="params">canvas, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ctx = (canvas.getContext(<span class="string">"webgl"</span>, webGLContextAttributes)</span><br><span class="line">        || canvas.getContext(<span class="string">"experimental-webgl"</span>, webGLContextAttributes));</span><br><span class="line">    <span class="keyword">return</span> ctx &amp;&amp; GL.registerContext(ctx, webGLContextAttributes);</span><br><span class="line">&#125;,<span class="attr">registerContext</span>:<span class="function"><span class="keyword">function</span> (<span class="params">ctx, webGLContextAttributes</span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> handle = _malloc(<span class="number">8</span>); <span class="comment">// Make space on the heap to store GL context attributes that need to be accessible as shared between threads.</span></span><br><span class="line">assert(handle, <span class="string">'malloc() failed in GL.registerContext!'</span>);</span><br><span class="line"><span class="keyword">var</span> context = &#123;</span><br><span class="line">    handle: handle,</span><br><span class="line">    attributes: webGLContextAttributes,</span><br><span class="line">    version: webGLContextAttributes.majorVersion,</span><br><span class="line">    GLctx: ctx </span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Store the created context object so that we can access the context given a canvas without having to pass the parameters again.</span></span><br><span class="line"><span class="keyword">if</span> (ctx.canvas) ctx.canvas.GLctxObject = context;</span><br><span class="line">GL.contexts[handle] = context;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> webGLContextAttributes.enableExtensionsByDefault === <span class="string">'undefined'</span> || webGLContextAttributes.enableExtensionsByDefault) &#123;</span><br><span class="line">    GL.initExtensions(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> handle;</span><br><span class="line">&#125;,<span class="attr">makeContextCurrent</span>:<span class="function"><span class="keyword">function</span> (<span class="params">contextHandle</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">    GL.currentContext = GL.contexts[contextHandle]; <span class="comment">// Active Emscripten GL layer context object.</span></span><br><span class="line">    Module.ctx = GLctx = GL.currentContext &amp;&amp; GL.currentContext.GLctx; <span class="comment">// Active WebGL context object.  // GLCtx变量</span></span><br><span class="line">    <span class="keyword">return</span> !(contextHandle &amp;&amp; !GLctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这里的bindTexture实际上就是WebGL的bindTexture指令(<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/bindTexture#Syntax" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/bindTexture#Syntax</a>)</p>
<p>分析到这里，我们可以得到一个基本结论: <strong>canvaskit中绘制的实现全部在canvaskit.js中调用浏览器绘制API来实现，而计算相关的内容全部放在了wasm中实现</strong></p>
<h3 id="编译脚本解析"><a href="#编译脚本解析" class="headerlink" title="编译脚本解析"></a>编译脚本解析</h3><p>通过对编译产物的分析，我们可以发现canvaskit绝大部分的绘制都是借助了Web API中的2d或webgl绘制API来完成的。这里需要分析的是canvaskit如何搭建了skia原生绘制代码和浏览器绘制API的桥梁。</p>
<p>看到compile.sh发现最后一句话涉及到很多canvaskit目录下的文件，因此直接结合编译日志的相关内容分析。</p>
<p>其他的日志都是常规的skia编译命令，只不过执行程序换成了em++而已，em++就是EmscriptenSDK中的编译器命令，可以类比为g++，这些命令会把skia编译为几个静态库</p>
<p>我们略过之前的skia编译命令来到最后一段，这是真正生成WASM产物的地方，其中有大量的逻辑是涉及到canvaskit中的胶水代码的。略去链接, 编译器优化设置, Skia静态库路径的指定, Skia宏定义和头文件路径指定，我们将会得到:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">/Users/JianGuo/VSCodeProject/emsdk/emscripten/1.38.28/em++  \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/debug.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/cpu.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/gpu.js \</span><br><span class="line">--bind \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/preamble.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/helper.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/interface.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/skottie.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/preamble.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/util.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/color.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/font.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/canvas2dcontext.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/htmlcanvas.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/imagedata.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/lineargradient.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/path2d.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/pattern.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/radialgradient.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/htmlcanvas/postamble.js \</span><br><span class="line">--pre-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/postamble.js \</span><br><span class="line">--post-js /Users/JianGuo/Desktop/skia/skia/modules/canvaskit/ready.js \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/fonts/NotoMono-Regular.ttf.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/canvaskit_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/particles_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/skottie_bindings.cpp \</span><br><span class="line">modules/skottie/utils/SkottieUtils.cpp \</span><br><span class="line">-s ALLOW_MEMORY_GROWTH=1 \ # 允许申请比TOTAL_MEMORY更大的内存</span><br><span class="line">-s EXPORT_NAME=CanvasKitInit \ # js中Module的名字</span><br><span class="line">-s FORCE_FILESYSTEM=0 \ # 开启文件系统支持，用于js中对native的文件系统进行模拟</span><br><span class="line">-s MODULARIZE=1 \ #启用Module的方式生成js，开启后编译的js产物将拥有一个Module作用域，而非全局作用域</span><br><span class="line">-s NO_EXIT_RUNTIME=1 \ # 禁止使用exit函数</span><br><span class="line">-s STRICT=1 \ # 确保编译器不使用弃用语法</span><br><span class="line">-s TOTAL_MEMORY=128MB \ # WASM分配的总内存，如果比此内存更大的场景就需要扩展堆大小</span><br><span class="line">-s USE_FREETYPE=1 \ # 使用emscripten-ports导出的freetype库</span><br><span class="line">-s USE_LIBPNG=1 \ # 使用emscripten-ports导出的libpng库</span><br><span class="line">-s WARN_UNALIGNED=1 \ # 编译时警告未对齐(align)</span><br><span class="line">-s USE_WEBGL2=0 \ # 不使用WebGL2</span><br><span class="line">-s WASM=1 \ # 编译为WASM</span><br><span class="line">-o out/canvaskit_wasm_debug/canvaskit.js # 指定编译路径</span><br></pre></td></tr></table></figure>
<p>其中，<code>pre-js &lt;file&gt;</code>表示将指定文件的内容插入到生成的js文件前, <code>post-js</code>表示将指定文件的内容插入到生成的js文件后，我们以<code>skia/modules/canvaskit/htmlcanvas/htmlcanvas.js</code>为例，看看这些插入的文件都干了啥:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">CanvasKit.MakeCanvas = <span class="function"><span class="keyword">function</span>(<span class="params">width, height</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> surf = CanvasKit.MakeSurface(width, height);</span><br><span class="line">  <span class="keyword">if</span> (surf) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HTMLCanvas(surf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HTMLCanvas</span>(<span class="params">skSurface</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._surface = skSurface;</span><br><span class="line">  <span class="keyword">this</span>._context = <span class="keyword">new</span> CanvasRenderingContext2D(skSurface.getCanvas());</span><br><span class="line">  <span class="keyword">this</span>._toCleanup = [];</span><br><span class="line">  <span class="keyword">this</span>._fontmgr = CanvasKit.SkFontMgr.RefDefault();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Data is either an ArrayBuffer, a TypedArray, or a Node Buffer</span></span><br><span class="line">  <span class="keyword">this</span>.decodeImage = <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.loadFont = <span class="function"><span class="keyword">function</span>(<span class="params">buffer, descriptors</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.makePath2D = <span class="function"><span class="keyword">function</span>(<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A normal &lt;canvas&gt; requires that clients call getContext</span></span><br><span class="line">  <span class="keyword">this</span>.getContext = <span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.toDataURL = <span class="function"><span class="keyword">function</span>(<span class="params">codec, quality</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.dispose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实就是对齐了一下浏览器实现，同时对齐了一下Skia内部的接口而已。<br>最后我们还剩下一段没有分析:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/Users/JianGuo/VSCodeProject/emsdk/emscripten/1.38.28/em++  \</span><br><span class="line">...</span><br><span class="line">--bind \</span><br><span class="line">...</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/fonts/NotoMono-Regular.ttf.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/canvaskit_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/particles_bindings.cpp \</span><br><span class="line">/Users/JianGuo/Desktop/skia/skia/modules/canvaskit/skottie_bindings.cpp \</span><br><span class="line">modules/skottie/utils/SkottieUtils.cpp \</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>根据文档，这段命令要求em++以Embind(<a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/embind.html#embind)连接C++代码和JS代码" target="_blank" rel="noopener">https://emscripten.org/docs/porting/connecting_cpp_and_javascript/embind.html#embind)连接C++代码和JS代码</a>, embind简单来说就是emscriptenSDK提供的将C/C++代码暴露给JavaScript的便捷能力。这里不做重点介绍，我们直接看canvaskit用到的一个代码:</p>
<p><code>particles_bindings.cpp</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;emscripten.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;emscripten/bind.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> emscripten;</span><br><span class="line"></span><br><span class="line">EMSCRIPTEN_BINDINGS(Particles) &#123;</span><br><span class="line">    class_&lt;SkParticleEffect&gt;(<span class="string">"SkParticleEffect"</span>)</span><br><span class="line">        .smart_ptr&lt;sk_sp&lt;SkParticleEffect&gt;&gt;(<span class="string">"sk_sp&lt;SkParticleEffect&gt;"</span>)</span><br><span class="line">        .function(<span class="string">"draw"</span>, &amp;SkParticleEffect::draw, allow_raw_pointers())</span><br><span class="line">        .function(<span class="string">"start"</span>, select_overload&lt;<span class="keyword">void</span> (<span class="keyword">double</span>, <span class="keyword">bool</span>)&gt;(&amp;SkParticleEffect::start))</span><br><span class="line">        .function(<span class="string">"update"</span>, select_overload&lt;<span class="keyword">void</span> (<span class="keyword">double</span>)&gt;(&amp;SkParticleEffect::update));</span><br><span class="line"></span><br><span class="line">    function(<span class="string">"MakeParticles"</span>, optional_override([](<span class="built_in">std</span>::<span class="built_in">string</span> json)-&gt;sk_sp&lt;SkParticleEffect&gt; &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">bool</span> didInit = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!didInit) &#123;</span><br><span class="line">            REGISTER_REFLECTED(SkReflected);</span><br><span class="line">            SkParticleAffector::RegisterAffectorTypes();</span><br><span class="line">            SkParticleDrawable::RegisterDrawableTypes();</span><br><span class="line">            didInit = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        SkRandom r;</span><br><span class="line">        sk_sp&lt;SkParticleEffectParams&gt; params(<span class="keyword">new</span> SkParticleEffectParams());</span><br><span class="line">        skjson::DOM dom(json.c_str(), json.length());</span><br><span class="line">        SkFromJsonVisitor fromJson(dom.root());</span><br><span class="line">        params-&gt;visitFields(&amp;fromJson);</span><br><span class="line">        <span class="keyword">return</span> sk_sp&lt;SkParticleEffect&gt;(<span class="keyword">new</span> SkParticleEffect(<span class="built_in">std</span>::move(params), r));</span><br><span class="line">    &#125;));</span><br><span class="line">    constant(<span class="string">"particles"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码经过em++编译后会直接将其功能内嵌进wasm文件中。至此，整个编译流程就分析完了</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>这里用一张图来总结一下整个canvaskit的编译流程, 图中省去了编译器优化和js优化的流程:</p>
<p><img src="https://www.plantuml.com/plantuml/svg/xLJ1JeGm4BtlLpIST5SWgsSyUDU3nhCffK2nj4qxrRZ6VxU50ako6zYJ5pcGlk6zcVODKuKrC61I8DhkTkXxWznpjRr6SNoF8ivoyou164tm3UgGgS9IUINXr4oVQgoe3h36kipjuH0W8tRaCPpWg2laYsHPzh1thp4GnN7EH85QMLYNFYLOV62dWhIK0apw944-IY7ZPrfPZdK2K2P4gP3WZ7PSlNa24vLPren7l40J_5fK15vgWN6JllJerGElcDjpw-tf8WD2tgUnQFA9JJjAFETkC7GIzCugJUF6dDXt3ItlKRfD6XEIdQKhQG2tEQThk9gkfHOqjzKA7b5s1QjQnQefzx_jCf49eBh4PCr1Xh5fJ3HrRl_VY3zjnD4DusqxBN0U5Lzp-ZHeH-7Pc3diBitDpoy0"></p>
<h2 id="可应用场景"><a href="#可应用场景" class="headerlink" title="可应用场景"></a>可应用场景</h2><p>根据官方文档(<a href="https://skia.org/user/modules/canvaskit)" target="_blank" rel="noopener">https://skia.org/user/modules/canvaskit)</a>, canvaskit基于skia的API设计向web平台提供了更加方便的图形接口，可以说起到了类似GLWrapper的作用。</p>
<p>得益于Skia本身的其他扩展功能，canvaskit相比于浏览器原生绘制能力，支持了许多更加上层的业务级别功能，例如skia的动画模块skottie(<a href="https://skia.org/user/modules/skottie" target="_blank" rel="noopener">https://skia.org/user/modules/skottie</a>)</p>
<p>Skia中的skottie本身就支持Lottie动画解析和播放，由于Skia良好的跨平台能力，Android和iOS平台现在均可以使用Skia框架来播放Lottie动画，canvaskit则运用WebAssembly的技术来将跨平台的范围扩展到web上，使得web平台可以通过canvaskit的skottie相关接口直接播放lottie动画</p>
<p>对于Web应用而言，canvaskit提供了开发者更加友好的图形接口，并提供了常见的图形概念（例如Bitmap，Path等），减少了上层应用开发者对于绘制接口的理解负担，开发者只需要理解Skia的图形概念即可开发图形界面，有了skia他们也不需要理解复杂的webgl指令。</p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>得益于WASM的理念和EmscriptenSDK的能力，越来越多的native库可以直接导出web上供开发者使用。CanvasKit可以说是C++ Library向Web平台迁移的又一最佳实践。EmscriptenSDK已经做到将Skia这种规模的C++项目以WASM的方式迁移至Web平台，并保证其代码功能的一致性。整个迁移的过程的代价也就是编译工具链的替换和一部分胶水代码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/07/14/CanvasKit%E7%AE%80%E4%BB%8B/" data-id="ckgx4rr6y0005i8x71uin6k2m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebAssembly/" rel="tag">WebAssembly</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-APT插件实战" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/29/APT%E6%8F%92%E4%BB%B6%E5%AE%9E%E6%88%98/" class="article-date">
  <time datetime="2019-06-29T12:34:53.000Z" itemprop="datePublished">2019-06-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/29/APT%E6%8F%92%E4%BB%B6%E5%AE%9E%E6%88%98/">APT插件实战</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#Annotation-Processor">Annotation Processor</a><ul>
<li><a href="#%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86">注解处理器的运行原理</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">实现一个简单的注解处理器</a><ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%AD%A5%E9%AA%A4">基本步骤</a><ul>
<li><a href="#%E8%A7%A3%E5%86%B3%E4%BE%9D%E8%B5%96">解决依赖</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%B3%A8%E8%A7%A3">创建注解</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">创建注解处理器</a><ul>
<li><a href="#init">init()</a></li>
<li><a href="#Element">Element</a></li>
<li><a href="#Messager">Messager</a></li>
<li><a href="#process">process()</a></li>
<li><a href="#getSupportedAnnotationTypes">getSupportedAnnotationTypes()</a></li>
<li><a href="#getSupportedSourceVersion">getSupportedSourceVersion()</a></li>
</ul>
</li>
<li><a href="#%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0">注解处理器方法实现</a></li>
<li><a href="#%E5%90%91javac%E5%A3%B0%E6%98%8E%E8%BF%99%E4%B8%AA%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8">向javac声明这个注解处理器</a></li>
</ul>
</li>
<li><a href="#%E7%BC%96%E8%AF%91%E4%BD%93%E9%AA%8C%E6%88%90%E6%9E%9C">编译，体验成果</a></li>
</ul>
</li>
<li><a href="#%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8%E4%B8%8D%E8%83%BD%E5%81%9A%08%E4%B8%8D%E5%BB%BA%E8%AE%AE%E7%9A%84%E4%BA%8B%E6%83%85">注解处理器不能做(不建议)的事情</a></li>
<li><a href="#%E6%B3%A8%E8%A7%A3%E5%A4%84%E7%90%86%E5%99%A8%E7%9A%84%E7%89%B9%E6%80%A7">注解处理器的特性</a></li>
</ul>
</li>
</ul>
<h1 id="Annotation-Processor"><a href="#Annotation-Processor" class="headerlink" title="Annotation Processor"></a>Annotation Processor</h1><p>大量框架(例如Room, Dagger2, DataBinding, Butterknife)都利用Java1.6引入的annotation processor(后文统称注解处理器)来实现自己的框架功能。</p>
<p>这篇文章简单介绍注解处理器</p>
<h2 id="注解处理器的运行原理"><a href="#注解处理器的运行原理" class="headerlink" title="注解处理器的运行原理"></a>注解处理器的运行原理</h2><p>整个代码生成的过程发生在编译期，javac会获知所有的注解处理器，同时在编译时处理所有的注解。<br>由于整个过程在编译期完成，你可以认为注解处理器是编译器的一部分，因此最后的编译产物是不会包含编译处理器的内容的。</p>
<h2 id="实现一个简单的注解处理器"><a href="#实现一个简单的注解处理器" class="headerlink" title="实现一个简单的注解处理器"></a>实现一个简单的注解处理器</h2><h3 id="基本步骤"><a href="#基本步骤" class="headerlink" title="基本步骤"></a>基本步骤</h3><ol>
<li>创建一个注解module(Java Library)，这个module只包含注解(Annotation)</li>
<li>创建一个处理器module(Java Library)，这个module包含相关注解的处理逻辑</li>
</ol>
<h4 id="解决依赖"><a href="#解决依赖" class="headerlink" title="解决依赖"></a>解决依赖</h4><p>注解相关的module不需要任何依赖。<br>处理器module需要依赖我们自定义的注解和一些工具库。上文中提到过，这个module将会在编译器完成自己的任务，因此依赖此module的app不会打包这个module的内容。所以不用担心这个module的包体积问题</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">implementation fileTree(<span class="string">dir:</span> <span class="string">'libs'</span>, <span class="string">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line">implementation <span class="string">'com.google.guava:guava:21.0'</span></span><br><span class="line">implementation <span class="string">'com.squareup:javapoet:1.8.0'</span></span><br><span class="line">implementation project(<span class="string">':annotation'</span>)</span><br></pre></td></tr></table></figure>
<p>之后给我们的app添加上注解处理器的编译依赖，这里使用另外一个依赖关键字<code>annotationProcessor</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation project(<span class="string">':annotation'</span>)</span><br><span class="line">annotationProcessor project(<span class="string">':processor'</span>)</span><br></pre></td></tr></table></figure>
<p><code>annotationProcessor</code>表示我们只需要编译期有这个依赖，不需要打包进apk</p>
<h4 id="创建注解"><a href="#创建注解" class="headerlink" title="创建注解"></a>创建注解</h4><p>这里复习一下Java中注解的相关概念</p>
<p><code>@Target</code>:指明你的注解作用的对象，可以有许多类型<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ElementType &#123;</span><br><span class="line">    TYPE, <span class="comment">//If you want to annotate class, interface, enum..</span></span><br><span class="line">    FIELD, <span class="comment">//If you want to annotate field (includes enum constants)</span></span><br><span class="line">    METHOD, <span class="comment">//If you want to annotate method</span></span><br><span class="line">    PARAMETER, <span class="comment">//If you want to annotate parameter</span></span><br><span class="line">    CONSTRUCTOR, <span class="comment">//If you want to annotate constructor</span></span><br><span class="line">    LOCAL_VARIABLE, <span class="comment">//..</span></span><br><span class="line">    ANNOTATION_TYPE, <span class="comment">//..</span></span><br><span class="line">    PACKAGE, <span class="comment">//..</span></span><br><span class="line">    TYPE_PARAMETER, <span class="comment">//..(java 8)</span></span><br><span class="line">    TYPE_USE; <span class="comment">//..(java 8)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ElementType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>@Retention</code>:指明注解如何存储，有三种存储方式</p>
<ol>
<li>SOURCE—用于编译期，不会保存</li>
<li>CLASS—保存到最后的class文件，运行期不会保留</li>
<li>RUNTIME—保存到class文件，同时运行期也会保留(用于反射)</li>
</ol>
<p>我们这个场景只需要编译期注解:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> NewIntent &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建注解处理器"><a href="#创建注解处理器" class="headerlink" title="创建注解处理器"></a>创建注解处理器</h4><p>在注解处理器模块添加一个新类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.github.tedaliez.processor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.ProcessingEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewIntentProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Types typeUtils;</span><br><span class="line">    <span class="keyword">private</span> Elements elementUtils;</span><br><span class="line">    <span class="keyword">private</span> Filer filer;</span><br><span class="line">    <span class="keyword">private</span> Messager messager;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line">        typeUtils = processingEnv.getTypeUtils();</span><br><span class="line">        elementUtils = processingEnv.getElementUtils();</span><br><span class="line">        filer = processingEnv.getFiler();</span><br><span class="line">        messager = processingEnv.getMessager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">getSupportedAnnotationTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getSupportedAnnotationTypes();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SourceVersion <span class="title">getSupportedSourceVersion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getSupportedSourceVersion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="init"><a href="#init" class="headerlink" title="init()"></a>init()</h5><p>初始化的回调。在这个方法中我们创建了四个类型的引用:</p>
<ol>
<li>Elements:Element(下文介绍)的工具类</li>
<li>Types:TypeMirror(下文介绍)的工具类</li>
<li>Filer:用来创建文件</li>
<li>Messager:用来当注解处理器出现编译错误时打印错误信息<h5 id="Element"><a href="#Element" class="headerlink" title="Element"></a>Element</h5>注解处理过程中我们会扫描我们的java源代码。每个代码都有一个确定的Element类型，换句话说，Elment代表了一个程序的语言层级的元素</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;	<span class="comment">// PackageElement</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;		<span class="comment">// TypeElement</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> a;		<span class="comment">// VariableElement</span></span><br><span class="line">	<span class="keyword">private</span> Foo other; 	<span class="comment">// VariableElement</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Foo</span> <span class="params">()</span> </span>&#123;&#125; 	<span class="comment">// ExecuteableElement</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span> <span class="params">( 	// ExecuteableElement</span></span></span><br><span class="line"><span class="function"><span class="params">	                 <span class="keyword">int</span> newA	// TypeElement</span></span></span><br><span class="line"><span class="function"><span class="params">	                 )</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是你不能从Element中获取类的相关信息，例如类的父类关系。这类信息得从TypeMirror中获得</p>
<h5 id="Messager"><a href="#Messager" class="headerlink" title="Messager"></a>Messager</h5><p>用来当注解处理器出现编译错误时打印错误信息，需要注意的是当有异常出现时，你的注解处理器也应该正常结束而非选择抛出异常。如果抛出异常结束，那么javac会打印你的堆栈，但你messager的信息则不会被打印出来</p>
<h5 id="process"><a href="#process" class="headerlink" title="process()"></a>process()</h5><p>注解处理器中最重要的方法，方法提供了所有被注解的元素。在这个函数中你可以来处理你的注解，我们在这里实现生成代码的逻辑</p>
<h5 id="getSupportedAnnotationTypes"><a href="#getSupportedAnnotationTypes" class="headerlink" title="getSupportedAnnotationTypes()"></a>getSupportedAnnotationTypes()</h5><p>返回注解处理器支持的注解类型，你可以认为这个方法的返回值是<code>process</code>方法的第一个参数值。这个方法也可以使用<code>@SupportedAnnotationTypes</code>注解来替代，二者等效</p>
<h5 id="getSupportedSourceVersion"><a href="#getSupportedSourceVersion" class="headerlink" title="getSupportedSourceVersion()"></a>getSupportedSourceVersion()</h5><p>指明支持代码生成的java版本。这个方法也可以使用<code>@SupportedSourceVersion</code>注解来替代，二者等效</p>
<h4 id="注解处理器方法实现"><a href="#注解处理器方法实现" class="headerlink" title="注解处理器方法实现"></a>注解处理器方法实现</h4><p>推荐使用JavaPoet来完成新的class文件的生成</p>
<h4 id="向javac声明这个注解处理器"><a href="#向javac声明这个注解处理器" class="headerlink" title="向javac声明这个注解处理器"></a>向javac声明这个注解处理器</h4><p>在处理器模块代码根目录下(一般是src/main)，创建resources/META-INF/services/javax.annotation.processing.Processor文件，在这个文件中声明你的注解器类路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.github.tedaliez.processor.NewIntentProcessor</span><br></pre></td></tr></table></figure></p>
<p>换行可以声明下一个注解器的路径，这里我们只有一个。</p>
<h3 id="编译，体验成果"><a href="#编译，体验成果" class="headerlink" title="编译，体验成果"></a>编译，体验成果</h3><p>具体的代码可以参考<a href="https://github.com/TedaLIEz/AptExample" target="_blank" rel="noopener">https://github.com/TedaLIEz/AptExample</a></p>
<h2 id="注解处理器不能做-不建议-的事情"><a href="#注解处理器不能做-不建议-的事情" class="headerlink" title="注解处理器不能做(不建议)的事情"></a>注解处理器不能做(不建议)的事情</h2><ol>
<li>修改已有的类文件。注解处理器的初衷是希望用注解来生成一些新的类文件，修改已有的类文件可能会有办法，但属于特殊技巧</li>
<li>受1的限制，注解处理器并不能很好地实现面向切面编程，因为我们很难侵入到一个方法执行过程中加入一段我们的代码。</li>
</ol>
<h2 id="注解处理器的特性"><a href="#注解处理器的特性" class="headerlink" title="注解处理器的特性"></a>注解处理器的特性</h2><p>注解处理器有下面几个特性:</p>
<ol>
<li>提供编译期的错误检查(fail-fast).更容易暴露错误和调试，个人认为这是注解处理器解决问题的最大优势</li>
<li>提供了类似C++的模版能力，比C++的模版有着更好的错误信息</li>
<li>避开了运行期使用反射获取注解带来的性能问题</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://tedaliez.github.io/2019/06/29/APT%E6%8F%92%E4%BB%B6%E5%AE%9E%E6%88%98/" data-id="ckgx4rr6l0000i8x7pyiqej01" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-ROOM/" rel="tag">Android, ROOM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NDK/" rel="tag">NDK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/" rel="tag">TypeScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebAssembly/" rel="tag">WebAssembly</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WebView-JSBridge/" rel="tag">WebView, JSBridge</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-jetpack-compose/" rel="tag">android, jetpack compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-mmkv/" rel="tag">android, mmkv</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/android-textview/" rel="tag">android, textview</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin/" rel="tag">kotlin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-coroutine/" rel="tag">kotlin, coroutine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kotlin-%E5%8D%8F%E7%A8%8B/" rel="tag">kotlin, 协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/v8-WebAssembly/" rel="tag">v8, WebAssembly</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android-ROOM/" style="font-size: 10px;">Android, ROOM</a> <a href="/tags/NDK/" style="font-size: 10px;">NDK</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/WebAssembly/" style="font-size: 15px;">WebAssembly</a> <a href="/tags/WebView-JSBridge/" style="font-size: 10px;">WebView, JSBridge</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/android-jetpack-compose/" style="font-size: 10px;">android, jetpack compose</a> <a href="/tags/android-mmkv/" style="font-size: 20px;">android, mmkv</a> <a href="/tags/android-textview/" style="font-size: 10px;">android, textview</a> <a href="/tags/kotlin/" style="font-size: 10px;">kotlin</a> <a href="/tags/kotlin-coroutine/" style="font-size: 10px;">kotlin, coroutine</a> <a href="/tags/kotlin-%E5%8D%8F%E7%A8%8B/" style="font-size: 10px;">kotlin, 协程</a> <a href="/tags/v8-WebAssembly/" style="font-size: 10px;">v8, WebAssembly</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/09/13/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E9%9F%B3%E8%A7%86%E9%A2%91%E5%90%8C%E6%AD%A5/">FFMpeg-Android开发-简单音视频同步</a>
          </li>
        
          <li>
            <a href="/2020/09/12/Kotlin%E5%8D%8F%E7%A8%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">Kotlin协程异常处理</a>
          </li>
        
          <li>
            <a href="/2020/08/29/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E6%92%AD%E6%94%BE%E9%9F%B3%E9%A2%91/">FFMpeg-Android开发-简单播放音频</a>
          </li>
        
          <li>
            <a href="/2020/08/23/FFMpeg-Android%E5%BC%80%E5%8F%91-%E7%AE%80%E5%8D%95%E6%92%AD%E6%94%BE%E8%A7%86%E9%A2%91/">FFMpeg-Android开发-简单播放视频</a>
          </li>
        
          <li>
            <a href="/2020/08/22/FFMpeg-Android%E5%BC%80%E5%8F%91-%E8%A7%A3%E6%9E%90%E8%A7%86%E9%A2%91%E6%A0%BC%E5%BC%8F/">FFMpeg-Android开发-解析视频格式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Jian Guo<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>